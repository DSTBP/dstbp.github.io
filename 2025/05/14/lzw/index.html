<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>[信息编码] LZW 压缩算法 - DSTBP Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="DSTBP Blog"><meta name="msapplication-TileImage" content="/images/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="DSTBP Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 引言最近发现一个在线塔防策略游戏网站：https:&amp;#x2F;&amp;#x2F;yorg.io&amp;#x2F;，基本玩法是昼夜交替的生存挑战，如图 1.1 所示，玩家需白天建立资源供应链，包括采矿（水晶、铁矿、铀矿等）、运输（通过运输机连接建筑）和工厂生产（如炮弹、弓箭、护盾等），为夜晚防御做准备，晚上僵尸从地图边界进攻，玩家需通过防御塔（箭塔、加农炮、闪电塔等）和城墙抵御攻击。每 10 天会刷新强力 BOSS。"><meta property="og:type" content="article"><meta property="og:title" content="[信息编码] LZW 压缩算法"><meta property="og:url" content="http://dstbp.com/2025/05/14/lzw/"><meta property="og:site_name" content="DSTBP Blog"><meta property="og:description" content="1. 引言最近发现一个在线塔防策略游戏网站：https:&amp;#x2F;&amp;#x2F;yorg.io&amp;#x2F;，基本玩法是昼夜交替的生存挑战，如图 1.1 所示，玩家需白天建立资源供应链，包括采矿（水晶、铁矿、铀矿等）、运输（通过运输机连接建筑）和工厂生产（如炮弹、弓箭、护盾等），为夜晚防御做准备，晚上僵尸从地图边界进攻，玩家需通过防御塔（箭塔、加农炮、闪电塔等）和城墙抵御攻击。每 10 天会刷新强力 BOSS。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://dstbp.com/data/imgs/posts/lzw/Thumbnail.png"><meta property="article:published_time" content="2025-05-14T07:10:43.000Z"><meta property="article:modified_time" content="2025-06-24T02:33:01.999Z"><meta property="article:author" content="DSTBP"><meta property="article:tag" content="密码学"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://dstbp.com/data/imgs/posts/lzw/Thumbnail.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://dstbp.com/2025/05/14/lzw/"},"headline":"[信息编码] LZW 压缩算法","image":["https://dstbp.com/data/imgs/posts/lzw/Thumbnail.png"],"datePublished":"2025-05-14T07:10:43.000Z","dateModified":"2025-06-24T02:33:01.999Z","author":{"@type":"Person","name":"DSTBP"},"publisher":{"@type":"Organization","name":"DSTBP Blog","logo":{"@type":"ImageObject","url":{"light":"/images/logo.jpg","dark":"/images/logo-dark.jpg"}}},"description":"1. 引言最近发现一个在线塔防策略游戏网站：https:&#x2F;&#x2F;yorg.io&#x2F;，基本玩法是昼夜交替的生存挑战，如图 1.1 所示，玩家需白天建立资源供应链，包括采矿（水晶、铁矿、铀矿等）、运输（通过运输机连接建筑）和工厂生产（如炮弹、弓箭、护盾等），为夜晚防御做准备，晚上僵尸从地图边界进攻，玩家需通过防御塔（箭塔、加农炮、闪电塔等）和城墙抵御攻击。每 10 天会刷新强力 BOSS。"}</script><link rel="canonical" href="http://dstbp.com/2025/05/14/lzw/"><link rel="alternate" href="/atom.xml" title="DSTBP Blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.svg"><link rel="stylesheet" href="/css/font/fontawesome/css/all.min.css"><link data-pjax rel="stylesheet" href="/js/imaegoo/highlight.js/11.7.0/styles/atom-one-light.css"><link data-pjax rel="stylesheet" href="/css/default.css"><!--!--><!--!--><script src="https://vercount.one/js" defer></script><link rel="stylesheet" href="/js/imaegoo/lightgallery/1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="/js/imaegoo/justifiedGallery/3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-K9WLQN9BFY" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-K9WLQN9BFY');</script><!--!--><!--!--><link rel="stylesheet" href="/js/imaegoo/cookieconsent/3.1.1/build/cookieconsent.min.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="/images/logo.jpg" alt="DSTBP Blog" height="28"><img class="logo-img-dark" src="/images/logo-dark.jpg" alt="DSTBP Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives/">时间轴</a><a class="navbar-item" href="/categories/">分类</a><a class="navbar-item" href="/tags/">标签</a><a class="navbar-item" href="/messages/">留言板</a><a class="navbar-item" href="/friends/">友链</a><a class="navbar-item" href="/about/">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i><span>  目录</span></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><i class="fas fa-thumbtack level-item" title="Pinned"></i><span class="level-item"><time dateTime="2025-05-14T07:10:43.000Z" title="2025/5/14 15:10:43">2025-05-14</time>发表</span><span class="level-item"><time dateTime="2025-06-24T02:33:01.999Z" title="2025/6/24 10:33:01">2025-06-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a><span> / </span><a class="link-muted" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/%E4%BF%A1%E6%81%AF%E7%BC%96%E7%A0%81/">信息编码</a></span><span class="level-item">4 小时读完 (大约32597个字)</span><span class="level-item leancloud_visitors" id="/2025/05/14/lzw/" data-flag-title="[信息编码] LZW 压缩算法"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="twikoo_visitors"><i class="fa fa-spinner fa-spin"></i></span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">[信息编码] LZW 压缩算法</h1><div class="content"><h1 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h1><p>最近发现一个在线塔防策略游戏网站：<a target="_blank" rel="noopener" href="https://yorg.io/">https://yorg.io/</a>，基本玩法是<strong>昼夜交替的生存挑战</strong>，如图 1.1 所示，玩家需白天建立资源供应链，包括采矿（水晶、铁矿、铀矿等）、运输（通过运输机连接建筑）和工厂生产（如炮弹、弓箭、护盾等），为夜晚防御做准备，晚上僵尸从地图边界进攻，玩家需通过防御塔（箭塔、加农炮、闪电塔等）和城墙抵御攻击。每 10 天会刷新强力 BOSS。</p>
<span id="more"></span>

<center><img src="https://dstbp.com/data/imgs/posts/lzw/yorg%20游戏界面.png" width="800"></center>

<center><span style="font-family:楷体;font-size:14px;">图 1.1 yorg 游戏界面</span></center>

<p>游玩时发现可以本地存档，下次游玩时加载存档文件继续上次进度。作为一名网安狗，当即就想到修改存档改变数值，达到无限水晶和技能点的效果。</p>
<p>通过打开开发者工具并跟踪保存存档的过程，我们可以定位到具体的保存函数。这里不展开具体的跟踪步骤，基本思路是：以存档文件名为关键词进行搜索，找到触发保存的函数，再向下追踪调用栈，分析可知网页逻辑是先将存档数据保存到 localStorage 中，通过索引 <code>savegame_blob_xxxx</code> 查找对应的存档数据，再执行保存文件的操作。搜索关键词 <code>savegame_blob_</code> 找到处理函数，逻辑流程如下：<code>this.root.savegames.saveGame()</code> → <code>updateLastSavegame()</code> → <code>dataToString(t)</code> →<code>compressToEncodedURIComponent(t)</code> → <code>_compress(t)</code>。</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/compress%20函数调试.png" width="1000"></center>

<center><span style="font-family:楷体;font-size:14px;">图 1.2 _compress 函数调试</span></center>

<p>如图 1.2 所示，分析<code>_compress()</code> 可知这是一个 LZW 压缩算法，那么什么是 LZW 压缩算法呢？</p>
<h1 id="2-原理"><a href="#2-原理" class="headerlink" title="2. 原理"></a>2. 原理</h1><p>LZW 其实是三个大佬的名字，这个算法最开始是 Ziv 和 Lempel 这两个人于 1977，1978 年发明，在 1984 年的时候由 Terry Welch 进行了改进，由此得名 LZW 编码（Lempel-Ziv-Welch Encoding），属于 LZ78 编码的变种。简单来说，LZW 算法就是通过建立一个字符串表，将多次出现的字符串存到表中并编号，用较短的编号表示较长的字符串来实现压缩。也被称为串表压缩算法。</p>
<h2 id="2-1-示例"><a href="#2-1-示例" class="headerlink" title="2.1 示例"></a>2.1 示例</h2><h3 id="2-1-1-编号的映射"><a href="#2-1-1-编号的映射" class="headerlink" title="2.1.1 编号的映射"></a>2.1.1 编号的映射</h3><p>假设我们要通过互联网传输一本英文牛津字典。按照常规方式，一个字符占 1 字节，这本字典大约包含 60 万个单词（包括重复的），每个单词平均 5 个字母，总共约 300 万个字符，也就是 300 万字节的数据量。</p>
<p>但如果我们换种思路：先提取出不重复的单词，假设有 20 万个唯一单词。我们给每个单词编上一个编号，比如从 1 开始。只需 3 个字节（24 位）就能唯一表示一个编号（$ 2^{24} \gt 200000 $）。这样，每个单词只需用 3 个字节的编号代替原始文本。对于总共 60 万个单词，传输只需 60 万 × 3 &#x3D; 180 万字节。相比原来的 300 万字节，这种方法节省了超过三分之一的数据量。</p>
<p>LZW 编码也是同理，把出现过的字符串映射到编号上，实现压缩。例如对于字符串：<code>ABABAB</code>，可以看到子串 AB 多次重复， 我们可以用一个特殊的符号（比如数字 2）来表示 AB ，那么原来的字符串就可以表示为：<code>AB22</code>。在这个例子中，数字 2 被称为子串 AB 的<strong>符号</strong>（Symbol）。那 A 和 B 本身有没有符号？当然有。我们可以规定 0 表示 A，1 表示 B。于是最终压缩后的数据是一个<strong>符号流</strong>（Symbol Stream）：<code>0122</code>。</p>
<p>当然在真实的 LZW 编码中，A 和 B 不会用 0 和 1 表示，而是直接用它们的 ASCII 值。LZW 的初始字典包含所有 256 个 ASCII 字符，这些字符的符号就是它们各自的 ASCII 值。从 256 开始，编码过程中会动态添加新的字符串映射，这部分称为<strong>扩展字典</strong>（Extended Dictionary）。上面案例中在 LZW 编码会转成：<code>65 (A) 66 (B) 257 (AB)</code>。</p>
<h3 id="2-1-2-字典的自解释"><a href="#2-1-2-字典的自解释" class="headerlink" title="2.1.2 字典的自解释"></a>2.1.2 字典的自解释</h3><p>有同学可能会问：为什么第一个 AB 不也用 2 表示？这样不又节省了一个符号？这个问题正好引出了 LZW 的一个核心思想：压缩后的数据是<strong>自解释的（self-explaining）</strong>。 在 LZW 编码中，压缩数据本身不包含完整的字典。也就是说，压缩文件里并不会存放“2 → AB”这种映射关系。LZW 编码、解码中除了初始字典（0 → A 和 1 → B），不会带有任何关于扩展字典的映射。</p>
<p>回到上面的示例。其编码过程（概念简化版）如下：</p>
<ul>
<li>读到 A → 查初始字典：A 的符号是 0，输出 0</li>
<li>读到 B → 查初始字典：B 的符号是 1，输出 1</li>
<li>发现 AB 是一个新组合 → 添加到字典中，记符号 2 → AB</li>
<li>再读到 AB → 字典中已有，输出符号 2</li>
<li>再读到 AB → 再次输出符号 2</li>
</ul>
<p>那解码器是怎么知道符号 2 代表 AB 的？答案是：<strong>它在解码的过程中自己“推出来”的</strong>。LZW 的解压过程和编码一样，从初始字典出发，一边根据已经解出的内容动态构建字典一边解码。</p>
<p>当我们解码 <code>0122</code> 时，解码器的过程（概念简化版）是：</p>
<ul>
<li>0 → 查初始字典：0 对应 A，输出 A</li>
<li>1 → 查初始字典，1 对应 B，输出 B</li>
<li>遇到 2，初始字典中没有，根据前两个输出是 A 和 B → 创建新映射：2 → AB</li>
<li>2 → AB，输出 AB</li>
<li>2 → AB，输出 AB</li>
</ul>
<p>现在就解释为什么前面不能直接用 2。因为在前两个字符 A 和 B 被编码输出之前，AB 组合还不存在于字典中。一开始就用 2 表示 AB，解码器看到“2”时会不知道它指的是什么，它还没从前文推导出 2 → AB 的关系。所以前面的 0 和 1 不只是输出结果，<strong>它们本身就是构建后续字典的“依据”</strong>，是字典构建的“第一现场”。这就是“自解释”：压缩后的数据本身就包含了解压所需的全部信息，压缩时使用的字典不需要另外传输或存储。</p>
<h2 id="2-2-算法详解"><a href="#2-2-算法详解" class="headerlink" title="2.2 算法详解"></a>2.2 算法详解</h2><p>下面我们通过一个稍微复杂的例子，完整展示 LZW 编码与解码的全过程，重点是理解：在解码时，每一步是如何对应编码过程中的操作，以及如何一步步还原原始字符串并重建编码时使用的字典。</p>
<h3 id="2-2-1-编码算法"><a href="#2-2-1-编码算法" class="headerlink" title="2.2.1 编码算法"></a>2.2.1 编码算法</h3><p>编码器在处理原始字符串时，会不断读取新字符，并尝试将已有的字符串或组合进行编码。为了实现这一过程，我们维护两个变量：</p>
<ul>
<li><strong>P（Previous）</strong>：当前已读取、尚未编码的字符串片段。</li>
<li><strong>C（Current）</strong>：刚读入的新字符。</li>
</ul>
<p>编码器的工作是将 P+C 这个组合查找字典，如果存在，就继续向后读取字符并扩展；如果不存在，就将 P 对应的符号输出，并将 P+C 加入字典。具体编码流程如下：</p>
<ol>
<li><p>初始化：字典中只包含所有单字符的默认项，例如 0 → a，1 → b，2 → c 等。此时变量 P 和 C 均为空。</p>
</li>
<li><p>读取字符：读入一个新字符赋值给 C，然后将 P 和 C 合并为字符串 P+C。</p>
</li>
<li><p>字典查找：检查 P+C 是否在字典中：</p>
<ul>
<li>如果存在，则将 P 更新为 P+C。</li>
<li>如果不存在，输出 P 对应的符号，在字典中建立 P+C 映射，并将 P 更新为 C。</li>
</ul>
</li>
<li><p>重复处理：返回第 2 步，继续处理下一个字符，直到整个输入字符串处理完毕。</p>
</li>
<li><p>到达字符串尾部，没有新的 C 读入时，则将 P 对应的符号输出，结束。</p>
</li>
</ol>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/LZW 编码流程图.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.1 LZW 编码流程图</span></center>

<p>LZW 编码的关键就在第 3 步 —— 理解变量 P 是什么。P 是当前维护的、可以被编码为符号的子串，但<strong>还没有输出</strong>。随着每读入一个新字符 C，我们尝试把它加到 P 的末尾，形成新的组合 P+C。只要这个组合还能在字典中找到，我们就不断更新 P &#x3D; P+C，也就是说，我们在试图找到尽可能长的子串将其编码为一个符号，这就是压缩的实现。一旦 P+C 不在字典里了，就意味着当前这段子串没办法再长了。此时我们：</p>
<ol>
<li>输出当前 P 的编码符号。</li>
<li>把 P+C 加入字典，作为一个新的子串项。</li>
<li>把 P 重新设为 C，重新开始构建新的子串。</li>
</ol>
<p>通过这种方式，我们就能把较长、重复的子串用一个符号表示，从而达到压缩的效果。至于为什么输出的是 P，是因为 P+C 还没被收录进字典，还没有符号可以输出。只能把已有的 P 输出，再把 P+C 加进去，以备后面用到。</p>
<p>举个例子，对于一个字符串：<code>ababnababan</code>，初始状态字典里有三个默认的映射，如表 2.1 所示：</p>
<table>
<thead>
<tr>
<th align="left">Symbol</th>
<th>String</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td>a</td>
</tr>
<tr>
<td align="left">1</td>
<td>b</td>
</tr>
<tr>
<td align="left">2</td>
<td>n</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.1 编码初始字典</span></center>

<p>开始编码，编码步骤如表 2.2 所示：</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>P</th>
<th>C</th>
<th>P+C</th>
<th>P+C in Dict ？</th>
<th>Action</th>
<th>Output</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>-</td>
<td>a</td>
<td>a</td>
<td>Yes</td>
<td>更新 P&#x3D;a</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>a</td>
<td>b</td>
<td>ab</td>
<td>No</td>
<td>添加 3 → ab，更新 P&#x3D;b</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>b</td>
<td>a</td>
<td>ba</td>
<td>No</td>
<td>添加 4 → ba，更新 P&#x3D;a</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>a</td>
<td>b</td>
<td>ab</td>
<td>Yes</td>
<td>更新 P&#x3D;ab</td>
<td>-</td>
</tr>
<tr>
<td>5</td>
<td>ab</td>
<td>n</td>
<td>abn</td>
<td>No</td>
<td>添加 5 → abn，更新 P&#x3D;n</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>n</td>
<td>a</td>
<td>na</td>
<td>No</td>
<td>添加 6 → na，更新 P&#x3D;a</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>a</td>
<td>b</td>
<td>ab</td>
<td>Yes</td>
<td>更新 P&#x3D;ab</td>
<td>-</td>
</tr>
<tr>
<td>8</td>
<td>ab</td>
<td>a</td>
<td>aba</td>
<td>No</td>
<td>添加 7 → aba，更新 P&#x3D;a</td>
<td>3</td>
</tr>
<tr>
<td>9</td>
<td>a</td>
<td>b</td>
<td>ab</td>
<td>Yes</td>
<td>更新 P&#x3D;ab</td>
<td>-</td>
</tr>
<tr>
<td>10</td>
<td>ab</td>
<td>a</td>
<td>aba</td>
<td>Yes</td>
<td>更新 P&#x3D;aba</td>
<td>-</td>
</tr>
<tr>
<td>11</td>
<td>aba</td>
<td>n</td>
<td>aban</td>
<td>No</td>
<td>添加 8 → aban，更新 P&#x3D;n</td>
<td>7</td>
</tr>
<tr>
<td>12</td>
<td>n</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>2</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.2 编码过程步骤跟踪表</span></center>

<p>输出的结果为 <code>0132372</code>，完整的字典如表 2.3 所示：</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>String</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>a</td>
</tr>
<tr>
<td>1</td>
<td>b</td>
</tr>
<tr>
<td>2</td>
<td>n</td>
</tr>
<tr>
<td>3</td>
<td>ab</td>
</tr>
<tr>
<td>4</td>
<td>ba</td>
</tr>
<tr>
<td>5</td>
<td>abn</td>
</tr>
<tr>
<td>6</td>
<td>na</td>
</tr>
<tr>
<td>7</td>
<td>aba</td>
</tr>
<tr>
<td>8</td>
<td>aban</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.3 映射字典</span></center>

<p>图 2.2 展示原字符串是如何对应到压缩后的编码，图 2.3 展示 LZW 编码如何保存映射到字典中。</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/原字符串对应压缩后编码.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.2 原字符串对应压缩后编码</span></center>

<center><img src="https://dstbp.com/data/imgs/posts/lzw/字符串字典映射.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.3 字符串字典映射</span></center>

<h3 id="2-2-2-解码算法"><a href="#2-2-2-解码算法" class="headerlink" title="2.2.2 解码算法"></a>2.2.2 解码算法</h3><p>读到这里，可能大家有一个疑惑，为什么要这么设计字典映射与编码？这其实都是为解码做准备，解码的过程比编码复杂，其核心思想在于解码需要还原出编码时的用的字典，即如何对应编码的过程。</p>
<p>在 LZW 解码中，输入是压缩后的符号流（Symbol Stream）。和编码类似，解码过程也维护两个变量：</p>
<ul>
<li><strong>pW（previous word）</strong>：前一个解码出来的<strong>符号</strong>。</li>
<li><strong>cW（current word）</strong>：当前新读取的<strong>符号</strong>。</li>
</ul>
<p>这里的“W”可以理解为一个符号。每个符号代表一个已知的字符串片段。用 Str(cW) 和 Str(pW) 表示它们解码出来的原字符串。</p>
<ol>
<li>初始化：字典中只包含默认的初始字典，例如 0 → a，1 → b，2 → c 等。此时变量 pW 和 cW 都为空。</li>
<li>读取第一个字符：第一个符号一定能直接在字典中找到，它代表一个单个字符。解码后输出该字符。</li>
<li>将 pW 设为 cW。</li>
<li>读取下一个符号 cW。</li>
<li>判断 cW 是否存在于字典中：<ol>
<li>如果存在：<ol>
<li>解码并输出 Str(cW)。</li>
<li>令 P &#x3D; Str(pW)，C &#x3D; <strong>Str(cW) 的第一个字符</strong>。</li>
<li>将新组合 P + C 加入字典，分配一个新的符号。</li>
</ol>
</li>
<li>如果不存在：<ol>
<li>令 P &#x3D; Str(pW)，C &#x3D; <strong>Str(pW) 的第一个字符</strong>。</li>
<li>创建新项 P + C，当前 cW 所映射的正是这个新字符串，加入字典。</li>
<li>输出 P + C。</li>
</ol>
</li>
</ol>
</li>
<li>回到第 3 步，继续处理下一个符号，直到读完整个符号流。</li>
</ol>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/LZW 解码流程图.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.4 LZW 解码流程图</span></center>

<p>显然，第 5 步是解码过程的关键，也是最难理解的一步。在这一阶段，解码器不仅在解析符号，更重要的是它一边解码，一边模拟编码时的字典构建过程。下面详细阐述 <code>0132372</code> 解码成 <code>ababnababan</code> 的流程：</p>
<p>与编码一样，解码时初始状态字典里只有三个默认的映射，如表 2.4 所示：</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>String</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>a</td>
</tr>
<tr>
<td>1</td>
<td>b</td>
</tr>
<tr>
<td>2</td>
<td>n</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.4 解码初始字典</span></center>

<p>开始解码，解码步骤如表 2.5 所示：</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>pW</th>
<th>cW</th>
<th>cW in Dict ？</th>
<th>Action</th>
<th>Output</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>-</td>
<td>0</td>
<td>Yes</td>
<td>C&#x3D;a，pW&#x3D;0</td>
<td>a</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
<td>1</td>
<td>Yes</td>
<td>P&#x3D;a，C&#x3D;b，P+C&#x3D;ab，添加 3 → ab</td>
<td>b</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>3</td>
<td>Yes</td>
<td>P&#x3D;b，C&#x3D;a，P+C&#x3D;ba，添加 4 → ba</td>
<td>ab</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>2</td>
<td>Yes</td>
<td>P&#x3D;ab，C&#x3D;n，P+C&#x3D;abn，添加 5 → abn</td>
<td>n</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>3</td>
<td>Yes</td>
<td>P&#x3D;n，C&#x3D;a，P+C&#x3D;na，添加 6 → an</td>
<td>ab</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
<td>7</td>
<td>No</td>
<td>P&#x3D;ab，C&#x3D;a，P+C&#x3D;aba，添加 7 → aba</td>
<td>aba</td>
</tr>
<tr>
<td>7</td>
<td>7</td>
<td>2</td>
<td>Yes</td>
<td>P&#x3D;aba，C&#x3D;n，P+C&#x3D;aban，添加 8 → aban</td>
<td>n</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.5 解码过程步骤跟踪表</span></center>

<p>仔细观察新映射是如何添加到字典中的，我们可以看到，解码器其实是在<strong>一步步“重演”编码器的操作</strong>，从而还原出编码过程。</p>
<p>如果新读入的 cW 能在字典里找到，那就能直接解码 cW，然后一边解码（输出 Str(cW)），一边构建新的映射（Str(pW) + Str(cW) 第一个字符）。</p>
<p>如果 cW 不在字典中，这时就需要解码器做出一个推理，我们来看 Step 6：</p>
<p>cW&#x3D;7，7 还没出现在字典里，但根据之前 cW 能在字典找到的情况，解码器可以推理出 7 映射的新字符串应该是当前的 Str(pW)，也就是 ab，以及未知的 Str(cW) 第一个字符拼接而成。而 cW 映射的就是这个即将新加入的字符串：<code>Str(pW) + Str(cW)[0]</code>，所以 cW 的第一个字符就是 Str(pW) 的第一个字符 a，所以 Str(cW) &#x3D; aba。</p>
<p>知道了怎么处理，现在思考为什么 cW 解码时，其还没有在字典里建立映射？因为<strong>字典中新条目总是比编码“晚一步”生成</strong>，如表 2.6 所示，编码器在输出某个符号时，已经读取了后面的字符，并基于它构建了下一条字典项。</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>已有字符串 P</th>
<th>读到的字符 C</th>
<th>Output</th>
<th>新增映射</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>a</td>
<td>b</td>
<td>0 (a → 0)</td>
<td>添加 3 → ab</td>
</tr>
<tr>
<td>2</td>
<td>b</td>
<td>a</td>
<td>1 (b → 1)</td>
<td>添加 4 → ba</td>
</tr>
<tr>
<td>3</td>
<td>ab</td>
<td>n</td>
<td>3 (ab → 3)</td>
<td>添加 5 → abn</td>
</tr>
<tr>
<td>4</td>
<td>n</td>
<td>a</td>
<td>2 (n → 2)</td>
<td>添加 6 → na</td>
</tr>
<tr>
<td>5</td>
<td>ab</td>
<td>a</td>
<td>3 (ab → 3)</td>
<td>添加 7 → aba</td>
</tr>
<tr>
<td>6</td>
<td>aba</td>
<td>n</td>
<td>7 (aba → 7)</td>
<td>添加 8 → aban</td>
</tr>
<tr>
<td>7</td>
<td>n</td>
<td>-</td>
<td>2 (n → 2)</td>
<td>-</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.6 编码过程构建字典与编码时序表（只列关键步骤）</span></center>

<p>而解码则不同，如表 2.7 所示，解码器先读符号再解码，根据解码的结果构建映射。</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>读到的字符</th>
<th>字典是否存在</th>
<th>Output</th>
<th>新增映射</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>0</td>
<td>Yes</td>
<td>a</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>Yes</td>
<td>b</td>
<td>添加 3 → ab</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>Yes</td>
<td>ab</td>
<td>添加 4 → ba</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>Yes</td>
<td>n</td>
<td>添加 5 → abn</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>Yes</td>
<td>ab</td>
<td>添加 6 → an</td>
</tr>
<tr>
<td>6</td>
<td>7</td>
<td>No</td>
<td>ab + a</td>
<td>添加 7 → aba</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>Yes</td>
<td>n</td>
<td>添加 8 → aban</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.7 解码过程构建字典与解码时序表（只列关键步骤）</span></center>

<p>所以编码器写入字典的映射，解码器总要等到下一轮才会写入。而当要新增的映射恰好在同一轮被引用时，就出现了先拿到符号但是还没建立这个映射的情况。这其实就是遇到了编码器<strong>刚刚创建但还没来得及传达其含义的字典项</strong>。这时就需要根据当前上下文，靠 <code>Str(pW) + Str(pW)[0]</code> 来还原原意。</p>
<h2 id="2-3-中文-LZW"><a href="#2-3-中文-LZW" class="headerlink" title="2.3 中文 LZW"></a>2.3 中文 LZW</h2><h3 id="2-3-1-挑战与研究现状"><a href="#2-3-1-挑战与研究现状" class="headerlink" title="2.3.1 挑战与研究现状"></a>2.3.1 挑战与研究现状</h3><p>以上的分析主要基于英文文本的压缩场景。那么在中文语境下，LZW 又该如何应用呢？首先我们得分析中文文本和西文文本的不同之处：</p>
<table>
<thead>
<tr>
<th align="left">比较维度</th>
<th align="left">西文文本</th>
<th align="left">中文文本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">字符集与编码</td>
<td align="left">字符集小，编码简单，单字符占字节少</td>
<td align="left">字符集大，编码复杂，单字符占字节多</td>
</tr>
<tr>
<td align="left">语言结构与语法规则</td>
<td align="left">词与词间用空格等分隔符分开，词边界清晰，语法规则固定</td>
<td align="left">需分词，语法灵活，分析难度大</td>
</tr>
<tr>
<td align="left">统计特性</td>
<td align="left">字符出现频率相对分散，不同字符使用频率有差异但不悬殊</td>
<td align="left">不同汉字使用频率差异极大，常用字频率高，生僻字频率低</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.8 中西文特点对比</span></center>

<p>对 LZW 算法的中文文本压缩的应用而言，最简单的做法是直接套用通用的 LZW 算法。但这方法缺点在于通用算法以字节为基本处理单位，压缩过程中会人为地割裂中文数据编码中蕴含的语义信息，导致压缩比偏低。对此，徐秉铮<sup>[1]</sup>、华强<sup>[2]</sup>等人从数据读取方式和基础码集结构出发，调整算法以适配汉字的编码和大字符集特性，压缩效果有所提升，但仍远低于 LZW 算法对英文文本的压缩比。陈庆辉<sup>[3]</sup>等人在现有基础算法上进行改进，提高了由于中文文本中重复字串不长导致压缩比远低于英文文本的压缩比例，压缩效果显著增强。</p>
<h3 id="2-3-2-详细算法"><a href="#2-3-2-详细算法" class="headerlink" title="2.3.2 详细算法"></a>2.3.2 详细算法</h3><p>本文采用陈庆辉等人的中文文本压缩算法，其算法基于最大字典编码长度为 19 位的 LZW 传统算法，将 GB2312-80 标准字符中的一级汉字和第 1、3 区的常用字符存入初始字典。并针对中文文本重复字串不长的特点，对字典码值进行<strong>双模式变长编码</strong>输出，具体编码输出方法如下：</p>
<p>按码值的最小二进制表示位数对字典进行分段，则字典可分为 19 段。其中码值 $ 2^{n-1}-1 \sim 2^n-1  $ 为字典的第 $ n $ 段。记当前字典中码值的最大长度为 $ n $，其中 $ 11 \lt n \lt 20 $。</p>
<ul>
<li>当 $ n \lt 14 $ 时，码值采用该码值大小的二进制编码输出，输出长度为 $ n $ 位。</li>
<li>当 $ n &#x3D; 14 $ 时，开始启用“双模式编码”：<ul>
<li>字典中 1 - 12 段的码值：用 13 位表示，首位是 0，后 12 位是实际的码值二进制。</li>
<li>字典中第 13 和 14 段的码值：用 15 位表示，首位是 1，后 14 位为码值。</li>
</ul>
</li>
<li>当 $ n \lt 18 $ 时，前 n-3 段的码值用 n-2 位表示，首位是 0。最后 3 段的码值用 n+1 位表示，首位是 1。</li>
<li>当 $ n \lt 20 $ 时，前 n-4 段的码值用 n-3 位表示，首位是 0。最后 4 段的码值用 n+1 位表示，首位是 1。</li>
</ul>
<p>这么做的意义在于，大部分数据（常用词）用小编号的码值，而这些码值属于字典的前段。用更短的二进制位表示这些高频码值，就可以整体减少压缩文件的大小。而较大的码值本身出现得少（不常用字符串），即使编码更长，对整体影响也很小。</p>
<h2 id="2-4-改进方案"><a href="#2-4-改进方案" class="headerlink" title="2.4 改进方案"></a>2.4 改进方案</h2><p>LZW 算法的解压过程无需在压缩后的数据中添加任何辅助信息就能够自动还原字典，从而保证较快的编解码速度。不过它也不是完美的。其性能容易受到一些因素影响，下面将分析相关影响因素并提出改进方案<sup>[4-5]</sup>。需要注意的是，不同的应用场景对压缩效率、速度和资源占用的要求不同，因此改进方法并没有统一的标准，必须根据具体需求选择最合适的方案。</p>
<h3 id="2-4-1-编码方式"><a href="#2-4-1-编码方式" class="headerlink" title="2.4.1 编码方式"></a>2.4.1 编码方式</h3><p>LZW 算法通过构建一个字典，用索引替代重复的字符串，在编码方面：</p>
<ul>
<li>如果用<strong>定长编码</strong>（Fixed-Length Coding），初始时就要预留足够多的位数来表示所有可能的索引值，此时高位数的编码会浪费大量内存空间，在设备的内存受限情况下，可能导致性能下降甚至系统崩溃。</li>
<li>而用<strong>变长编码</strong>（Variable-Length Coding），在压缩初期能用短位匹配大量重复短字符串，后期用长位处理复杂长字符串组合。且当字典容量扩展时，索引所需的二进制位数同步增加。能更灵活地适配实际情况。</li>
</ul>
<p>举个例子压缩 <code>ABABABAB</code> 字符串时，固定长度编码和变长编码差异显著。固定长度编码一开始就用 3 位编码，能表示 8 个索引，但实际初期仅用 4 个，高位闲置，内存浪费；而变长编码初期用 2 位编码，在字典满 4 个条目后，动态扩展为 3 位编码，前期节省编码长度，后期也能处理复杂情况，避免了固定编码的内存浪费。</p>
<p>所以，在内存受限的环境中，更推荐使用<strong>变长编码</strong>，动态调整每个索引所占的位数，既保证压缩效果，又节省内存和存储空间。</p>
<h3 id="2-4-2-字典大小"><a href="#2-4-2-字典大小" class="headerlink" title="2.4.2 字典大小"></a>2.4.2 字典大小</h3><p>LZW 算法中，字典大小的选择会直接影响压缩效果和处理速度：</p>
<ul>
<li><strong>字典越大</strong>：能存更多字符串，匹配到的内容更长，压缩效果更好。但缺点是查找匹配的时间会变长，压缩过程更慢。</li>
<li><strong>字典越小</strong>：只能匹配较短的字符串，压缩效果变差，但处理速度快，适合对时效性要求高的场景。</li>
</ul>
<p>因此，字典大小的设置要根据应用场景权衡：</p>
<ul>
<li>如果用于实时传输（如网络通信），建议用较小的字典，提高压缩速度。</li>
<li>如果用于文件存储或归档，建议用较大的字典，提高压缩率，节省空间。</li>
</ul>
<p>需要注意的是：<strong>字典大小主要影响压缩过程</strong>。而在解压时，只需按编码值查表恢复原始字符串，不涉及复杂匹配，因此对字典大小不太敏感。</p>
<h3 id="2-4-3-搜索方式"><a href="#2-4-3-搜索方式" class="headerlink" title="2.4.3 搜索方式"></a>2.4.3 搜索方式</h3><p>LZW 算法的核心在于字典的构建和查找，其性能高度依赖于搜索效率。不同的搜索方式直接影响压缩和解压的速度与资源消耗。常见的三种搜索方式包括：串行搜索、并行搜索和哈希表搜索。</p>
<p><strong>串行搜索</strong></p>
<p>串行搜索是最基础的做法。每次查找新子串时，从字典头部开始一项一项地查找，直到找到匹配项或遍历完整个字典。这种简单，但在字典较大时效率很低，压缩速度慢。</p>
<p><strong>并行搜索</strong></p>
<p>将整个字典拆分为多个子字典，每个子字典可以独立、同时进行查找。这样可以并行处理多个搜索请求，提高速度。通常，第一个子字典为“虚拟字典”，只记录基本字符（如 0–255），不占内存。其余子字典按照不同的字宽（表示的子串长度）划分，可以分布在不同的硬件单元上并行查找，从而提升处理速度。其缺点是控制逻辑更复杂，每次输出不仅要包含子字典的索引，还要记录其在子字典中的位置，编码格式也更复杂。</p>
<p><strong>哈希表搜索</strong></p>
<p>哈希表搜索通过“前缀字符 + 新字符”组合成一个关键字，再用哈希函数直接计算出字典位置，实现快速定位。这种方法查找速度快，但有两个问题需要注意：</p>
<ul>
<li>哈希函数设计复杂：通常涉及乘法、取余等操作，对硬件不太友好。</li>
<li>哈希冲突不可避免：不同关键字可能映射到同一个地址。为此需要采用开放寻址或链表法等方式解决冲突，但都无法完全避免性能损失。</li>
</ul>
<table>
<thead>
<tr>
<th align="left">搜索方式</th>
<th align="left">优点</th>
<th align="left">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="left">串行搜索</td>
<td align="left">逻辑简单、易于实现</td>
<td align="left">搜索延时长、占用硬件资源较多</td>
</tr>
<tr>
<td align="left">并行搜索</td>
<td align="left">搜索速度快、存储单元利用率高</td>
<td align="left">控制逻辑复杂、编码复杂</td>
</tr>
<tr>
<td align="left">Hash 表搜索</td>
<td align="left">搜索延时短、实时性强</td>
<td align="left">占用硬件资源、存在哈希冲突（无法避免）</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.9 搜索方式对比</span></center>

<h3 id="2-4-4-存储结构"><a href="#2-4-4-存储结构" class="headerlink" title="2.4.4 存储结构"></a>2.4.4 存储结构</h3><p>传统的编码方法中，每次只能在已有字符串的基础上增加一个字符来扩展，这种方式效率低下，不仅浪费内存，还拖慢处理速度。可以用其他数据结构重构：</p>
<p><strong>Trie 树（前缀树）</strong></p>
<p>以节点数组的形式存储，从根节点出发的一条路径表示一个字符串。每个节点包含以下三个字段：</p>
<ul>
<li>父节点（parent）：表示该节点前缀所在节点的索引；</li>
<li>当前字符（code）：对应该节点的字符，一般是其 ASCII 值；</li>
<li>索引（index）：该节点在字典中的位置编号。</li>
</ul>
<p>当遇到一个未在字典中的字符时，只需将其作为新节点添加到 Trie 树中，并继续扩展构建新的分支。</p>
<p><strong>动态数组 + 哈希表</strong></p>
<p>将字典视为动态扩展的数组，每个条目存储完整字符串及其唯一编码，同时通过哈希表加速字符串查找。</p>
<p><strong>有限自动机（DFA）</strong></p>
<p>将字典转换为确定有限自动机，每个状态对应一个字符串，边表示字符输入后的转移路径，终止状态节点返回对应编码，新增状态生成新条目。</p>
<table>
<thead>
<tr>
<th>存储结构</th>
<th>使用场景</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>Trie 树</td>
<td>高频前缀重复的短字符串   内存充足场景</td>
<td>天然支持前缀匹配   无需处理哈希冲突   插入&#x2F;查询复杂度稳定</td>
<td>内存占用高   字符集大时空间爆炸（如Unicode）</td>
</tr>
<tr>
<td>动态数组+哈希表</td>
<td>通用文本压缩   中等规模数据</td>
<td>查找速度快   动态扩展灵活   实现简单</td>
<td>哈希冲突影响性能   内存占用较高（需存储完整字符串）</td>
</tr>
<tr>
<td>有限自动机（DFA）</td>
<td>高吞吐量实时压缩（如网络流）   固定模式字符串快速匹配</td>
<td>状态转移加速匹配   适合硬件加速</td>
<td>构建和维护复杂度高   内存占用极高</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.10 存储结构方式对比</span></center>

<h3 id="2-4-5-字典更新策略"><a href="#2-4-5-字典更新策略" class="headerlink" title="2.4.5 字典更新策略"></a>2.4.5 字典更新策略</h3><p>在 LZW 算法中，字典大小在压缩开始前就已经固定，不能根据文件内容动态调整。这意味着，一旦字典被填满，就无法再添加新的字符串，压缩效率也可能随之下降。为了改善这一问题，常见的做法是采用字典更新机制，在不增加字典大小的前提下继续优化压缩效果。以下是几种常见的更新策略：</p>
<p><strong>字典重置（Dictionary Reset, DR）</strong></p>
<p>当字典满了以后，直接清空除初始字典之外的所有条目，重新开始构建字典。DR 实现简单，重置迅速，但每次重置都会丢失所有已有匹配，导致压缩率瞬间降低，整体压缩效果可能变差。</p>
<p><strong>双字典（Double Dictionary, DD）</strong></p>
<p>为了避免重置带来的压缩效率骤降，DD 方法准备两个字典：</p>
<ul>
<li>一个正在使用的“满字典”，用于匹配。</li>
<li>一个已重置的“备用字典”，用于接收新字符串。</li>
</ul>
<p>当备用字典积累到一定程度后，替换旧字典继续使用，旧字典重置接受。这种方式压缩效率过渡平滑，不会突然降低。但需要双倍字典空间，而且新旧切换时可能丢弃高频出现的字符串。</p>
<p><strong>先进先出（FIFO）</strong></p>
<p>FIFO 方法认为最早加入字典的字符串可能与当前数据相关性较低。当字典满了后，按照“先加入先淘汰”的规则，从旧条目开始逐个替换新的字符串。逻辑简单，无需额外空间。但无法区分高频或低频条目，可能误删仍然有用的字符串，影响压缩效率。</p>
<p><strong>最近最少使用（LRU）</strong></p>
<p>LRU 方法更智能，它记录字典中每个字符串的使用频率，一旦字典满了，就移除使用最少的字符串，空出位置给新内容。其能保留最有用的高频字符串，压缩效果更好。但需要持续跟踪和更新每个条目的使用记录，计算复杂度高，运行开销大。</p>
<table>
<thead>
<tr>
<th>更新方式</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>DR</td>
<td>简单、快速</td>
<td>压缩比波动大</td>
</tr>
<tr>
<td>DD</td>
<td>平滑过渡</td>
<td>占用双倍内存</td>
</tr>
<tr>
<td>FIFO</td>
<td>实现容易</td>
<td>容易误删高频条目</td>
</tr>
<tr>
<td>LRU</td>
<td>压缩率高</td>
<td>实现复杂，速度慢</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.11 更新方式对比</span></center>

<h2 id="2-5-代码实现"><a href="#2-5-代码实现" class="headerlink" title="2.5 代码实现"></a>2.5 代码实现</h2><p>本文的 LZW 算法实现采用了变长编码、Trie 树结构、哈希表加速查找，并支持最大 19 位字典容量。支持中西文压缩，该算法分别用 Python、Java、JS、Go、C 和 Matlab 实现，并对各版本进行了性能对比测试，评估了其压缩效率和运行速度。</p>
<p>本文的开发环境如表 2.12 所示：</p>
<table>
<thead>
<tr>
<th>语言</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Python</td>
<td>3.10.2</td>
</tr>
<tr>
<td>GCC</td>
<td>8.1.0</td>
</tr>
<tr>
<td>Java</td>
<td>23.0.1</td>
</tr>
<tr>
<td>JavaScript</td>
<td>20.18.1</td>
</tr>
<tr>
<td>Go</td>
<td>1.24.2</td>
</tr>
<tr>
<td>Matlab</td>
<td>-</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.12 开发环境</span></center>

<h3 id="2-5-1-代码源码"><a href="#2-5-1-代码源码" class="headerlink" title="2.5.1 代码源码"></a>2.5.1 代码源码</h3><p>lzw.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常量定义</span></span><br><span class="line">MAX_BITS = <span class="number">19</span></span><br><span class="line">MAX_SIZE = <span class="number">1</span> &lt;&lt; MAX_BITS  <span class="comment"># 524288</span></span><br><span class="line">CHINESE_DICT = <span class="string">&quot;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动\</span></span><br><span class="line"><span class="string">                方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门\</span></span><br><span class="line"><span class="string">                利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢\</span></span><br><span class="line"><span class="string">                病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影\</span></span><br><span class="line"><span class="string">                红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算\</span></span><br><span class="line"><span class="string">                义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LZW</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.dict_nodes = []  <span class="comment"># 存储字典节点 (parent, ch)</span></span><br><span class="line">        <span class="variable language_">self</span>.hash_table = &#123;&#125;  <span class="comment"># 哈希表 (parent, ch) -&gt; index</span></span><br><span class="line">        <span class="variable language_">self</span>.queue = deque()  <span class="comment"># FIFO队列</span></span><br><span class="line">        <span class="variable language_">self</span>.next_code = <span class="number">0</span>    <span class="comment"># 下一个可用索引</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dict_init</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化字典（包含单字节字符和中文字典）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.dict_nodes = [(-<span class="number">1</span>, <span class="number">0</span>)] + [(<span class="number">0</span>, <span class="number">0</span>)] * (MAX_SIZE - <span class="number">1</span>)  <span class="comment"># 预分配空间</span></span><br><span class="line">        <span class="variable language_">self</span>.hash_table.clear()</span><br><span class="line">        <span class="variable language_">self</span>.queue.clear()</span><br><span class="line">        <span class="variable language_">self</span>.next_code = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化单字节字符（0-255）</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="variable language_">self</span>.dict_nodes[<span class="variable language_">self</span>.next_code] = (<span class="number">0</span>, ch)</span><br><span class="line">            <span class="variable language_">self</span>.hash_table[(<span class="number">0</span>, ch)] = <span class="variable language_">self</span>.next_code</span><br><span class="line">            <span class="variable language_">self</span>.queue.append(<span class="variable language_">self</span>.next_code)</span><br><span class="line">            <span class="variable language_">self</span>.next_code += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化中文字典</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> CHINESE_DICT:</span><br><span class="line">            utf8_bytes = c.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            parent = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> byte <span class="keyword">in</span> utf8_bytes:</span><br><span class="line">                key = (parent, byte)</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hash_table:</span><br><span class="line">                    parent = <span class="variable language_">self</span>.hash_table[key]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._add_node(parent, byte)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_add_node</span>(<span class="params">self, parent, ch</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;内部方法：添加新节点（含FIFO替换）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.next_code &lt; MAX_SIZE:</span><br><span class="line">            idx = <span class="variable language_">self</span>.next_code</span><br><span class="line">            <span class="variable language_">self</span>.next_code += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># FIFO替换旧节点</span></span><br><span class="line">            idx = <span class="variable language_">self</span>.queue.popleft()</span><br><span class="line">            old_parent, old_ch = <span class="variable language_">self</span>.dict_nodes[idx]</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.hash_table[(old_parent, old_ch)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加新节点</span></span><br><span class="line">        <span class="variable language_">self</span>.dict_nodes[idx] = (parent, ch)</span><br><span class="line">        <span class="variable language_">self</span>.hash_table[(parent, ch)] = idx</span><br><span class="line">        <span class="variable language_">self</span>.queue.append(idx)</span><br><span class="line">        <span class="keyword">return</span> idx</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_pack_bits</span>(<span class="params">codes</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将代码列表打包为位流字节&quot;&quot;&quot;</span></span><br><span class="line">        bitbuf = <span class="number">0</span></span><br><span class="line">        bits = <span class="number">0</span></span><br><span class="line">        out = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> code <span class="keyword">in</span> codes:</span><br><span class="line">            bitbuf = (bitbuf &lt;&lt; MAX_BITS) | code</span><br><span class="line">            bits += MAX_BITS</span><br><span class="line">            <span class="keyword">while</span> bits &gt;= <span class="number">8</span>:</span><br><span class="line">                bits -= <span class="number">8</span></span><br><span class="line">                out.append((bitbuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>)</span><br><span class="line">                bitbuf &amp;= (<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>  <span class="comment"># 保留剩余位</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> bits &gt; <span class="number">0</span>:  <span class="comment"># 处理剩余位</span></span><br><span class="line">            out.append((bitbuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将位流字节解包为代码列表&quot;&quot;&quot;</span></span><br><span class="line">        codes = []</span><br><span class="line">        bitbuf = <span class="number">0</span></span><br><span class="line">        bits = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            bitbuf = (bitbuf &lt;&lt; <span class="number">8</span>) | byte</span><br><span class="line">            bits += <span class="number">8</span></span><br><span class="line">            <span class="keyword">while</span> bits &gt;= MAX_BITS:</span><br><span class="line">                bits -= MAX_BITS</span><br><span class="line">                codes.append((bitbuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>))</span><br><span class="line">                bitbuf &amp;= (<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span>  <span class="comment"># 保留剩余位</span></span><br><span class="line">        <span class="keyword">return</span> codes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;压缩数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.dict_init()</span><br><span class="line">        codes = []</span><br><span class="line">        parent = <span class="number">0</span>  <span class="comment"># 初始父节点为根节点</span></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            key = (parent, byte)</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hash_table:</span><br><span class="line">                parent = <span class="variable language_">self</span>.hash_table[key]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                codes.append(parent)</span><br><span class="line">                <span class="variable language_">self</span>._add_node(parent, byte)</span><br><span class="line">                parent = <span class="variable language_">self</span>.hash_table[(<span class="number">0</span>, byte)]  <span class="comment"># 单字节字符必然存在</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> parent != <span class="number">0</span>:  <span class="comment"># 输出最后一个父节点</span></span><br><span class="line">            codes.append(parent)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._pack_bits(codes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解压数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.dict_init()</span><br><span class="line">        codes = <span class="variable language_">self</span>._unpack_bits(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> codes:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        out = []</span><br><span class="line">        prev_code = codes[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 处理第一个代码</span></span><br><span class="line">        current_str = <span class="variable language_">self</span>._get_string(prev_code)</span><br><span class="line">        out.append(current_str)</span><br><span class="line">        first_ch = current_str[<span class="number">0</span>] <span class="keyword">if</span> current_str <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理后续代码</span></span><br><span class="line">        <span class="keyword">for</span> code <span class="keyword">in</span> codes[<span class="number">1</span>:]:</span><br><span class="line">            <span class="keyword">if</span> code == <span class="variable language_">self</span>.next_code:  <span class="comment"># 特殊情况处理</span></span><br><span class="line">                prev_str = <span class="variable language_">self</span>._get_string(prev_code)</span><br><span class="line">                current_str = prev_str + <span class="built_in">bytes</span>([first_ch])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                current_str = <span class="variable language_">self</span>._get_string(code)</span><br><span class="line">            </span><br><span class="line">            out.append(current_str)</span><br><span class="line">            first_ch = current_str[<span class="number">0</span>] <span class="keyword">if</span> current_str <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="variable language_">self</span>._add_node(prev_code, first_ch)  <span class="comment"># 添加新条目</span></span><br><span class="line">            prev_code = code</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join(out)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_string</span>(<span class="params">self, code</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据代码获取对应的字符串&quot;&quot;&quot;</span></span><br><span class="line">        stack = []</span><br><span class="line">        cur = code</span><br><span class="line">        <span class="keyword">while</span> cur != <span class="number">0</span>:</span><br><span class="line">            stack.append(<span class="variable language_">self</span>.dict_nodes[cur][<span class="number">1</span>])</span><br><span class="line">            cur = <span class="variable language_">self</span>.dict_nodes[cur][<span class="number">0</span>]</span><br><span class="line">        stack.reverse()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(stack)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># if len(sys.argv) &lt; 2:</span></span><br><span class="line">    <span class="comment">#     print(f&quot;用法: &#123;sys.argv[0]&#125; &lt;输入文件路径&gt;&quot;)</span></span><br><span class="line">    <span class="comment">#     return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># input_path = sys.argv[1]</span></span><br><span class="line">    input_path = <span class="string">r&quot;D:\tmp\TheCountofMonteCristo.txt&quot;</span></span><br><span class="line">    dir_path, filename = os.path.split(input_path)</span><br><span class="line">    base_name = os.path.splitext(filename)[<span class="number">0</span>]</span><br><span class="line">    comp_path = os.path.join(dir_path, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.lzw&quot;</span>)</span><br><span class="line">    decomp_path = os.path.join(dir_path, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.dec&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取输入文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        in_data = f.read()</span><br><span class="line">    in_len = <span class="built_in">len</span>(in_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 压缩</span></span><br><span class="line">    lzw = LZW()</span><br><span class="line">    t0 = time.time()</span><br><span class="line">    comp_data = lzw.compress(in_data)</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(comp_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(comp_data)</span><br><span class="line">    comp_len = <span class="built_in">len</span>(comp_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;压缩完成: <span class="subst">&#123;in_len&#125;</span> -&gt; <span class="subst">&#123;comp_len&#125;</span> bytes, 用时 <span class="subst">&#123;t1-t0:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解压</span></span><br><span class="line">    lzw = LZW()</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    decomp_data = lzw.decompress(comp_data)</span><br><span class="line">    t3 = time.time()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(decomp_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(decomp_data)</span><br><span class="line">    decomp_len = <span class="built_in">len</span>(decomp_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解压完成: <span class="subst">&#123;decomp_len&#125;</span> bytes, 用时 <span class="subst">&#123;t3-t2:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验</span></span><br><span class="line">    <span class="keyword">if</span> decomp_data == in_data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;校验通过&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;校验失败!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>lzw.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * lzw_fast.c  ——  LZW 压缩/解压（变长编码，19 bit，FIFO 替换，哈希表查询，Trie 树结构），支持中文初始字典</span></span><br><span class="line"><span class="comment"> * 编译：  gcc -std=c99 -O3 -o lzw_fast lzw_fast.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 参数与宏 ---------- */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BITS 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SIZE (1u &lt;&lt; MAX_BITS) <span class="comment">/* 524 288 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HASH_SIZE (1u &lt;&lt; 20)      <span class="comment">/* 1 048 576，需为 2^n */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 数据结构 ---------- */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int32_t</span> parent; <span class="comment">/* 父节点索引，-1 表示根 */</span></span><br><span class="line">    <span class="type">uint8_t</span> ch;     <span class="comment">/* 本节点对应字符（0‑255） */</span></span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 函数原型声明 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dict_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">add_node</span><span class="params">(<span class="type">int32_t</span> parent, <span class="type">uint8_t</span> ch)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pack_bits</span><span class="params">(<span class="type">const</span> <span class="type">int32_t</span> *codes, <span class="type">size_t</span> n, <span class="type">uint8_t</span> **out_buf, <span class="type">size_t</span> *out_len)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> *<span class="title function_">unpack_bits</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len, <span class="type">size_t</span> *out_n)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">compress_file</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *in, <span class="type">size_t</span> in_len, <span class="type">uint8_t</span> **out, <span class="type">size_t</span> *out_len)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">decompress_file</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *in, <span class="type">size_t</span> in_len, <span class="type">uint8_t</span> **out_buf, <span class="type">size_t</span> *out_len)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> *<span class="title function_">read_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">size_t</span> *len)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">write_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> len)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 全局变量 ---------- */</span></span><br><span class="line"><span class="type">static</span> Node dict[MAX_SIZE];            <span class="comment">/* 字典条目数组 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> hash_parent[HASH_SIZE]; <span class="comment">/* 哈希键 (parent,char) */</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> hash_char[HASH_SIZE];</span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> hash_val[HASH_SIZE]; <span class="comment">/* 存入的 index，-1 表示空槽 */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="built_in">queue</span>[MAX_SIZE];        <span class="comment">/* FIFO 队列保存 index */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> q_head = <span class="number">0</span>, q_tail = <span class="number">0</span>; <span class="comment">/* 环形队列指针 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> next_code;              <span class="comment">/* 下一个可用索引 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 哈希工具 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">hash_func</span><span class="params">(<span class="type">int32_t</span> parent, <span class="type">uint8_t</span> ch)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">uint32_t</span>)parent * <span class="number">131u</span> + ch) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hash_clear</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(hash_val, <span class="number">0xFF</span>, <span class="keyword">sizeof</span>(hash_val));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">hash_find</span><span class="params">(<span class="type">int32_t</span> parent, <span class="type">uint8_t</span> ch)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> pos = hash_func(parent, ch);</span><br><span class="line">    <span class="keyword">while</span> (hash_val[pos] != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (hash_parent[pos] == parent &amp;&amp; hash_char[pos] == ch)</span><br><span class="line">            <span class="keyword">return</span> hash_val[pos];</span><br><span class="line">        pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hash_insert</span><span class="params">(<span class="type">int32_t</span> parent, <span class="type">uint8_t</span> ch, <span class="type">int32_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> pos = hash_func(parent, ch);</span><br><span class="line">    <span class="keyword">while</span> (hash_val[pos] != <span class="number">-1</span>)</span><br><span class="line">        pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">    hash_parent[pos] = parent;</span><br><span class="line">    hash_char[pos] = ch;</span><br><span class="line">    hash_val[pos] = idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 字典初始化 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dict_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    setlocale(LC_ALL, <span class="string">&quot;&quot;</span>);  <span class="comment">// 设置本地编码</span></span><br><span class="line">    hash_clear();</span><br><span class="line"></span><br><span class="line">    dict[<span class="number">0</span>].parent = <span class="number">-1</span>;</span><br><span class="line">    dict[<span class="number">0</span>].ch = <span class="number">0</span>;</span><br><span class="line">    next_code = <span class="number">1</span>;</span><br><span class="line">    q_head = q_tail = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i) &#123;</span><br><span class="line">        dict[next_code].parent = <span class="number">0</span>;</span><br><span class="line">        dict[next_code].ch = (<span class="type">uint8_t</span>)i;</span><br><span class="line">        hash_insert(<span class="number">0</span>, (<span class="type">uint8_t</span>)i, next_code);</span><br><span class="line">        <span class="built_in">queue</span>[q_tail++] = next_code;</span><br><span class="line">        ++next_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">wchar_t</span> *chinese_dict = <span class="string">L&quot;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动\</span></span><br><span class="line"><span class="string">                                    方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门\</span></span><br><span class="line"><span class="string">                                    利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢\</span></span><br><span class="line"><span class="string">                                    病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影\</span></span><br><span class="line"><span class="string">                                    红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算\</span></span><br><span class="line"><span class="string">                                    义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="type">wchar_t</span> *p = chinese_dict; *p; ++p) &#123;</span><br><span class="line">        <span class="type">char</span> utf8[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = wctomb(utf8, *p);</span><br><span class="line">        <span class="type">int32_t</span> parent = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">            <span class="type">int32_t</span> nxt = hash_find(parent, (<span class="type">uint8_t</span>)utf8[i]);</span><br><span class="line">            <span class="keyword">if</span> (nxt == <span class="number">-1</span>) nxt = add_node(parent, (<span class="type">uint8_t</span>)utf8[i]);</span><br><span class="line">            parent = nxt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 添加节点 / FIFO 替换 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">add_node</span><span class="params">(<span class="type">int32_t</span> parent, <span class="type">uint8_t</span> ch)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> idx;</span><br><span class="line">    <span class="keyword">if</span> (next_code &lt; MAX_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        idx = next_code++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        idx = <span class="built_in">queue</span>[q_head];</span><br><span class="line">        q_head = (q_head + <span class="number">1</span>) % MAX_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="type">int32_t</span> op = dict[idx].parent;</span><br><span class="line">        <span class="type">uint8_t</span> oc = dict[idx].ch;</span><br><span class="line">        <span class="type">uint32_t</span> pos = hash_func(op, oc);</span><br><span class="line">        <span class="keyword">while</span> (!(hash_parent[pos] == op &amp;&amp; hash_char[pos] == oc))</span><br><span class="line">            pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">        hash_val[pos] = <span class="number">-1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> nxt = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span> (hash_val[nxt] != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int32_t</span> tp = hash_parent[nxt];</span><br><span class="line">            <span class="type">uint8_t</span> tc = hash_char[nxt];</span><br><span class="line">            <span class="type">int32_t</span> tv = hash_val[nxt];</span><br><span class="line">            hash_val[nxt] = <span class="number">-1</span>;</span><br><span class="line">            hash_insert(tp, tc, tv);</span><br><span class="line">            nxt = (nxt + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dict[idx].parent = parent;</span><br><span class="line">    dict[idx].ch = ch;</span><br><span class="line">    hash_insert(parent, ch, idx);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span>[q_tail] = idx;</span><br><span class="line">    q_tail = (q_tail + <span class="number">1</span>) % MAX_SIZE;</span><br><span class="line">    <span class="keyword">return</span> idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 位流打包 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pack_bits</span><span class="params">(<span class="type">const</span> <span class="type">int32_t</span> *codes, <span class="type">size_t</span> n, <span class="type">uint8_t</span> **out_buf, <span class="type">size_t</span> *out_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> bitbuf = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> bits = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> cap = n * (MAX_BITS + <span class="number">7</span>) / <span class="number">8</span> + <span class="number">4</span>;</span><br><span class="line">    <span class="type">uint8_t</span> *out = (<span class="type">uint8_t</span> *)<span class="built_in">malloc</span>(cap);</span><br><span class="line">    <span class="type">size_t</span> len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        bitbuf = (bitbuf &lt;&lt; MAX_BITS) | (<span class="type">uint32_t</span>)codes[i];</span><br><span class="line">        bits += MAX_BITS;</span><br><span class="line">        <span class="keyword">while</span> (bits &gt;= <span class="number">8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bits -= <span class="number">8</span>;</span><br><span class="line">            out[len++] = (bitbuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bits)</span><br><span class="line">    &#123;</span><br><span class="line">        out[len++] = (bitbuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *out_buf = out;</span><br><span class="line">    *out_len = len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 位流拆包 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> *<span class="title function_">unpack_bits</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len, <span class="type">size_t</span> *out_n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> cap = len * <span class="number">8</span> / MAX_BITS + <span class="number">4</span>;</span><br><span class="line">    <span class="type">int32_t</span> *codes = (<span class="type">int32_t</span> *)<span class="built_in">malloc</span>(cap * <span class="keyword">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">    <span class="type">size_t</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint32_t</span> bitbuf = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> bits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        bitbuf = (bitbuf &lt;&lt; <span class="number">8</span>) | data[i];</span><br><span class="line">        bits += <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">while</span> (bits &gt;= MAX_BITS)</span><br><span class="line">        &#123;</span><br><span class="line">            bits -= MAX_BITS;</span><br><span class="line">            codes[n++] = (bitbuf &gt;&gt; bits) &amp; ((<span class="number">1u</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *out_n = n;</span><br><span class="line">    <span class="keyword">return</span> codes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 压缩 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">compress_file</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *in, <span class="type">size_t</span> in_len, <span class="type">uint8_t</span> **out, <span class="type">size_t</span> *out_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> *codes = (<span class="type">int32_t</span> *)<span class="built_in">malloc</span>((in_len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">    <span class="type">size_t</span> n_codes = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int32_t</span> parent = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; in_len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint8_t</span> c = in[i];</span><br><span class="line">        <span class="type">int32_t</span> nxt = hash_find(parent, c);</span><br><span class="line">        <span class="keyword">if</span> (nxt != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            parent = nxt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            codes[n_codes++] = parent;</span><br><span class="line">            add_node(parent, c);</span><br><span class="line">            parent = hash_find(<span class="number">0</span>, c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="number">0</span>)</span><br><span class="line">        codes[n_codes++] = parent;</span><br><span class="line"></span><br><span class="line">    pack_bits(codes, n_codes, out, out_len);</span><br><span class="line">    <span class="built_in">free</span>(codes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 解压 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">decompress_file</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *in, <span class="type">size_t</span> in_len, <span class="type">uint8_t</span> **out_buf, <span class="type">size_t</span> *out_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> n_codes;</span><br><span class="line">    <span class="type">int32_t</span> *codes = unpack_bits(in, in_len, &amp;n_codes);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> cap = <span class="number">4096</span>;</span><br><span class="line">    <span class="type">uint8_t</span> *out = (<span class="type">uint8_t</span> *)<span class="built_in">malloc</span>(cap);</span><br><span class="line">    <span class="type">size_t</span> len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> prev_code = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> first_ch = <span class="number">0</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> <span class="built_in">stack</span>[MAX_SIZE];</span><br><span class="line">    <span class="type">int</span> top;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n_codes; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int32_t</span> code = codes[i];</span><br><span class="line">        top = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int32_t</span> cur = code;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code == next_code &amp;&amp; prev_code != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cur = prev_code;</span><br><span class="line">            <span class="built_in">stack</span>[top++] = first_ch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (cur != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">stack</span>[top++] = dict[cur].ch;</span><br><span class="line">            cur = dict[cur].parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        first_ch = <span class="built_in">stack</span>[top - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len + (<span class="type">size_t</span>)top &gt; cap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (len + (<span class="type">size_t</span>)top &gt; cap);</span><br><span class="line">            out = (<span class="type">uint8_t</span> *)<span class="built_in">realloc</span>(out, cap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = top - <span class="number">1</span>; j &gt;= <span class="number">0</span>; --j)</span><br><span class="line">            out[len++] = <span class="built_in">stack</span>[j];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prev_code != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            add_node(prev_code, first_ch);</span><br><span class="line">        &#125;</span><br><span class="line">        prev_code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(codes);</span><br><span class="line">    *out_buf = out;</span><br><span class="line">    *out_len = len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 文件辅助 ---------- */</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> *<span class="title function_">read_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">size_t</span> *len)</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp = fopen(path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(path);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    *len = ftell(fp);</span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *buf = (<span class="type">uint8_t</span> *)<span class="built_in">malloc</span>(*len);</span><br><span class="line">    fread(buf, <span class="number">1</span>, *len, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">write_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp = fopen(path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(path);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(buf, <span class="number">1</span>, len, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- 主程序 ---------- */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *input_path;</span><br><span class="line">    <span class="type">char</span> *comp_path, *decomp_path;</span><br><span class="line">    <span class="type">char</span> *filename, *dir_path, *last_sep, *dot_pos;</span><br><span class="line"></span><br><span class="line">    SetConsoleOutputCP(CP_UTF8);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        input_path = argv[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;用法: %s &lt;输入文件路径&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    last_sep = <span class="built_in">strrchr</span>(input_path, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!last_sep)</span><br><span class="line">        last_sep = <span class="built_in">strrchr</span>(input_path, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (last_sep)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> dir_len = last_sep - input_path + <span class="number">1</span>;</span><br><span class="line">        dir_path = (<span class="type">char</span> *)<span class="built_in">malloc</span>(dir_len);</span><br><span class="line">        <span class="built_in">strncpy</span>(dir_path, input_path, dir_len);</span><br><span class="line">        filename = last_sep + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        dir_path = (<span class="type">char</span> *)<span class="string">&quot;.&quot;</span>;</span><br><span class="line">        filename = (<span class="type">char</span> *)input_path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dot_pos = <span class="built_in">strrchr</span>(filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (dot_pos)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> base_len = dot_pos - filename;</span><br><span class="line">        <span class="type">char</span> *base_filename = (<span class="type">char</span> *)<span class="built_in">malloc</span>(base_len + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(base_filename, filename, base_len);</span><br><span class="line">        base_filename[base_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        filename = base_filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> fn_len = <span class="built_in">strlen</span>(filename);</span><br><span class="line">    comp_path = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(dir_path) + fn_len + <span class="number">5</span>);</span><br><span class="line">    decomp_path = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(dir_path) + fn_len + <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(comp_path, <span class="built_in">strlen</span>(dir_path) + fn_len + <span class="number">5</span>, <span class="string">&quot;%s%s.lzw&quot;</span>, dir_path, filename);</span><br><span class="line">    <span class="built_in">snprintf</span>(decomp_path, <span class="built_in">strlen</span>(dir_path) + fn_len + <span class="number">5</span>, <span class="string">&quot;%s%s.dec&quot;</span>, dir_path, filename);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> in_len;</span><br><span class="line">    <span class="type">uint8_t</span> *in_buf = read_file(input_path, &amp;in_len);</span><br><span class="line"></span><br><span class="line">    dict_init();</span><br><span class="line">    <span class="type">clock_t</span> t0 = clock();</span><br><span class="line">    <span class="type">uint8_t</span> *comp_buf;</span><br><span class="line">    <span class="type">size_t</span> comp_len;</span><br><span class="line">    compress_file(in_buf, in_len, &amp;comp_buf, &amp;comp_len);</span><br><span class="line">    <span class="type">clock_t</span> t1 = clock();</span><br><span class="line"></span><br><span class="line">    write_file(comp_path, comp_buf, comp_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;压缩完成: %zu -&gt; %zu bytes, 用时 %.3f s\n&quot;</span>, in_len, comp_len, (<span class="type">double</span>)(t1 - t0) / CLOCKS_PER_SEC);</span><br><span class="line"></span><br><span class="line">    dict_init();</span><br><span class="line">    <span class="type">clock_t</span> t2 = clock();</span><br><span class="line">    <span class="type">uint8_t</span> *decomp_buf;</span><br><span class="line">    <span class="type">size_t</span> decomp_len;</span><br><span class="line">    decompress_file(comp_buf, comp_len, &amp;decomp_buf, &amp;decomp_len);</span><br><span class="line">    <span class="type">clock_t</span> t3 = clock();</span><br><span class="line"></span><br><span class="line">    write_file(decomp_path, decomp_buf, decomp_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;解压完成: %zu bytes, 用时 %.3f s\n&quot;</span>, decomp_len, (<span class="type">double</span>)(t3 - t2) / CLOCKS_PER_SEC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (decomp_len != in_len || <span class="built_in">memcmp</span>(in_buf, decomp_buf, in_len) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;校验失败!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;校验通过&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(in_buf);</span><br><span class="line">    <span class="built_in">free</span>(comp_buf);</span><br><span class="line">    <span class="built_in">free</span>(decomp_buf);</span><br><span class="line">    <span class="built_in">free</span>(dir_path);</span><br><span class="line">    <span class="built_in">free</span>(comp_path);</span><br><span class="line">    <span class="built_in">free</span>(decomp_path);</span><br><span class="line">    <span class="keyword">if</span> (dot_pos)</span><br><span class="line">        <span class="built_in">free</span>(filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lzw.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LZW</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_BITS</span> <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SIZE</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; MAX_BITS;  <span class="comment">// 524288</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_SIZE</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">20</span>;       <span class="comment">// 1048576</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中文字典</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHINESE_DICT</span> <span class="operator">=</span> <span class="string">&quot;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动&quot;</span> +</span><br><span class="line">            <span class="string">&quot;方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门&quot;</span> +</span><br><span class="line">            <span class="string">&quot;利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢&quot;</span> +</span><br><span class="line">            <span class="string">&quot;病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影&quot;</span> +</span><br><span class="line">            <span class="string">&quot;红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算&quot;</span> +</span><br><span class="line">            <span class="string">&quot;义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用原始类型数组替代对象数组，减少内存使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] dictParent = <span class="keyword">new</span> <span class="title class_">int</span>[MAX_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] dictChar = <span class="keyword">new</span> <span class="title class_">byte</span>[MAX_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] hashParent = <span class="keyword">new</span> <span class="title class_">int</span>[HASH_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] hashChar = <span class="keyword">new</span> <span class="title class_">byte</span>[HASH_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] hashVal = <span class="keyword">new</span> <span class="title class_">int</span>[HASH_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] queue = <span class="keyword">new</span> <span class="title class_">int</span>[MAX_SIZE];</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">qHead</span> <span class="operator">=</span> <span class="number">0</span>, qTail = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> nextCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化字典</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dictInit</span><span class="params">()</span> &#123;</span><br><span class="line">        Arrays.fill(hashVal, -<span class="number">1</span>);</span><br><span class="line">        Arrays.fill(dictParent, -<span class="number">1</span>);</span><br><span class="line">        Arrays.fill(dictChar, (<span class="type">byte</span>)<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化根节点</span></span><br><span class="line">        dictParent[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">        dictChar[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        nextCode = <span class="number">1</span>;</span><br><span class="line">        qHead = qTail = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化单字节字符</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">            dictParent[nextCode] = <span class="number">0</span>;</span><br><span class="line">            dictChar[nextCode] = (<span class="type">byte</span>)i;</span><br><span class="line">            hashInsert(<span class="number">0</span>, (<span class="type">byte</span>)i, nextCode);</span><br><span class="line">            queue[qTail++] = nextCode;</span><br><span class="line">            nextCode++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化中文字典</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span> c : CHINESE_DICT.toCharArray()) &#123;</span><br><span class="line">                <span class="type">byte</span>[] utf8 = String.valueOf(c).getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">byte</span> b : utf8) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> hashFind(parent, b);</span><br><span class="line">                    <span class="keyword">if</span> (next == -<span class="number">1</span>) &#123;</span><br><span class="line">                        next = addNode(parent, b);</span><br><span class="line">                    &#125;</span><br><span class="line">                    parent = next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;UTF-8编码不支持&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的哈希函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hashFunc</span><span class="params">(<span class="type">int</span> parent, <span class="type">byte</span> ch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((parent * <span class="number">131</span> + (ch &amp; <span class="number">0xFF</span>)) &amp; (HASH_SIZE - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的哈希查找</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hashFind</span><span class="params">(<span class="type">int</span> parent, <span class="type">byte</span> ch)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> hashFunc(parent, ch);</span><br><span class="line">        <span class="keyword">while</span> (hashVal[pos] != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashParent[pos] == parent &amp;&amp; hashChar[pos] == ch) &#123;</span><br><span class="line">                <span class="keyword">return</span> hashVal[pos];</span><br><span class="line">            &#125;</span><br><span class="line">            pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的哈希插入</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hashInsert</span><span class="params">(<span class="type">int</span> parent, <span class="type">byte</span> ch, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> hashFunc(parent, ch);</span><br><span class="line">        <span class="keyword">while</span> (hashVal[pos] != -<span class="number">1</span>) &#123;</span><br><span class="line">            pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        hashParent[pos] = parent;</span><br><span class="line">        hashChar[pos] = ch;</span><br><span class="line">        hashVal[pos] = idx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的节点添加</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">addNode</span><span class="params">(<span class="type">int</span> parent, <span class="type">byte</span> ch)</span> &#123;</span><br><span class="line">        <span class="type">int</span> idx;</span><br><span class="line">        <span class="keyword">if</span> (nextCode &lt; MAX_SIZE) &#123;</span><br><span class="line">            idx = nextCode++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            idx = queue[qHead];</span><br><span class="line">            qHead = (qHead + <span class="number">1</span>) % MAX_SIZE;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 移除旧映射</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">oldParent</span> <span class="operator">=</span> dictParent[idx];</span><br><span class="line">            <span class="type">byte</span> <span class="variable">oldCh</span> <span class="operator">=</span> dictChar[idx];</span><br><span class="line">            <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> hashFunc(oldParent, oldCh);</span><br><span class="line">            <span class="keyword">while</span> (!(hashParent[pos] == oldParent &amp;&amp; hashChar[pos] == oldCh)) &#123;</span><br><span class="line">                pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            hashVal[pos] = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重新哈希</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextPos</span> <span class="operator">=</span> (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">while</span> (hashVal[nextPos] != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">tp</span> <span class="operator">=</span> hashParent[nextPos];</span><br><span class="line">                <span class="type">byte</span> <span class="variable">tc</span> <span class="operator">=</span> hashChar[nextPos];</span><br><span class="line">                <span class="type">int</span> <span class="variable">tv</span> <span class="operator">=</span> hashVal[nextPos];</span><br><span class="line">                hashVal[nextPos] = -<span class="number">1</span>;</span><br><span class="line">                hashInsert(tp, tc, tv);</span><br><span class="line">                nextPos = (nextPos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dictParent[idx] = parent;</span><br><span class="line">        dictChar[idx] = ch;</span><br><span class="line">        hashInsert(parent, ch, idx);</span><br><span class="line">        queue[qTail] = idx;</span><br><span class="line">        qTail = (qTail + <span class="number">1</span>) % MAX_SIZE;</span><br><span class="line">        <span class="keyword">return</span> idx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的位流打包</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] packBits(<span class="type">int</span>[] codes) &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(codes.length * <span class="number">3</span>); <span class="comment">// 预分配空间</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bitBuf</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bits</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> code : codes) &#123;</span><br><span class="line">            bitBuf = (bitBuf &lt;&lt; MAX_BITS) | (code &amp; ((<span class="number">1</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>));</span><br><span class="line">            bits += MAX_BITS;</span><br><span class="line">            <span class="keyword">while</span> (bits &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">                bits -= <span class="number">8</span>;</span><br><span class="line">                out.write((bitBuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            out.write((bitBuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的位流拆包</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] unpackBits(<span class="type">byte</span>[] data) &#123;</span><br><span class="line">        <span class="type">int</span>[] codes = <span class="keyword">new</span> <span class="title class_">int</span>[data.length * <span class="number">8</span> / MAX_BITS + <span class="number">1</span>]; <span class="comment">// 预分配空间</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">codeCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bitBuf</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bits</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : data) &#123;</span><br><span class="line">            bitBuf = (bitBuf &lt;&lt; <span class="number">8</span>) | (b &amp; <span class="number">0xFF</span>);</span><br><span class="line">            bits += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">while</span> (bits &gt;= MAX_BITS) &#123;</span><br><span class="line">                bits -= MAX_BITS;</span><br><span class="line">                codes[codeCount++] = (bitBuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Arrays.copyOf(codes, codeCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的压缩方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] input) &#123;</span><br><span class="line">        <span class="type">int</span>[] codes = <span class="keyword">new</span> <span class="title class_">int</span>[input.length]; <span class="comment">// 预分配空间</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">codeCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> c : input) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> hashFind(parent, c);</span><br><span class="line">            <span class="keyword">if</span> (next != -<span class="number">1</span>) &#123;</span><br><span class="line">                parent = next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                codes[codeCount++] = parent;</span><br><span class="line">                addNode(parent, c);</span><br><span class="line">                parent = hashFind(<span class="number">0</span>, c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="number">0</span>) &#123;</span><br><span class="line">            codes[codeCount++] = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> packBits(Arrays.copyOf(codes, codeCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化的解压方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] decompress(<span class="type">byte</span>[] input) &#123;</span><br><span class="line">        <span class="type">int</span>[] codes = unpackBits(input);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(input.length * <span class="number">2</span>); <span class="comment">// 预分配空间</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">prevCode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">firstCh</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] stack = <span class="keyword">new</span> <span class="title class_">byte</span>[MAX_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> code : codes) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">top</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cur</span> <span class="operator">=</span> code;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (code == nextCode &amp;&amp; prevCode != <span class="number">0</span>) &#123;</span><br><span class="line">                cur = prevCode;</span><br><span class="line">                stack[top++] = firstCh;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (cur != <span class="number">0</span>) &#123;</span><br><span class="line">                stack[top++] = dictChar[cur];</span><br><span class="line">                cur = dictParent[cur];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            firstCh = stack[top - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> top - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">                out.write(stack[j]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (prevCode != <span class="number">0</span>) &#123;</span><br><span class="line">                addNode(prevCode, firstCh);</span><br><span class="line">            &#125;</span><br><span class="line">            prevCode = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具方法：读取文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] readFile(String path) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Files.readAllBytes(Paths.get(path));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具方法：写入文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(String path, <span class="type">byte</span>[] data)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Files.write(Paths.get(path), data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String inputPath;</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span><br><span class="line">            inputPath = <span class="string">&quot;D:\\test\\Twilight.txt&quot;</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;未指定输入路径，使用默认路径: &quot;</span> + inputPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">            inputPath = args[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;错误：参数过多，用法: java LZW [输入文件路径]&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">baseName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(inputPath).getName().replaceFirst(<span class="string">&quot;[.][^.]+$&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">compPath</span> <span class="operator">=</span> baseName + <span class="string">&quot;.lzw&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">decompPath</span> <span class="operator">=</span> baseName + <span class="string">&quot;.dec&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">LZW</span> <span class="variable">compressor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LZW</span>();</span><br><span class="line">        compressor.dictInit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 压缩</span></span><br><span class="line">        <span class="type">byte</span>[] input = readFile(inputPath);</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">byte</span>[] compressed = compressor.compress(input);</span><br><span class="line">        <span class="type">long</span> <span class="variable">compressTime</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">        writeFile(compPath, compressed);</span><br><span class="line">        System.out.printf(<span class="string">&quot;压缩完成: %d -&gt; %d bytes, 用时 %.3fs\n&quot;</span>,</span><br><span class="line">                input.length, compressed.length, compressTime / <span class="number">1000.0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解压</span></span><br><span class="line">        compressor = <span class="keyword">new</span> <span class="title class_">LZW</span>();</span><br><span class="line">        compressor.dictInit();</span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        <span class="type">byte</span>[] decompressed = compressor.decompress(compressed);</span><br><span class="line">        <span class="type">long</span> <span class="variable">decompressTime</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">        writeFile(decompPath, decompressed);</span><br><span class="line">        System.out.printf(<span class="string">&quot;解压完成: %d bytes, 用时 %.3fs\n&quot;</span>,</span><br><span class="line">                decompressed.length, decompressTime / <span class="number">1000.0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 校验</span></span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(input, decompressed)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;校验通过&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;校验失败!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lzw.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// LZW 压缩器实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LZW</span> &#123;</span><br><span class="line">  <span class="comment">// 常量定义</span></span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">MAX_BITS</span> = <span class="number">19</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">MAX_SIZE</span> = <span class="number">1</span> &lt;&lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>;  <span class="comment">// 524288</span></span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">HASH_SIZE</span> = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;           <span class="comment">// 1048576</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 中文字典</span></span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">CHINESE_DICT</span> = <span class="string">&quot;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动&quot;</span> +</span><br><span class="line">  <span class="string">&quot;方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门&quot;</span> +</span><br><span class="line">  <span class="string">&quot;利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢&quot;</span> +</span><br><span class="line">  <span class="string">&quot;病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影&quot;</span> +</span><br><span class="line">  <span class="string">&quot;红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算&quot;</span> +</span><br><span class="line">  <span class="string">&quot;义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 使用 TypedArray 优化性能</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictParent</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(<span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictChar</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashParent</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashChar</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashVal</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(<span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">qHead</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">qTail</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nextCode</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化字典</span></span><br><span class="line">  <span class="title function_">dictInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 初始化数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashVal</span>.<span class="title function_">fill</span>(-<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictParent</span>.<span class="title function_">fill</span>(-<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictChar</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化根节点</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictParent</span>[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictChar</span>[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">nextCode</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">qHead</span> = <span class="variable language_">this</span>.<span class="property">qTail</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化单字节字符</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dictParent</span>[<span class="variable language_">this</span>.<span class="property">nextCode</span>] = <span class="number">0</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dictChar</span>[<span class="variable language_">this</span>.<span class="property">nextCode</span>] = i;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">hashInsert</span>(<span class="number">0</span>, i, <span class="variable language_">this</span>.<span class="property">nextCode</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">queue</span>[<span class="variable language_">this</span>.<span class="property">qTail</span>++] = <span class="variable language_">this</span>.<span class="property">nextCode</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">nextCode</span>++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化中文字典</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> c <span class="keyword">of</span> <span class="variable constant_">LZW</span>.<span class="property">CHINESE_DICT</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> utf8 = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(c);</span><br><span class="line">      <span class="keyword">let</span> parent = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> b <span class="keyword">of</span> utf8) &#123;</span><br><span class="line">        <span class="keyword">let</span> next = <span class="variable language_">this</span>.<span class="title function_">hashFind</span>(parent, b);</span><br><span class="line">        <span class="keyword">if</span> (next === -<span class="number">1</span>) &#123;</span><br><span class="line">          next = <span class="variable language_">this</span>.<span class="title function_">addNode</span>(parent, b);</span><br><span class="line">        &#125;</span><br><span class="line">        parent = next;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 哈希函数</span></span><br><span class="line">  <span class="title function_">hashFunc</span>(<span class="params">parent, ch</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent * <span class="number">131</span> + ch) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 哈希查找</span></span><br><span class="line">  <span class="title function_">hashFind</span>(<span class="params">parent, ch</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pos = <span class="variable language_">this</span>.<span class="title function_">hashFunc</span>(parent, ch);</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">hashVal</span>[pos] !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hashParent</span>[pos] === parent &amp;&amp; <span class="variable language_">this</span>.<span class="property">hashChar</span>[pos] === ch) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">hashVal</span>[pos];</span><br><span class="line">      &#125;</span><br><span class="line">      pos = (pos + <span class="number">1</span>) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 哈希插入</span></span><br><span class="line">  <span class="title function_">hashInsert</span>(<span class="params">parent, ch, idx</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pos = <span class="variable language_">this</span>.<span class="title function_">hashFunc</span>(parent, ch);</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">hashVal</span>[pos] !== -<span class="number">1</span>) &#123;</span><br><span class="line">      pos = (pos + <span class="number">1</span>) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashParent</span>[pos] = parent;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashChar</span>[pos] = ch;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hashVal</span>[pos] = idx;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加节点</span></span><br><span class="line">  <span class="title function_">addNode</span>(<span class="params">parent, ch</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> idx;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">nextCode</span> &lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>) &#123;</span><br><span class="line">      idx = <span class="variable language_">this</span>.<span class="property">nextCode</span>++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      idx = <span class="variable language_">this</span>.<span class="property">queue</span>[<span class="variable language_">this</span>.<span class="property">qHead</span>];</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">qHead</span> = (<span class="variable language_">this</span>.<span class="property">qHead</span> + <span class="number">1</span>) % <span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除旧映射</span></span><br><span class="line">        <span class="keyword">const</span> oldParent = <span class="variable language_">this</span>.<span class="property">dictParent</span>[idx];</span><br><span class="line">        <span class="keyword">const</span> oldCh = <span class="variable language_">this</span>.<span class="property">dictChar</span>[idx];</span><br><span class="line">        <span class="keyword">let</span> pos = <span class="variable language_">this</span>.<span class="title function_">hashFunc</span>(oldParent, oldCh);</span><br><span class="line">        <span class="keyword">while</span> (!(<span class="variable language_">this</span>.<span class="property">hashParent</span>[pos] === oldParent &amp;&amp; <span class="variable language_">this</span>.<span class="property">hashChar</span>[pos] === oldCh)) &#123;</span><br><span class="line">            pos = (pos + <span class="number">1</span>) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hashVal</span>[pos] = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重新哈希</span></span><br><span class="line">        <span class="keyword">let</span> nextPos = (pos + <span class="number">1</span>) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">hashVal</span>[nextPos] !== -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> tp = <span class="variable language_">this</span>.<span class="property">hashParent</span>[nextPos];</span><br><span class="line">            <span class="keyword">const</span> tc = <span class="variable language_">this</span>.<span class="property">hashChar</span>[nextPos];</span><br><span class="line">            <span class="keyword">const</span> tv = <span class="variable language_">this</span>.<span class="property">hashVal</span>[nextPos];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hashVal</span>[nextPos] = -<span class="number">1</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">hashInsert</span>(tp, tc, tv);</span><br><span class="line">            nextPos = (nextPos + <span class="number">1</span>) &amp; (<span class="variable constant_">LZW</span>.<span class="property">HASH_SIZE</span> - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictParent</span>[idx] = parent;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dictChar</span>[idx] = ch;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">hashInsert</span>(parent, ch, idx);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span>[<span class="variable language_">this</span>.<span class="property">qTail</span>] = idx;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">qTail</span> = (<span class="variable language_">this</span>.<span class="property">qTail</span> + <span class="number">1</span>) % <span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>;</span><br><span class="line">    <span class="keyword">return</span> idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位流打包</span></span><br><span class="line"><span class="title function_">packBits</span>(<span class="params">codes</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> out = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(codes.<span class="property">length</span> * <span class="number">3</span>); <span class="comment">// 增加缓冲区大小</span></span><br><span class="line">    <span class="keyword">let</span> outPos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> bitBuf = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> bits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> code <span class="keyword">of</span> codes) &#123;</span><br><span class="line">        bitBuf = (bitBuf &lt;&lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) | (code &amp; ((<span class="number">1</span> &lt;&lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) - <span class="number">1</span>));</span><br><span class="line">        bits += <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>;</span><br><span class="line">        <span class="keyword">while</span> (bits &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">            bits -= <span class="number">8</span>;</span><br><span class="line">            out[outPos++] = (bitBuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理剩余位</span></span><br><span class="line">    <span class="keyword">if</span> (bits &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        out[outPos++] = (bitBuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out.<span class="title function_">slice</span>(<span class="number">0</span>, outPos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位流拆包</span></span><br><span class="line"><span class="title function_">unpackBits</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> codes = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(data.<span class="property">length</span> * <span class="number">8</span> / <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span> + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> codeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> bitBuf = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> bits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> byte <span class="keyword">of</span> data) &#123;</span><br><span class="line">    bitBuf = (bitBuf &lt;&lt; <span class="number">8</span>) | byte;</span><br><span class="line">    bits += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">while</span> (bits &gt;= <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) &#123;</span><br><span class="line">        bits -= <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>;</span><br><span class="line">        codes[codeCount++] = (bitBuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理剩余位</span></span><br><span class="line"><span class="keyword">if</span> (bits &gt;= <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) &#123;</span><br><span class="line">    codes[codeCount++] = (bitBuf &gt;&gt; (bits - <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>)) &amp; ((<span class="number">1</span> &lt;&lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_BITS</span>) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> codes.<span class="title function_">slice</span>(<span class="number">0</span>, codeCount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩</span></span><br><span class="line"><span class="title function_">compress</span>(<span class="params">input</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> codes = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(input.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">let</span> codeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> parent = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> byte <span class="keyword">of</span> input) &#123;</span><br><span class="line">    <span class="keyword">const</span> next = <span class="variable language_">this</span>.<span class="title function_">hashFind</span>(parent, byte);</span><br><span class="line">    <span class="keyword">if</span> (next !== -<span class="number">1</span>) &#123;</span><br><span class="line">        parent = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codes[codeCount++] = parent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addNode</span>(parent, byte);</span><br><span class="line">        parent = <span class="variable language_">this</span>.<span class="title function_">hashFind</span>(<span class="number">0</span>, byte);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (parent !== <span class="number">0</span>) &#123;</span><br><span class="line">    codes[codeCount++] = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">packBits</span>(codes.<span class="title function_">slice</span>(<span class="number">0</span>, codeCount));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解压</span></span><br><span class="line"><span class="title function_">decompress</span>(<span class="params">input</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> codes = <span class="variable language_">this</span>.<span class="title function_">unpackBits</span>(input);</span><br><span class="line">    <span class="keyword">const</span> out = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(input.<span class="property">length</span> * <span class="number">4</span>); <span class="comment">// 增加缓冲区大小</span></span><br><span class="line">    <span class="keyword">let</span> outPos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> prevCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> firstCh = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> stack = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> code <span class="keyword">of</span> codes) &#123;</span><br><span class="line">        <span class="keyword">let</span> top = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> cur = code;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (code === <span class="variable language_">this</span>.<span class="property">nextCode</span> &amp;&amp; prevCode !== <span class="number">0</span>) &#123;</span><br><span class="line">            cur = prevCode;</span><br><span class="line">            stack[top++] = firstCh;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code &gt; <span class="variable language_">this</span>.<span class="property">nextCode</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;无效的压缩数据&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (cur !== <span class="number">0</span>) &#123;</span><br><span class="line">            stack[top++] = <span class="variable language_">this</span>.<span class="property">dictChar</span>[cur];</span><br><span class="line">            cur = <span class="variable language_">this</span>.<span class="property">dictParent</span>[cur];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        firstCh = stack[top - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = top - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            out[outPos++] = stack[j];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prevCode !== <span class="number">0</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">nextCode</span> &lt; <span class="variable constant_">LZW</span>.<span class="property">MAX_SIZE</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">addNode</span>(prevCode, firstCh);</span><br><span class="line">        &#125;</span><br><span class="line">        prevCode = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out.<span class="title function_">slice</span>(<span class="number">0</span>, outPos);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读取文件</span></span><br><span class="line">        <span class="keyword">const</span> inputPath = process.<span class="property">argv</span>[<span class="number">2</span>] || <span class="string">&#x27;Twilight.txt&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> input = <span class="keyword">await</span> fs.<span class="property">promises</span>.<span class="title function_">readFile</span>(inputPath);</span><br><span class="line">        <span class="keyword">const</span> baseName = inputPath.<span class="title function_">replace</span>(<span class="regexp">/\.[^/.]+$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> compPath = baseName + <span class="string">&#x27;.lzw&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> decompPath = baseName + <span class="string">&#x27;.dec&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 压缩</span></span><br><span class="line">        <span class="keyword">const</span> compressor = <span class="keyword">new</span> <span class="title function_">LZW</span>();</span><br><span class="line">        compressor.<span class="title function_">dictInit</span>();</span><br><span class="line">        <span class="keyword">const</span> startCompress = performance.<span class="title function_">now</span>();</span><br><span class="line">        <span class="keyword">const</span> compressed = compressor.<span class="title function_">compress</span>(input);</span><br><span class="line">        <span class="keyword">const</span> compressTime = performance.<span class="title function_">now</span>() - startCompress;</span><br><span class="line">        <span class="keyword">await</span> fs.<span class="property">promises</span>.<span class="title function_">writeFile</span>(compPath, compressed);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`压缩完成: <span class="subst">$&#123;input.length&#125;</span> -&gt; <span class="subst">$&#123;compressed.length&#125;</span> bytes, 用时 <span class="subst">$&#123;(compressTime/<span class="number">1000</span>).toFixed(<span class="number">3</span>)&#125;</span>s`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解压</span></span><br><span class="line">    <span class="keyword">const</span> decompressor = <span class="keyword">new</span> <span class="title function_">LZW</span>();</span><br><span class="line">    decompressor.<span class="title function_">dictInit</span>();</span><br><span class="line">    <span class="keyword">const</span> startDecompress = performance.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">const</span> decompressed = decompressor.<span class="title function_">decompress</span>(compressed);</span><br><span class="line">    <span class="keyword">const</span> decompressTime = performance.<span class="title function_">now</span>() - startDecompress;</span><br><span class="line">    <span class="keyword">await</span> fs.<span class="property">promises</span>.<span class="title function_">writeFile</span>(decompPath, decompressed);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`解压完成: <span class="subst">$&#123;decompressed.length&#125;</span> bytes, 用时 <span class="subst">$&#123;(decompressTime/<span class="number">1000</span>).toFixed(<span class="number">3</span>)&#125;</span>s`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验</span></span><br><span class="line"><span class="keyword">if</span> (input.<span class="property">length</span> !== decompressed.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`长度不匹配: 原始=<span class="subst">$&#123;input.length&#125;</span>, 解压=<span class="subst">$&#123;decompressed.length&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> diffCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="title class_">Math</span>.<span class="title function_">min</span>(input.<span class="property">length</span>, decompressed.<span class="property">length</span>); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (input[i] !== decompressed[i]) &#123;</span><br><span class="line">        diffCount++;</span><br><span class="line">        <span class="keyword">if</span> (diffCount &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`位置 <span class="subst">$&#123;i&#125;</span>: 原始=<span class="subst">$&#123;input[i]&#125;</span>, 解压=<span class="subst">$&#123;decompressed[i]&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (diffCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`共发现 <span class="subst">$&#123;diffCount&#125;</span> 处差异`</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;校验通过&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;错误:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果直接运行此文件</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>.<span class="property">main</span> === <span class="variable language_">module</span>) &#123;</span><br><span class="line">    <span class="title function_">main</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出 LZW 类</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="variable constant_">LZW</span>; </span><br></pre></td></tr></table></figure>

<p>lzw.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;flag&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量定义</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    MAX_BITS  = <span class="number">19</span></span><br><span class="line">    MAX_SIZE  = <span class="number">1</span> &lt;&lt; MAX_BITS <span class="comment">// 524288</span></span><br><span class="line">    HASH_SIZE = <span class="number">1</span> &lt;&lt; <span class="number">20</span>       <span class="comment">// 1048576</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中文字典</span></span><br><span class="line"><span class="keyword">var</span> CHINESE_DICT = <span class="string">&quot;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动&quot;</span> +</span><br><span class="line"><span class="string">&quot;方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门&quot;</span> +</span><br><span class="line"><span class="string">&quot;利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢&quot;</span> +</span><br><span class="line"><span class="string">&quot;病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影&quot;</span> +</span><br><span class="line"><span class="string">&quot;红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算&quot;</span> +</span><br><span class="line"><span class="string">&quot;义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LZW 压缩器结构</span></span><br><span class="line"><span class="keyword">type</span> LZW <span class="keyword">struct</span> &#123;</span><br><span class="line">    dictParent []<span class="type">int32</span></span><br><span class="line">    dictChar   []<span class="type">uint8</span></span><br><span class="line">    hashParent []<span class="type">int32</span></span><br><span class="line">    hashChar   []<span class="type">uint8</span></span><br><span class="line">    hashVal    []<span class="type">int32</span></span><br><span class="line">    queue      []<span class="type">int32</span></span><br><span class="line">    qHead      <span class="type">int32</span></span><br><span class="line">    qTail      <span class="type">int32</span></span><br><span class="line">    nextCode   <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建新的 LZW 压缩器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLZW</span><span class="params">()</span></span> *LZW &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;LZW&#123;</span><br><span class="line">        dictParent: <span class="built_in">make</span>([]<span class="type">int32</span>, MAX_SIZE),</span><br><span class="line">        dictChar:   <span class="built_in">make</span>([]<span class="type">uint8</span>, MAX_SIZE),</span><br><span class="line">        hashParent: <span class="built_in">make</span>([]<span class="type">int32</span>, HASH_SIZE),</span><br><span class="line">        hashChar:   <span class="built_in">make</span>([]<span class="type">uint8</span>, HASH_SIZE),</span><br><span class="line">        hashVal:    <span class="built_in">make</span>([]<span class="type">int32</span>, HASH_SIZE),</span><br><span class="line">        queue:      <span class="built_in">make</span>([]<span class="type">int32</span>, MAX_SIZE),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化字典</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> dictInit() &#123;</span><br><span class="line">    <span class="comment">// 初始化数组</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> lzw.hashVal &#123;</span><br><span class="line">        lzw.hashVal[i] = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> lzw.dictParent &#123;</span><br><span class="line">        lzw.dictParent[i] = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化根节点</span></span><br><span class="line">    lzw.dictParent[<span class="number">0</span>] = <span class="number">-1</span></span><br><span class="line">    lzw.dictChar[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    lzw.nextCode = <span class="number">1</span></span><br><span class="line">    lzw.qHead = <span class="number">0</span></span><br><span class="line">    lzw.qTail = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化单字节字符</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">256</span>; i++ &#123;</span><br><span class="line">        lzw.dictParent[lzw.nextCode] = <span class="number">0</span></span><br><span class="line">        lzw.dictChar[lzw.nextCode] = <span class="type">uint8</span>(i)</span><br><span class="line">        lzw.hashInsert(<span class="number">0</span>, <span class="type">uint8</span>(i), lzw.nextCode)</span><br><span class="line">        lzw.queue[lzw.qTail] = lzw.nextCode</span><br><span class="line">        lzw.qTail = (lzw.qTail + <span class="number">1</span>) % MAX_SIZE</span><br><span class="line">        lzw.nextCode++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化中文字典</span></span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> CHINESE_DICT &#123;</span><br><span class="line">        utf8 := []<span class="type">byte</span>(<span class="type">string</span>(c))</span><br><span class="line">        parent := <span class="type">int32</span>(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> _, b := <span class="keyword">range</span> utf8 &#123;</span><br><span class="line">            next := lzw.hashFind(parent, b)</span><br><span class="line">            <span class="keyword">if</span> next == <span class="number">-1</span> &#123;</span><br><span class="line">                next = lzw.addNode(parent, b)</span><br><span class="line">            &#125;</span><br><span class="line">            parent = next</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 哈希函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> hashFunc(parent <span class="type">int32</span>, ch <span class="type">uint8</span>) <span class="type">uint32</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">uint32</span>((<span class="type">uint32</span>(parent)*<span class="number">131</span> + <span class="type">uint32</span>(ch)) &amp; (HASH_SIZE - <span class="number">1</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 哈希查找</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> hashFind(parent <span class="type">int32</span>, ch <span class="type">uint8</span>) <span class="type">int32</span> &#123;</span><br><span class="line">    pos := lzw.hashFunc(parent, ch)</span><br><span class="line">    <span class="keyword">for</span> lzw.hashVal[pos] != <span class="number">-1</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> lzw.hashParent[pos] == parent &amp;&amp; lzw.hashChar[pos] == ch &#123;</span><br><span class="line">            <span class="keyword">return</span> lzw.hashVal[pos]</span><br><span class="line">        &#125;</span><br><span class="line">        pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 哈希插入</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> hashInsert(parent <span class="type">int32</span>, ch <span class="type">uint8</span>, idx <span class="type">int32</span>) &#123;</span><br><span class="line">    pos := lzw.hashFunc(parent, ch)</span><br><span class="line">    <span class="keyword">for</span> lzw.hashVal[pos] != <span class="number">-1</span> &#123;</span><br><span class="line">        pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    lzw.hashParent[pos] = parent</span><br><span class="line">    lzw.hashChar[pos] = ch</span><br><span class="line">    lzw.hashVal[pos] = idx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加节点</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> addNode(parent <span class="type">int32</span>, ch <span class="type">uint8</span>) <span class="type">int32</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> idx <span class="type">int32</span></span><br><span class="line">    <span class="keyword">if</span> lzw.nextCode &lt; MAX_SIZE &#123;</span><br><span class="line">        idx = lzw.nextCode</span><br><span class="line">        lzw.nextCode++</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        idx = lzw.queue[lzw.qHead]</span><br><span class="line">        lzw.qHead = (lzw.qHead + <span class="number">1</span>) % MAX_SIZE</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 移除旧映射</span></span><br><span class="line">		oldParent := lzw.dictParent[idx]</span><br><span class="line">		oldCh := lzw.dictChar[idx]</span><br><span class="line">		pos := lzw.hashFunc(oldParent, oldCh)</span><br><span class="line">		<span class="keyword">for</span> !(lzw.hashParent[pos] == oldParent &amp;&amp; lzw.hashChar[pos] == oldCh) &#123;</span><br><span class="line">			pos = (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		lzw.hashVal[pos] = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 重新哈希</span></span><br><span class="line">		nextPos := (pos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">for</span> lzw.hashVal[nextPos] != <span class="number">-1</span> &#123;</span><br><span class="line">			tp := lzw.hashParent[nextPos]</span><br><span class="line">			tc := lzw.hashChar[nextPos]</span><br><span class="line">			tv := lzw.hashVal[nextPos]</span><br><span class="line">			lzw.hashVal[nextPos] = <span class="number">-1</span></span><br><span class="line">			lzw.hashInsert(tp, tc, tv)</span><br><span class="line">			nextPos = (nextPos + <span class="number">1</span>) &amp; (HASH_SIZE - <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lzw.dictParent[idx] = parent</span><br><span class="line">	lzw.dictChar[idx] = ch</span><br><span class="line">	lzw.hashInsert(parent, ch, idx)</span><br><span class="line">	lzw.queue[lzw.qTail] = idx</span><br><span class="line">	lzw.qTail = (lzw.qTail + <span class="number">1</span>) % MAX_SIZE</span><br><span class="line">	<span class="keyword">return</span> idx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位流打包</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> packBits(codes []<span class="type">int32</span>) []<span class="type">uint8</span> &#123;</span><br><span class="line">	out := <span class="built_in">make</span>([]<span class="type">uint8</span>, <span class="built_in">len</span>(codes)*<span class="number">3</span>)</span><br><span class="line">	outPos := <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> bitBuf <span class="type">uint32</span></span><br><span class="line">	bits := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, code := <span class="keyword">range</span> codes &#123;</span><br><span class="line">		bitBuf = (bitBuf &lt;&lt; MAX_BITS) | <span class="type">uint32</span>(code&amp;((<span class="number">1</span>&lt;&lt;MAX_BITS)<span class="number">-1</span>))</span><br><span class="line">		bits += MAX_BITS</span><br><span class="line">		<span class="keyword">for</span> bits &gt;= <span class="number">8</span> &#123;</span><br><span class="line">			bits -= <span class="number">8</span></span><br><span class="line">			out[outPos] = <span class="type">uint8</span>((bitBuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>)</span><br><span class="line">			outPos++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> bits &gt; <span class="number">0</span> &#123;</span><br><span class="line">		out[outPos] = <span class="type">uint8</span>((bitBuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">		outPos++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> out[:outPos]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位流拆包</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> unpackBits(data []<span class="type">uint8</span>) []<span class="type">int32</span> &#123;</span><br><span class="line">	codes := <span class="built_in">make</span>([]<span class="type">int32</span>, <span class="built_in">len</span>(data)*<span class="number">8</span>/MAX_BITS+<span class="number">1</span>)</span><br><span class="line">	codeCount := <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> bitBuf <span class="type">uint32</span></span><br><span class="line">	bits := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> data &#123;</span><br><span class="line">		bitBuf = (bitBuf &lt;&lt; <span class="number">8</span>) | <span class="type">uint32</span>(b)</span><br><span class="line">		bits += <span class="number">8</span></span><br><span class="line">		<span class="keyword">for</span> bits &gt;= MAX_BITS &#123;</span><br><span class="line">			bits -= MAX_BITS</span><br><span class="line">			codes[codeCount] = <span class="type">int32</span>((bitBuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>))</span><br><span class="line">			codeCount++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> bits &gt;= MAX_BITS &#123;</span><br><span class="line">		codes[codeCount] = <span class="type">int32</span>((bitBuf &gt;&gt; (bits - MAX_BITS)) &amp; ((<span class="number">1</span> &lt;&lt; MAX_BITS) - <span class="number">1</span>))</span><br><span class="line">		codeCount++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> codes[:codeCount]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> compress(input []<span class="type">uint8</span>) []<span class="type">uint8</span> &#123;</span><br><span class="line">	codes := <span class="built_in">make</span>([]<span class="type">int32</span>, <span class="built_in">len</span>(input))</span><br><span class="line">	codeCount := <span class="number">0</span></span><br><span class="line">	parent := <span class="type">int32</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> input &#123;</span><br><span class="line">		next := lzw.hashFind(parent, b)</span><br><span class="line">		<span class="keyword">if</span> next != <span class="number">-1</span> &#123;</span><br><span class="line">			parent = next</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			codes[codeCount] = parent</span><br><span class="line">			codeCount++</span><br><span class="line">			lzw.addNode(parent, b)</span><br><span class="line">			parent = lzw.hashFind(<span class="number">0</span>, b)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> parent != <span class="number">0</span> &#123;</span><br><span class="line">		codes[codeCount] = parent</span><br><span class="line">		codeCount++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> lzw.packBits(codes[:codeCount])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解压</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lzw *LZW)</span></span> decompress(input []<span class="type">uint8</span>) []<span class="type">uint8</span> &#123;</span><br><span class="line">	codes := lzw.unpackBits(input)</span><br><span class="line">	out := <span class="built_in">make</span>([]<span class="type">uint8</span>, <span class="built_in">len</span>(input)*<span class="number">4</span>)</span><br><span class="line">	outPos := <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> prevCode <span class="type">int32</span></span><br><span class="line">	<span class="keyword">var</span> firstCh <span class="type">uint8</span></span><br><span class="line">	stack := <span class="built_in">make</span>([]<span class="type">uint8</span>, MAX_SIZE)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, code := <span class="keyword">range</span> codes &#123;</span><br><span class="line">		top := <span class="number">0</span></span><br><span class="line">		cur := code</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> code == lzw.nextCode &amp;&amp; prevCode != <span class="number">0</span> &#123;</span><br><span class="line">			cur = prevCode</span><br><span class="line">			stack[top] = firstCh</span><br><span class="line">			top++</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> code &gt; lzw.nextCode &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">&quot;无效的压缩数据&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> cur != <span class="number">0</span> &#123;</span><br><span class="line">			stack[top] = lzw.dictChar[cur]</span><br><span class="line">			top++</span><br><span class="line">			cur = lzw.dictParent[cur]</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		firstCh = stack[top<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> j := top - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j-- &#123;</span><br><span class="line">			out[outPos] = stack[j]</span><br><span class="line">			outPos++</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> prevCode != <span class="number">0</span> &amp;&amp; lzw.nextCode &lt; MAX_SIZE &#123;</span><br><span class="line">			lzw.addNode(prevCode, firstCh)</span><br><span class="line">		&#125;</span><br><span class="line">		prevCode = code</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> out[:outPos]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析命令行参数</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;------------------------------------\n 示例：lzw.exe -input 您的文件路径，未提供 -input 参数，使用默认 Twilight.txt\n------------------------------------&quot;</span>)</span><br><span class="line">	inputPath := flag.String(<span class="string">&quot;input&quot;</span>, <span class="string">&quot;Twilight.txt&quot;</span>, <span class="string">&quot;输入文件路径&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取文件</span></span><br><span class="line">	input, err := os.ReadFile(*inputPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;读取文件失败: %v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	baseName := strings.TrimSuffix(*inputPath, filepath.Ext(*inputPath))</span><br><span class="line">	compPath := baseName + <span class="string">&quot;.lzw&quot;</span></span><br><span class="line">	decompPath := baseName + <span class="string">&quot;.dec&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 压缩</span></span><br><span class="line">	compressor := NewLZW()</span><br><span class="line">	compressor.dictInit()</span><br><span class="line">	startCompress := time.Now()</span><br><span class="line">	compressed := compressor.compress(input)</span><br><span class="line">	compressTime := time.Since(startCompress)</span><br><span class="line">	<span class="keyword">if</span> err := os.WriteFile(compPath, compressed, <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;写入压缩文件失败: %v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;压缩完成: %d -&gt; %d bytes, 用时 %.3fs, 文件保存路径 %s\n&quot;</span>,</span><br><span class="line">		<span class="built_in">len</span>(input), <span class="built_in">len</span>(compressed), compressTime.Seconds(), compPath)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解压</span></span><br><span class="line">	decompressor := NewLZW()</span><br><span class="line">	decompressor.dictInit()</span><br><span class="line">	startDecompress := time.Now()</span><br><span class="line">	decompressed := decompressor.decompress(compressed)</span><br><span class="line">	decompressTime := time.Since(startDecompress)</span><br><span class="line">	<span class="keyword">if</span> err := os.WriteFile(decompPath, decompressed, <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;写入解压文件失败: %v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;解压完成: %d bytes, 用时 %.3fs\n&quot;</span>,</span><br><span class="line">		<span class="built_in">len</span>(decompressed), decompressTime.Seconds())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(input) != <span class="built_in">len</span>(decompressed) &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;长度不匹配: 原始=%d, 解压=%d\n&quot;</span>, <span class="built_in">len</span>(input), <span class="built_in">len</span>(decompressed))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	diffCount := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(input) &amp;&amp; i &lt; <span class="built_in">len</span>(decompressed); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> input[i] != decompressed[i] &#123;</span><br><span class="line">			diffCount++</span><br><span class="line">			<span class="keyword">if</span> diffCount &lt;= <span class="number">10</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;位置 %d: 原始=%d, 解压=%d\n&quot;</span>, i, input[i], decompressed[i])</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> diffCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;共发现 %d 处差异\n&quot;</span>, diffCount)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;校验通过&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lzw.m</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classdef</span> LZW &lt; handle</span><br><span class="line">    <span class="comment">% LZW 压缩器类</span></span><br><span class="line">    <span class="comment">% 实现了 LZW 压缩算法，支持中文字典</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">properties</span> (Constant)</span><br><span class="line">        MAX_BITS = <span class="number">19</span>;</span><br><span class="line">        MAX_SIZE = <span class="number">2</span>^LZW.MAX_BITS;  <span class="comment">% 524288</span></span><br><span class="line">        HASH_SIZE = <span class="number">2</span>^<span class="number">20</span>;           <span class="comment">% 1048576</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">% 中文字典</span></span><br><span class="line">        CHINESE_DICT = [<span class="string">&#x27;的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动&#x27;</span> ...</span><br><span class="line">            <span class="string">&#x27;方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感见明问力理尔点文几定本公特做外孩相西果走将月十实向声车全信重三机工物气每并别真打太新比才便夫再书部水像眼等体却加电主界门&#x27;</span> ...</span><br><span class="line">            <span class="string">&#x27;利海受听表德少克代员许稜先口由死安写性马光白或住难望教命花结乐色更拉东神记处让母父应直字场平报友关放至张认接告入笑内英军候民岁往何度山觉路带万男边风解叫任金快原吃妈变通师立象数四失满战远格士音轻目条呢&#x27;</span> ...</span><br><span class="line">            <span class="string">&#x27;病始达深完今提求清王化空业思切怎非找片罗钱紶吗语元喜曾离飞科言干流欢约各即指合反题必该论交终林请医晚制球决窢传画保读运及则房早院量苦火布品近坐产答星精视五连司巴奇管类未朋且婚台夜青北队久乎越观落尽形影&#x27;</span> ...</span><br><span class="line">            <span class="string">&#x27;红爸百令周吧识步希亚术留市半热送兴造谈容极随演收首根讲整式取照办强石古华諣拿计您装似足双妻尼转诉米称丽客南领节衣站黑刻统断福城故历惊脸选包紧争另建维绝树系伤示愿持千史谁准联妇纪基买志静阿诗独复痛消社算&#x27;</span> ...</span><br><span class="line">            <span class="string">&#x27;义竟确酒需单治卡幸兰念举仅钟怕共毛句息功官待究跟穿室易游程号居考突皮哪费倒价图具刚脑永歌响商礼细专黄块脚味灵改据般破引食仍存众注笔甚某沉血备习校默务土微娘须试怀料调广蜖苏显赛查密议底列富梦错座参八除跑&#x27;</span>];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">properties</span></span><br><span class="line">        dictParent</span><br><span class="line">        dictChar</span><br><span class="line">        hashParent</span><br><span class="line">        hashChar</span><br><span class="line">        hashVal</span><br><span class="line">        queue</span><br><span class="line">        qHead</span><br><span class="line">        qTail</span><br><span class="line">        nextCode</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">methods</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">LZW</span><span class="params">()</span></span></span><br><span class="line">            <span class="comment">% 构造函数</span></span><br><span class="line">            obj.dictParent = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.MAX_SIZE, <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            obj.dictChar = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.MAX_SIZE, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">            obj.hashParent = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.HASH_SIZE, <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            obj.hashChar = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.HASH_SIZE, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">            obj.hashVal = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.HASH_SIZE, <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            obj.queue = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.MAX_SIZE, <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            obj.qHead = <span class="number">0</span>;</span><br><span class="line">            obj.qTail = <span class="number">0</span>;</span><br><span class="line">            obj.nextCode = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">dictInit</span><span class="params">(obj)</span></span></span><br><span class="line">            <span class="comment">% 初始化字典</span></span><br><span class="line">            obj.hashVal(:) = <span class="number">-1</span>;</span><br><span class="line">            obj.dictParent(:) = <span class="number">-1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% 初始化根节点</span></span><br><span class="line">            obj.dictParent(<span class="number">1</span>) = <span class="number">-1</span>;</span><br><span class="line">            obj.dictChar(<span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">            obj.nextCode = <span class="number">1</span>;</span><br><span class="line">            obj.qHead = <span class="number">0</span>;</span><br><span class="line">            obj.qTail = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% 初始化单字节字符</span></span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">0</span>:<span class="number">255</span></span><br><span class="line">                obj.dictParent(obj.nextCode + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">                obj.dictChar(obj.nextCode + <span class="number">1</span>) = uint8(<span class="built_in">i</span>);</span><br><span class="line">                obj.hashInsert(<span class="number">0</span>, uint8(<span class="built_in">i</span>), obj.nextCode);</span><br><span class="line">                obj.queue(obj.qTail + <span class="number">1</span>) = obj.nextCode;</span><br><span class="line">                obj.qTail = <span class="built_in">mod</span>(obj.qTail + <span class="number">1</span>, LZW.MAX_SIZE);</span><br><span class="line">                obj.nextCode = obj.nextCode + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">% 初始化中文字典</span></span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">length</span>(obj.CHINESE_DICT)</span><br><span class="line">                utf8 = unicode2native(obj.CHINESE_DICT(<span class="built_in">i</span>), <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line">                parent = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:<span class="built_in">length</span>(utf8)</span><br><span class="line">                    next = obj.hashFind(parent, utf8(<span class="built_in">j</span>));</span><br><span class="line">                    <span class="keyword">if</span> next == <span class="number">-1</span></span><br><span class="line">                        next = obj.addNode(parent, utf8(<span class="built_in">j</span>));</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    parent = next;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">pos</span> = <span class="title">hashFunc</span><span class="params">(obj, parent, ch)</span></span></span><br><span class="line">            <span class="comment">% 哈希函数</span></span><br><span class="line">            pos = uint32(<span class="built_in">mod</span>(uint32(parent) * <span class="number">131</span> + uint32(ch), LZW.HASH_SIZE)) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">idx</span> = <span class="title">hashFind</span><span class="params">(obj, parent, ch)</span></span></span><br><span class="line">            <span class="comment">% 哈希查找</span></span><br><span class="line">            pos = obj.hashFunc(parent, ch);</span><br><span class="line">            <span class="keyword">while</span> obj.hashVal(pos) ~= <span class="number">-1</span></span><br><span class="line">                <span class="keyword">if</span> obj.hashParent(pos) == parent &amp;&amp; obj.hashChar(pos) == ch</span><br><span class="line">                    idx = obj.hashVal(pos);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                pos = <span class="built_in">mod</span>(pos, LZW.HASH_SIZE) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            idx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hashInsert</span><span class="params">(obj, parent, ch, idx)</span></span></span><br><span class="line">            <span class="comment">% 哈希插入</span></span><br><span class="line">            pos = obj.hashFunc(parent, ch);</span><br><span class="line">            <span class="keyword">while</span> obj.hashVal(pos) ~= <span class="number">-1</span></span><br><span class="line">                pos = <span class="built_in">mod</span>(pos, LZW.HASH_SIZE) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            obj.hashParent(pos) = parent;</span><br><span class="line">            obj.hashChar(pos) = ch;</span><br><span class="line">            obj.hashVal(pos) = idx;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">idx</span> = <span class="title">addNode</span><span class="params">(obj, parent, ch)</span></span></span><br><span class="line">            <span class="comment">% 添加节点</span></span><br><span class="line">            <span class="keyword">if</span> obj.nextCode &lt; LZW.MAX_SIZE</span><br><span class="line">                idx = obj.nextCode;</span><br><span class="line">                obj.nextCode = obj.nextCode + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                idx = obj.queue(obj.qHead + <span class="number">1</span>);</span><br><span class="line">                obj.qHead = <span class="built_in">mod</span>(obj.qHead + <span class="number">1</span>, LZW.MAX_SIZE);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">% 移除旧映射</span></span><br><span class="line">                oldParent = obj.dictParent(idx + <span class="number">1</span>);</span><br><span class="line">                oldCh = obj.dictChar(idx + <span class="number">1</span>);</span><br><span class="line">                pos = obj.hashFunc(oldParent, oldCh);</span><br><span class="line">                <span class="keyword">while</span> ~(obj.hashParent(pos) == oldParent &amp;&amp; obj.hashChar(pos) == oldCh)</span><br><span class="line">                    pos = <span class="built_in">mod</span>(pos, LZW.HASH_SIZE) + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                obj.hashVal(pos) = <span class="number">-1</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">% 重新哈希</span></span><br><span class="line">                nextPos = <span class="built_in">mod</span>(pos, LZW.HASH_SIZE) + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> obj.hashVal(nextPos) ~= <span class="number">-1</span></span><br><span class="line">                    tp = obj.hashParent(nextPos);</span><br><span class="line">                    tc = obj.hashChar(nextPos);</span><br><span class="line">                    tv = obj.hashVal(nextPos);</span><br><span class="line">                    obj.hashVal(nextPos) = <span class="number">-1</span>;</span><br><span class="line">                    obj.hashInsert(tp, tc, tv);</span><br><span class="line">                    nextPos = <span class="built_in">mod</span>(nextPos, LZW.HASH_SIZE) + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            obj.dictParent(idx + <span class="number">1</span>) = parent;</span><br><span class="line">            obj.dictChar(idx + <span class="number">1</span>) = ch;</span><br><span class="line">            obj.hashInsert(parent, ch, idx);</span><br><span class="line">            obj.queue(obj.qTail + <span class="number">1</span>) = idx;</span><br><span class="line">            obj.qTail = <span class="built_in">mod</span>(obj.qTail + <span class="number">1</span>, LZW.MAX_SIZE);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">out</span> = <span class="title">packBits</span><span class="params">(obj, codes)</span></span></span><br><span class="line">            <span class="comment">% 位流打包</span></span><br><span class="line">            out = <span class="built_in">zeros</span>(<span class="number">1</span>, <span class="built_in">length</span>(codes) * <span class="number">3</span>, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">            outPos = <span class="number">1</span>;</span><br><span class="line">            bitBuf = uint32(<span class="number">0</span>);</span><br><span class="line">            bits = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">length</span>(codes)</span><br><span class="line">                bitBuf = bitor(bitshift(bitBuf, LZW.MAX_BITS), bitand(uint32(codes(<span class="built_in">i</span>)), <span class="number">2</span>^LZW.MAX_BITS - <span class="number">1</span>));</span><br><span class="line">                bits = bits + LZW.MAX_BITS;</span><br><span class="line">                <span class="keyword">while</span> bits &gt;= <span class="number">8</span></span><br><span class="line">                    bits = bits - <span class="number">8</span>;</span><br><span class="line">                    out(outPos) = uint8(bitand(bitshift(bitBuf, -bits), <span class="number">255</span>));</span><br><span class="line">                    outPos = outPos + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> bits &gt; <span class="number">0</span></span><br><span class="line">                out(outPos) = uint8(bitand(bitshift(bitBuf, <span class="number">8</span> - bits), <span class="number">255</span>));</span><br><span class="line">                outPos = outPos + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            out = out(<span class="number">1</span>:outPos<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">codes</span> = <span class="title">unpackBits</span><span class="params">(obj, data)</span></span></span><br><span class="line">            <span class="comment">% 位流拆包</span></span><br><span class="line">            codes = <span class="built_in">zeros</span>(<span class="number">1</span>, <span class="built_in">length</span>(data) * <span class="number">8</span> / LZW.MAX_BITS + <span class="number">1</span>, <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            codeCount = <span class="number">1</span>;</span><br><span class="line">            bitBuf = uint32(<span class="number">0</span>);</span><br><span class="line">            bits = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">length</span>(data)</span><br><span class="line">                bitBuf = bitor(bitshift(bitBuf, <span class="number">8</span>), uint32(data(<span class="built_in">i</span>)));</span><br><span class="line">                bits = bits + <span class="number">8</span>;</span><br><span class="line">                <span class="keyword">while</span> bits &gt;= LZW.MAX_BITS</span><br><span class="line">                    bits = bits - LZW.MAX_BITS;</span><br><span class="line">                    codes(codeCount) = int32(bitand(bitshift(bitBuf, -bits), <span class="number">2</span>^LZW.MAX_BITS - <span class="number">1</span>));</span><br><span class="line">                    codeCount = codeCount + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> bits &gt;= LZW.MAX_BITS</span><br><span class="line">                codes(codeCount) = int32(bitand(bitshift(bitBuf, -(bits - LZW.MAX_BITS)), <span class="number">2</span>^LZW.MAX_BITS - <span class="number">1</span>));</span><br><span class="line">                codeCount = codeCount + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            codes = codes(<span class="number">1</span>:codeCount<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">out</span> = <span class="title">compress</span><span class="params">(obj, input)</span></span></span><br><span class="line">            <span class="comment">% 压缩</span></span><br><span class="line">            codes = <span class="built_in">zeros</span>(<span class="number">1</span>, <span class="built_in">length</span>(input), <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">            codeCount = <span class="number">1</span>;</span><br><span class="line">            parent = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">length</span>(input)</span><br><span class="line">                next = obj.hashFind(parent, input(<span class="built_in">i</span>));</span><br><span class="line">                <span class="keyword">if</span> next ~= <span class="number">-1</span></span><br><span class="line">                    parent = next;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    codes(codeCount) = parent;</span><br><span class="line">                    codeCount = codeCount + <span class="number">1</span>;</span><br><span class="line">                    obj.addNode(parent, input(<span class="built_in">i</span>));</span><br><span class="line">                    parent = obj.hashFind(<span class="number">0</span>, input(<span class="built_in">i</span>));</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> parent ~= <span class="number">0</span></span><br><span class="line">                codes(codeCount) = parent;</span><br><span class="line">                codeCount = codeCount + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            out = obj.packBits(codes(<span class="number">1</span>:codeCount<span class="number">-1</span>));</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">out</span> = <span class="title">decompress</span><span class="params">(obj, input)</span></span></span><br><span class="line">            <span class="comment">% 解压</span></span><br><span class="line">            codes = obj.unpackBits(input);</span><br><span class="line">            out = <span class="built_in">zeros</span>(<span class="number">1</span>, <span class="built_in">length</span>(input) * <span class="number">4</span>, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">            outPos = <span class="number">1</span>;</span><br><span class="line">            prevCode = <span class="number">0</span>;</span><br><span class="line">            firstCh = uint8(<span class="number">0</span>);</span><br><span class="line">            stack = <span class="built_in">zeros</span>(<span class="number">1</span>, LZW.MAX_SIZE, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">length</span>(codes)</span><br><span class="line">                top = <span class="number">1</span>;</span><br><span class="line">                cur = codes(<span class="built_in">i</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> cur == obj.nextCode &amp;&amp; prevCode ~= <span class="number">0</span></span><br><span class="line">                    cur = prevCode;</span><br><span class="line">                    stack(top) = firstCh;</span><br><span class="line">                    top = top + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">elseif</span> cur &gt; obj.nextCode</span><br><span class="line">                    error(<span class="string">&#x27;无效的压缩数据&#x27;</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span> cur ~= <span class="number">0</span></span><br><span class="line">                    stack(top) = obj.dictChar(cur + <span class="number">1</span>);</span><br><span class="line">                    top = top + <span class="number">1</span>;</span><br><span class="line">                    cur = obj.dictParent(cur + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                </span><br><span class="line">                firstCh = stack(top<span class="number">-1</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> <span class="built_in">j</span> = top<span class="number">-1</span>:<span class="number">-1</span>:<span class="number">1</span></span><br><span class="line">                    out(outPos) = stack(<span class="built_in">j</span>);</span><br><span class="line">                    outPos = outPos + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> prevCode ~= <span class="number">0</span> &amp;&amp; obj.nextCode &lt; LZW.MAX_SIZE</span><br><span class="line">                    obj.addNode(prevCode, firstCh);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                prevCode = codes(<span class="built_in">i</span>);</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            out = out(<span class="number">1</span>:outPos<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% 主函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">% 解析命令行参数</span></span><br><span class="line">    fprintf(<span class="string">&#x27;------------------------------------\n&#x27;</span>);</span><br><span class="line">    fprintf(<span class="string">&#x27; 示例：lzw.m 您的文件路径，未提供参数，使用默认 Twilight.txt\n&#x27;</span>);</span><br><span class="line">    fprintf(<span class="string">&#x27;------------------------------------\n&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> nargin &lt; <span class="number">1</span></span><br><span class="line">        inputPath = <span class="string">&#x27;Twilight.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        inputPath = varargin&#123;<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">% 读取文件</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        fid = fopen(inputPath, <span class="string">&#x27;rb&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> fid == <span class="number">-1</span></span><br><span class="line">            error(<span class="string">&#x27;无法打开文件&#x27;</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        input = fread(fid, <span class="string">&#x27;*uint8&#x27;</span>);</span><br><span class="line">        fclose(fid);</span><br><span class="line">    <span class="keyword">catch</span> e</span><br><span class="line">        fprintf(<span class="string">&#x27;读取文件失败: %s\n&#x27;</span>, e.message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    [~, name, ~] = fileparts(inputPath);</span><br><span class="line">    compPath = [name <span class="string">&#x27;.lzw&#x27;</span>];</span><br><span class="line">    decompPath = [name <span class="string">&#x27;.dec&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">% 压缩</span></span><br><span class="line">    compressor = LZW();</span><br><span class="line">    compressor.dictInit();</span><br><span class="line">    tic;</span><br><span class="line">    compressed = compressor.compress(input);</span><br><span class="line">    compressTime = toc;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        fid = fopen(compPath, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> fid == <span class="number">-1</span></span><br><span class="line">            error(<span class="string">&#x27;无法创建压缩文件&#x27;</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        fwrite(fid, compressed, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">        fclose(fid);</span><br><span class="line">    <span class="keyword">catch</span> e</span><br><span class="line">        fprintf(<span class="string">&#x27;写入压缩文件失败: %s\n&#x27;</span>, e.message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    fprintf(<span class="string">&#x27;压缩完成: %d -&gt; %d bytes, 用时 %.3fs, 文件保存路径 %s\n&#x27;</span>, ...</span><br><span class="line">        <span class="built_in">length</span>(input), <span class="built_in">length</span>(compressed), compressTime, compPath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">% 解压</span></span><br><span class="line">    decompressor = LZW();</span><br><span class="line">    decompressor.dictInit();</span><br><span class="line">    tic;</span><br><span class="line">    decompressed = decompressor.decompress(compressed);</span><br><span class="line">    decompressTime = toc;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        fid = fopen(decompPath, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> fid == <span class="number">-1</span></span><br><span class="line">            error(<span class="string">&#x27;无法创建解压文件&#x27;</span>);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        fwrite(fid, decompressed, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">        fclose(fid);</span><br><span class="line">    <span class="keyword">catch</span> e</span><br><span class="line">        fprintf(<span class="string">&#x27;写入解压文件失败: %s\n&#x27;</span>, e.message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    fprintf(<span class="string">&#x27;解压完成: %d bytes, 用时 %.3fs\n&#x27;</span>, ...</span><br><span class="line">        <span class="built_in">length</span>(decompressed), decompressTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">% 校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">length</span>(input) ~= <span class="built_in">length</span>(decompressed)</span><br><span class="line">        fprintf(<span class="string">&#x27;长度不匹配: 原始=%d, 解压=%d\n&#x27;</span>, <span class="built_in">length</span>(input), <span class="built_in">length</span>(decompressed));</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    diffCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">min</span>(<span class="built_in">length</span>(input), <span class="built_in">length</span>(decompressed))</span><br><span class="line">        <span class="keyword">if</span> input(<span class="built_in">i</span>) ~= decompressed(<span class="built_in">i</span>)</span><br><span class="line">            diffCount = diffCount + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> diffCount &lt;= <span class="number">10</span></span><br><span class="line">                fprintf(<span class="string">&#x27;位置 %d: 原始=%d, 解压=%d\n&#x27;</span>, <span class="built_in">i</span>, input(<span class="built_in">i</span>), decompressed(<span class="built_in">i</span>));</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> diffCount &gt; <span class="number">0</span></span><br><span class="line">        fprintf(<span class="string">&#x27;共发现 %d 处差异\n&#x27;</span>, diffCount);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fprintf(<span class="string">&#x27;校验通过\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span> </span><br></pre></td></tr></table></figure>

<h3 id="2-5-2-性能测试"><a href="#2-5-2-性能测试" class="headerlink" title="2.5.2 性能测试"></a>2.5.2 性能测试</h3><p>性能测试包括压缩率测试和压缩速度测试，针对 Python、C、Java、JavaScript 和 Go 五个版本进行评估。测试数据集涵盖三类文本：纯英文小说《The Count of Monte Cristo.txt》、中文小说《三体全集.txt》以及中英混合小说《Twilight.txt》。结果如下：</p>
<table>
<thead>
<tr>
<th align="left">语言</th>
<th>《The Count of Monte Cristo.txt》压缩率</th>
<th>《三体全集.txt》压缩率</th>
<th>《Twilight.txt》压缩率</th>
</tr>
</thead>
<tbody><tr>
<td align="left">C</td>
<td>997113 &#x2F; 2645466 ≈ 37.691%</td>
<td>1058935 &#x2F; 1857417 ≈ 57.011%</td>
<td>625005 &#x2F; 1335182 ≈ 46.810%</td>
</tr>
<tr>
<td align="left">Go</td>
<td>997113 &#x2F; 2645466 ≈ 37.691%</td>
<td>1060219 &#x2F; 1857417 ≈ 57.080%</td>
<td>623694 &#x2F; 1335182 ≈ 46.712%</td>
</tr>
<tr>
<td align="left">Python</td>
<td>997113 &#x2F; 2645466 ≈ 37.691%</td>
<td>1059894 &#x2F; 1857417 ≈ 57.062%</td>
<td>623868 &#x2F; 1335182 ≈ 46.726%</td>
</tr>
<tr>
<td align="left">Java</td>
<td>997113 &#x2F; 2645466 ≈ 37.691%</td>
<td>1060219 &#x2F; 1857417 ≈ 57.080%</td>
<td>623694 &#x2F; 1335182 ≈ 46.712%</td>
</tr>
<tr>
<td align="left">JavaScript</td>
<td>997113 &#x2F; 2645466 ≈ 37.691%</td>
<td>1060219 &#x2F; 1857417 ≈ 57.080%</td>
<td>623694 &#x2F; 1335182 ≈ 46.712%</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.13 压缩率对比</span></center>

<center><img src="https://dstbp.com/data/imgs/posts/lzw/各语言压缩率对比柱状图.png" width="700"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.5 各语言压缩率对比柱状图</span></center>

<br>

<br>

<table>
<thead>
<tr>
<th>语言</th>
<th>《The Count of Monte Cristo.txt》压缩时间（s）</th>
<th>《三体全集.txt》压缩时间（s）</th>
<th>《Twilight.txt》压缩时间（s）</th>
</tr>
</thead>
<tbody><tr>
<td>C</td>
<td>0.075</td>
<td>0.039</td>
<td>0.031</td>
</tr>
<tr>
<td>Python</td>
<td>0.093</td>
<td>0.062</td>
<td>0.076</td>
</tr>
<tr>
<td>Java</td>
<td>0.156</td>
<td>0.140</td>
<td>0.082</td>
</tr>
<tr>
<td>JavaScript</td>
<td>0.114</td>
<td>0.096</td>
<td>0.068</td>
</tr>
<tr>
<td>Go</td>
<td>0.052</td>
<td>0.050</td>
<td>0.026</td>
</tr>
</tbody></table>
<center><span style="font-family:楷体;font-size:14px;">表 2.14 压缩时间对比</span></center>

<center><img src="https://dstbp.com/data/imgs/posts/lzw/各语言压缩时间对比柱状图.png" width="700"></center>

<center><span style="font-family:楷体;font-size:14px;">图 2.6 各语言压缩时间对比柱状图</span></center>

<p>分析结果可知：各语言在三个文本上的压缩率差异很小，几乎一致，对于英文文本压缩率完全相同。至于中英文文本上略有细微差别，Python 在纯中文文本上略低一些。在压缩时间上，C 和 Go 的压缩速度最快，Go 略优于 C，Java 压缩速度最慢，Python 和 JavaScript 表现中等，Python 稍快于 JS。</p>
<h1 id="3-应用"><a href="#3-应用" class="headerlink" title="3. 应用"></a>3. 应用</h1><p>LZW 算法利用了数据内部的重复模式，无需预先知道数据的概率分布，因此算法结构相对简单。像英文文本和数字图像这样的数据，本身就有很强的重复性（比如相邻字符或像素相似），这使得 LZW 压缩效果特别好。由于这种优势，LZW 被广泛应用于图像和文档格式中，比如 GIF 和 TIFF 图像格式，以及早期的 PDF 文件中，用来压缩图像或文字内容。特别是在 GIF 格式中，LZW 现在仍是核心压缩算法。</p>
<h2 id="3-1-在-GIF-图像中的应用"><a href="#3-1-在-GIF-图像中的应用" class="headerlink" title="3.1 在 GIF 图像中的应用"></a>3.1 在 GIF 图像中的应用</h2><h3 id="3-1-1-GIF-简介"><a href="#3-1-1-GIF-简介" class="headerlink" title="3.1.1 GIF 简介"></a>3.1.1 GIF 简介</h3><p>GIF（Graphics Interchange Format，图形交换格式）是一种无损压缩的点阵图像格式，由 CompuServe 于 1987 年推出。由美国在线服务公司 CompuServe 于 1987 年开发。它因体积小、易传输，很快成为早期互联网中最流行的图片格式之一。</p>
<p>GIF 的特点包括：</p>
<ul>
<li>支持动画：可以播放连续画面，实现简单动画效果；</li>
<li>支持透明背景：方便叠加在其他图像上；</li>
<li>采用 LZW 压缩算法：保证压缩效率和速度，同时不损失图像质量；</li>
<li>颜色限制为 256 色：每张图最多只能用 256 种颜色，适合色彩简单且具有大面积单色区域的图像，比如图标、线条画、按钮、表情包等。</li>
</ul>
<p>正因为颜色数量有限，GIF 并不适合用来存储照片或色彩渐变丰富的图像，这些场景下不仅压缩效果差，文件反而更大。尽管现在有了更高效的格式如 WebP 和 AVIF，GIF 仍因其兼容性和无需插件的优势，在表情包和轻量级动画中保持着不可替代的地位。</p>
<h3 id="3-1-2-GIF-文件格式"><a href="#3-1-2-GIF-文件格式" class="headerlink" title="3.1.2 GIF 文件格式"></a>3.1.2 GIF 文件格式</h3><p>一个 GIF 文件由多个部分组成，每一部分都有特定的功能，共同组成一幅静态图或动画。以下是 GIF 文件的基本结构：</p>
<ul>
<li><strong>文件头（GIF Signature）</strong>：告诉系统这是一个 GIF 文件，并标明它使用的版本（比如 GIF87a 或 GIF89a）。</li>
<li><strong>屏幕描述符</strong>：定义整个画布的尺寸（宽高）、颜色深度、背景色等属性。</li>
<li><strong>全局颜色表（可选）</strong>：如果有这部分，它会列出整个 GIF 使用的颜色列表。图像中的颜色都会从这里选，最多 256 种。</li>
<li><strong>图像数据块</strong>：这是最重要的部分，存放实际的图像内容。每个数据块就像动画中的一帧，里面的图像数据已经通过 LZW 算法压缩过。</li>
<li><strong>扩展数据块（可选）</strong>：包含一些额外信息，比如动画控制、注释、透明度设置等。它不是必须的，但对实现动画或特效很有用。</li>
<li><strong>文件尾（GIF Trailer）</strong>：表示文件结束。</li>
</ul>
<p>我们以一个具体的 GIF 文件为例，使用十六进制编辑器（如 010 Editor）进行逐段分析，来直观地说明 GIF 文件的各个组成部分。</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/GIF 文件头部分.png" width="700"></center>

<center><span style="font-family:楷体;font-size:14px;">图 3.1 GIF 文件头部分</span></center>

<center><img src="https://dstbp.com/data/imgs/posts/lzw/GIF 文件数据部分.png" width="700"></center>

<center><span style="font-family:楷体;font-size:14px;">图 3.2 GIF 文件数据部分</span></center>

<ol>
<li><p>文件头（前 6 个字节）：<code>47 49 46 38 39 61</code></p>
<ul>
<li><p>签名（3 字节）：<code>47 49 46</code> → ASCII 对应 “GIF”，说明这是 GIF 文件。</p>
</li>
<li><p>版本号（3 字节）：<code>38 39 61</code> → ASCII 对应 “89a”，表示使用 1989 年修订版（支持动画、透明色等扩展特性）。</p>
</li>
</ul>
</li>
<li><p>逻辑描述块，包括屏幕描述符和全局颜色表（7+N 字节）：</p>
<ul>
<li><p>屏幕尺寸（4 字节）：<code>32 00</code>（宽 50 像素），<code>32 00</code>（高 50 像素）。</p>
</li>
<li><p>标志位（1 字节）：<code>F7</code>（11110111）</p>
<ul>
<li><p>第 7 位：<code>1</code> → 存在全局调色板（Global Color Table）。</p>
</li>
<li><p>第 6-4 位：<code>111</code> → 该字段表示图像调色板中每种原色（红、绿、蓝）所使用的位数，存储值为实际位数减 1。例如，字段值为 7，表示每个基色占 8 位。理论上，图像最多可表示 ${ (2^8)}^3 $  种颜色（即 24 位真彩色）。</p>
</li>
<li><p>第 3 位：<code>0</code> → 表示颜色表的排序方式，值为 1 表示颜色按在图像中出现的频率从高到低排序；值为 0 则表示颜色顺序未作特别排序。</p>
</li>
<li><p>第 2-0 位：<code>111</code> → 全局颜色列表的大小，计算方法是 $2^{n+1}$，其中 $n$ 为这三个 Bit 的十进制数值，这里代表全局颜色表有 $2^{7+1}&#x3D;256$ 种颜色。</p>
</li>
<li><p>背景颜色索引（1 字节）：<code>F0</code> → 全局调色板中索引为 240 的颜色作为背景颜色。</p>
</li>
<li><p>像素宽高比（1 字节）：<code>00</code></p>
</li>
<li><p>全局调色板（256 色，3×256&#x3D;768 字节）：<code>69 6A 68 6C 6C 6C 64 64 64...</code></p>
<p>每个颜色由 RGB 三字节组成：<code>69 6A 68</code> → 深灰色、<code>64 64 64</code> → 暗灰色…</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>扩展块（以 <code>0x21</code> 开头，多个子块）</p>
<ol>
<li><p>应用扩展（Netscape 动画循环次数，关键子块）：<code>21 FF 0B 4E 45 54 53 43 41 50 45 32 2E 30 03 01 00 00 00</code></p>
<ul>
<li><p>扩展标识符：<code>21 FF</code> → 通用扩展块标识（Application Extension）。</p>
</li>
<li><p>块大小：<code>0B</code> → 后续数据长度为 11 字节。</p>
</li>
<li><p>应用标识符：<code>4E 45 54 53 43 41 50 45 32 2E 30</code> → “NETSCAPE2.0”（Netscape 浏览器自定义扩展）。</p>
</li>
<li><p>循环次数：<code>03 01 00 00</code>，第 3、4 字节表示 gif 的循环播放次数，如果是 <code>0x0000</code> 表示无限循环。</p>
</li>
</ul>
</li>
<li><p>图形控制扩展（控制单帧显示效果）：<code>21 F9 04 00 32 00 00 00</code></p>
<ul>
<li><p>扩展标识符：<code>21F9</code> → 图形控制扩展（Graphic Control Extension）。</p>
</li>
<li><p>块大小：<code>04</code> → 后续 4 字节为有效数据。</p>
</li>
<li><p>标志位：<code>00</code> → 该帧未启用透明色（第 6–5 位为 00），处置方式为“无操作”（第 2–0 位为 000），即当前帧显示后不清除，下一帧直接覆盖显示在其上。</p>
</li>
<li><p>延迟时间：<code>32 00</code> → 小端序 <code>0x0032</code>，每帧显示 500 毫秒。</p>
</li>
<li><p>透明颜色索引：<code>00</code>。</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>图像数据块（以 <code>0x2C</code> 开头，单帧图像）</p>
<ul>
<li><p>图像标识符（1 字节）：<code>2C</code>。</p>
</li>
<li><p>图像位置（4 字节，小端序）：<code>00 00 00 00</code> → X&#x3D;0 像素，Y&#x3D;0 像素（图像左上角位于屏幕原点）。</p>
</li>
<li><p>图像大小（4 字节，小端序）：<code>32 00 32 00</code> → 宽度&#x3D;200 像素，高度&#x3D;174 像素（与屏幕尺寸一致，无裁剪或偏移）。</p>
</li>
<li><p>LZW 数据块：<code>08 FF 00 11 08 1C 48 B0 60 82 83 02 A1... FF .... FF ... 00</code></p>
<ul>
<li><p>初始字典大小：<code>08</code>→ 表示 LZW 算法初始编码表大小为 $2^8&#x3D;256$。</p>
</li>
<li><p>压缩数据：LZW 算法生成的编码流，有多个子块构成，子块首字节表示该子块长度（1 字节，<code>1 ≤ n ≤ 255</code>），后跟 n 字节的压缩数据，多个子块依次排列。最后以 <code>00</code> 作为整个LZW 数据块结束符。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>文件结束符（最后 1 字节）：<code>3B</code> → GIF 文件结束标志。</p>
</li>
</ol>
<p>整体结构图如图 3.3 所示：</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/GIF 文件结构图.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 3.3 GIF 文件结构图</span></center>

<h3 id="3-1-3-LZW-压缩"><a href="#3-1-3-LZW-压缩" class="headerlink" title="3.1.3 LZW 压缩"></a>3.1.3 LZW 压缩</h3><p>那么 LZW 对什么数据进行压缩呢？GIF 图像通过全局&#x2F;局部调色板表示颜色，每个像素不直接存储 RGB 值，而是存储一个索引，指向调色板中的颜色。LZW 压缩的对象正是这些<strong>颜色索引值的序列</strong>。在保存为 GIF 格式时，图像像素首先被转换为调色板索引，然后这组索引作为输入数据传入 LZW 编码器进行压缩。压缩后的结果就是写入 GIF 文件中的图像数据部分。</p>
<h1 id="4-联合加密方案"><a href="#4-联合加密方案" class="headerlink" title="4. 联合加密方案"></a>4. 联合加密方案</h1><p>在当今高度重视隐私和网络安全的社会背景下，压缩算法作为一种可逆过程，本身并不具备安全性。一旦压缩数据被获取，就可以被还原为原始内容。因此，如何保护压缩数据的安全性成为一个研究课题。</p>
<p>最直接的方法是“<strong>先压缩，后加密</strong>”，将压缩和加密作为两个独立步骤处理。但这种做法效率较低，尤其在对实时性要求较高的场景中，表现不佳。</p>
<p>为提高处理效率，越来越多的研究聚焦于压缩与加密的融合，即在压缩过程中直接引入加密机制，实现同步压缩与加密。许多学者在这一方向上提出了不同的改进方案，以下将介绍几种典型的 LZW 加密压缩联合方法。</p>
<h2 id="4-1-置乱字典"><a href="#4-1-置乱字典" class="headerlink" title="4.1 置乱字典"></a>4.1 置乱字典</h2><p>这种方法通过对 LZW 字典按特定规则重新排序，实现加密效果。由于字典顺序被打乱，常规的解码器难以预测索引，只有掌握置乱规则的人才能正确还原原始数据。以下以 Zhou<sup>[9]</sup> 等人于 2008 年提出的方法为例：该方法将 LZW 字典构建为二维数组结构，并在压缩过程中不断对字典内容进行置乱，从而实现压缩与加密同步进行。</p>
<h3 id="4-1-1-算法流程"><a href="#4-1-1-算法流程" class="headerlink" title="4.1.1 算法流程"></a>4.1.1 算法流程</h3><p>使用固定编码长度为 b 位的字典，b 是一个偶数，这里选择 b&#x3D;12，即字典大小为 4096。首先创建初始字典，将初始字符通过带密钥的哈希函数随机插入到字典中。在加密压缩过程中，首先对明文执行标准的 LZW 压缩。唯一的区别在于：当需要将新字符串 P+C 添加到字典时，不再顺序插入，而是通过带密钥的哈希函数随机选择一个空位置插入。每次添加之后，对整个字典进行置乱处理。具体做法如下：</p>
<ul>
<li>把字典组织成一个 $ 2^{b&#x2F;2} \times 2^{b&#x2F;2} $ 的二维数组。</li>
<li>列循环移位：奇数列以随机步长 $ c_1 $（$ 0 \le c_1 \le 2^{b&#x2F;2}-1 $）作循环右移，偶数列以随机步长 $ c_2 $（$ 0 \le c_2 \le 2^{b&#x2F;2}-1 $）作循环右移。</li>
<li>行循环移位：奇数行整体循环移位 $ r_1 $，偶数行整体循环移位 $ r_2 $。</li>
</ul>
<p>以 $ b &#x3D; 4, c_1 &#x3D; 2, c_2 &#x3D; 3, r_1 &#x3D; 1, r_2 &#x3D; 2 $ 为例，置乱过程如图 4.1 所示：</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/字典置乱举例.png" width="600"></center>

<center><span style="font-family:楷体;font-size:14px;">图 4.1 字典置乱举例</span></center>

<p>在所有字符完成压缩加密后，解密与解压缩过程依赖相同的密钥来重构与编码时一致的字典顺序。由于插入位置是通过带密钥的哈希函数确定的，未持有密钥的攻击者无法准确还原字典结构，因此无法解密数据。</p>
<p>除此之外，整个算法由包括两部分，除了改进的 LZW 算法外，还有一个密钥调度程序（Key Scheduling Algorithm），其功能就是产生出指定位数密钥流，密钥流一部分来实施安全压缩，另一部分作为掩码用于与结果数据进行异或。算法原理图如图 4.2 所示。</p>
<center><img src="https://dstbp.com/data/imgs/posts/lzw/算法原理图.png" width="500"></center>

<center><span style="font-family:楷体;font-size:14px;">图 4.2 算法原理图</span></center>

<p>接下来我们从两个方面对方案进行分析，首先是方案安全性：</p>
<ul>
<li>哈希函数密钥：采用 128 位密钥，密钥空间为 $ 2^{128} $，满足安全级别要求。</li>
<li>从编码入手暴力破解：若尝试枚举所有可能的字典插入顺序，等价于对 $ 2^{b} $ 个条目的全排列进行穷举，即需要 $ 2^b!&#x3D;4096! $ 次尝试，也具备强安全性。</li>
</ul>
<p>接下来是效率方面，该方案由于字典条目是随机插入和置换的，索引无法递增，只能固定用 b 位编码，相比于原始 LZW 的可变长度编码，效率损失明显。</p>
<h3 id="4-1-2-代码实现"><a href="#4-1-2-代码实现" class="headerlink" title="4.1.2 代码实现"></a>4.1.2 代码实现</h3><p>此处仅展示 Python 的参考实现。哈希函数采用 SHA256，密钥流由 128 位 RC4 流密码生成。通过维护一个空位索引列表，并结合带密钥的哈希函数进行随机选择，实现了在数组中高效且精确地定位可用插入位置。采用字典重置方式进行字典更新。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RC4KeyScheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key: <span class="type">Union</span>[<span class="built_in">bytes</span>, <span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 RC4 密钥调度器（KSA）</span></span><br><span class="line"><span class="string">        :param key: RC4 密钥，必须为 1~256 字节，支持 str 或 bytes</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">            key = key.encode()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">1</span> &lt;= <span class="built_in">len</span>(key) &lt;= <span class="number">256</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;密钥长度必须在 1 到 256 字节之间&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._S = <span class="variable language_">self</span>._ksa(key)  <span class="comment"># 状态向量 S</span></span><br><span class="line">        <span class="variable language_">self</span>._i = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>._j = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_ksa</span>(<span class="params">key: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        执行 Key Scheduling Algorithm（KSA）初始化 S 数组</span></span><br><span class="line"><span class="string">        :param key: 输入密钥</span></span><br><span class="line"><span class="string">        :return: 初始化后的 S 向量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        key_len = <span class="built_in">len</span>(key)</span><br><span class="line">        S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            j = (j + S[i] + key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">        <span class="keyword">return</span> S</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_key_stream</span>(<span class="params">self, length: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用伪随机生成算法（PRGA）生成密钥流</span></span><br><span class="line"><span class="string">        :param length: 所需生成的字节数</span></span><br><span class="line"><span class="string">        :return: 密钥流字节序列（bytes）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> length &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;密钥流长度必须大于 0&quot;</span>)</span><br><span class="line"></span><br><span class="line">        S = <span class="variable language_">self</span>._S[:]</span><br><span class="line">        i, j = <span class="variable language_">self</span>._i, <span class="variable language_">self</span>._j</span><br><span class="line">        stream = <span class="built_in">bytearray</span>(length)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">            i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">            j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">            K = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">            stream[idx] = K</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新生成器状态</span></span><br><span class="line">        <span class="variable language_">self</span>._i = i</span><br><span class="line">        <span class="variable language_">self</span>._j = j</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(stream)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LZW</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key: <span class="built_in">str</span> = <span class="string">&#x27;65691f00-5474-4e16-8256-2e2dc711e67d&#x27;</span>, initial_chars: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">bytes</span>]] = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 LZW 压缩器</span></span><br><span class="line"><span class="string">        :param key: 用于加密置乱的密钥</span></span><br><span class="line"><span class="string">        :param initial_chars: 初始字符集，默认为256个ASCII字符</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.b = <span class="number">10</span></span><br><span class="line">        <span class="variable language_">self</span>.dict_size = <span class="number">1</span> &lt;&lt; <span class="variable language_">self</span>.b           <span class="comment"># 1024条最大字典项</span></span><br><span class="line">        <span class="variable language_">self</span>.matrix_size = <span class="number">1</span> &lt;&lt; (<span class="variable language_">self</span>.b // <span class="number">2</span>)  <span class="comment"># 64x64置乱矩阵</span></span><br><span class="line">        <span class="variable language_">self</span>.initial_chars = initial_chars <span class="keyword">or</span> [<span class="built_in">bytes</span>([i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">        <span class="variable language_">self</span>.key_stream = RC4KeyScheduler(key=key).generate_key_stream(<span class="number">128</span>)</span><br><span class="line">        <span class="variable language_">self</span>.pos_shift = &#123;</span><br><span class="line">            <span class="string">&#x27;c1&#x27;</span>: <span class="variable language_">self</span>.key_stream[<span class="number">0</span>],</span><br><span class="line">            <span class="string">&#x27;c2&#x27;</span>: <span class="variable language_">self</span>.key_stream[<span class="number">1</span>],</span><br><span class="line">            <span class="string">&#x27;r1&#x27;</span>: <span class="variable language_">self</span>.key_stream[<span class="number">2</span>],</span><br><span class="line">            <span class="string">&#x27;r2&#x27;</span>: <span class="variable language_">self</span>.key_stream[<span class="number">3</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_dictionary</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">bytes</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用带密钥哈希初始化字典，避免重复条目</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dictionary = [<span class="literal">None</span>] * <span class="variable language_">self</span>.dict_size</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="variable language_">self</span>.initial_chars:</span><br><span class="line">            pos = <span class="variable language_">self</span>.keyed_hash(c, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.dict_size)</span><br><span class="line">            <span class="keyword">while</span> dictionary[pos] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                pos = (pos + <span class="number">1</span>) % <span class="variable language_">self</span>.dict_size</span><br><span class="line">            dictionary[pos] = c</span><br><span class="line">        <span class="keyword">return</span> dictionary</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_scramble</span>(<span class="params">self, dictionary: <span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">bytes</span>]]</span>) -&gt; <span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">bytes</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用循环移位操作，对字典执行矩阵置乱处理，提高安全性</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        size = <span class="variable language_">self</span>.matrix_size</span><br><span class="line">        <span class="comment"># 重构为二维矩阵</span></span><br><span class="line">        matrix = [dictionary[i * size:(i + <span class="number">1</span>) * size] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 列右移</span></span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">            shift = <span class="variable language_">self</span>.pos_shift[<span class="string">&#x27;c1&#x27;</span>] <span class="keyword">if</span> col % <span class="number">2</span> <span class="keyword">else</span> <span class="variable language_">self</span>.pos_shift[<span class="string">&#x27;c2&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> shift:</span><br><span class="line">                column = [matrix[row][col] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(size)]</span><br><span class="line">                shifted = column[-shift:] + column[:-shift]</span><br><span class="line">                <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">                    matrix[row][col] = shifted[row]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 行右移</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">            shift = <span class="variable language_">self</span>.pos_shift[<span class="string">&#x27;r1&#x27;</span>] <span class="keyword">if</span> row % <span class="number">2</span> <span class="keyword">else</span> <span class="variable language_">self</span>.pos_shift[<span class="string">&#x27;r2&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> shift:</span><br><span class="line">                matrix[row] = matrix[row][-shift:] + matrix[row][:-shift]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 展平成列表返回</span></span><br><span class="line">        <span class="keyword">return</span> [item <span class="keyword">for</span> row <span class="keyword">in</span> matrix <span class="keyword">for</span> item <span class="keyword">in</span> row]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_xor_encrypt</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用密钥流对数据进行按位异或加密/解密（对称）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        ks = <span class="variable language_">self</span>.key_stream[<span class="number">4</span>:]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([b ^ ks[i % <span class="built_in">len</span>(ks)] <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_pack_bits</span>(<span class="params">self, codes: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将整数编码列表压缩成位流（按 self.b 位打包）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        buf, bits, out = <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> code <span class="keyword">in</span> codes:</span><br><span class="line">            buf = (buf &lt;&lt; <span class="variable language_">self</span>.b) | code</span><br><span class="line">            bits += <span class="variable language_">self</span>.b</span><br><span class="line">            <span class="keyword">while</span> bits &gt;= <span class="number">8</span>:</span><br><span class="line">                bits -= <span class="number">8</span></span><br><span class="line">                out.append((buf &gt;&gt; bits) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> bits:</span><br><span class="line">            out.append((buf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将位流还原为整数编码列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        buf, bits, codes = <span class="number">0</span>, <span class="number">0</span>, []</span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            buf = (buf &lt;&lt; <span class="number">8</span>) | byte</span><br><span class="line">            bits += <span class="number">8</span></span><br><span class="line">            <span class="keyword">while</span> bits &gt;= <span class="variable language_">self</span>.b:</span><br><span class="line">                bits -= <span class="variable language_">self</span>.b</span><br><span class="line">                codes.append((buf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; <span class="variable language_">self</span>.b) - <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> codes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对输入字节流执行加密压缩，返回加密后的压缩流</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dictionary = <span class="variable language_">self</span>._init_dictionary()</span><br><span class="line">        output = []</span><br><span class="line">        current = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            next_seq = current + <span class="built_in">bytes</span>([byte])</span><br><span class="line">            <span class="keyword">if</span> next_seq <span class="keyword">in</span> dictionary:</span><br><span class="line">                current = next_seq</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 输出当前匹配序列编号</span></span><br><span class="line">            output.append(dictionary.index(current))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 插入新序列到字典</span></span><br><span class="line">            dictionary = <span class="variable language_">self</span>._insert_sequence(dictionary, next_seq)</span><br><span class="line">            current = <span class="built_in">bytes</span>([byte])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> current:</span><br><span class="line">            output.append(dictionary.index(current))</span><br><span class="line"></span><br><span class="line">        packed = <span class="variable language_">self</span>._pack_bits(output)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._xor_encrypt(packed)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对加密压缩流执行解压缩还原原始字节流</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dictionary = <span class="variable language_">self</span>._init_dictionary()</span><br><span class="line">        codes = <span class="variable language_">self</span>._unpack_bits(<span class="variable language_">self</span>._xor_encrypt(data))</span><br><span class="line">        output = <span class="built_in">bytearray</span>()</span><br><span class="line"></span><br><span class="line">        prev = dictionary[codes[<span class="number">0</span>]]</span><br><span class="line">        <span class="keyword">if</span> prev <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;解码错误，找不到编码: <span class="subst">&#123;codes[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        output += prev</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> code <span class="keyword">in</span> codes[<span class="number">1</span>:]:</span><br><span class="line">            dictionary = <span class="variable language_">self</span>._scramble(dictionary)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果能直接找到解码项</span></span><br><span class="line">            entry = dictionary[code] <span class="keyword">if</span> dictionary[code] <span class="keyword">else</span> prev + <span class="built_in">bytes</span>([prev[<span class="number">0</span>]])</span><br><span class="line">            output += entry</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 插入新序列</span></span><br><span class="line">            new_seq = prev + <span class="built_in">bytes</span>([entry[<span class="number">0</span>]])</span><br><span class="line">            dictionary = <span class="variable language_">self</span>._insert_sequence(dictionary, new_seq)</span><br><span class="line">            prev = entry</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(output)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_insert_sequence</span>(<span class="params">self, dictionary: <span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">bytes</span>]], seq: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">bytes</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        向字典中插入新序列，并在必要时执行置乱和重建</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        empty_indices = [i <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(dictionary) <span class="keyword">if</span> v <span class="keyword">is</span> <span class="literal">None</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> empty_indices:</span><br><span class="line">            dictionary = <span class="variable language_">self</span>._init_dictionary()</span><br><span class="line">            empty_indices = [i <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(dictionary) <span class="keyword">if</span> v <span class="keyword">is</span> <span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line">        pos = <span class="variable language_">self</span>.keyed_hash(seq, <span class="variable language_">self</span>.key, <span class="built_in">len</span>(empty_indices))</span><br><span class="line">        dictionary[empty_indices[pos]] = seq</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._scramble(dictionary)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        压缩文件，并生成 .lzw 文件</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">        compressed = <span class="variable language_">self</span>.compress(data)</span><br><span class="line">        comp_path = os.path.splitext(file_path)[<span class="number">0</span>] + <span class="string">&quot;.lzw&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(comp_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(compressed)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;压缩成功: <span class="subst">&#123;comp_path&#125;</span>, 原始: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> → 压缩后: <span class="subst">&#123;<span class="built_in">len</span>(compressed)&#125;</span> 字节&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> comp_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        解压文件，生成 .dec 文件</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            compressed = f.read()</span><br><span class="line">        data = <span class="variable language_">self</span>.decompress(compressed)</span><br><span class="line">        out_path = os.path.splitext(file_path)[<span class="number">0</span>] + <span class="string">&quot;.dec&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;解压成功: <span class="subst">&#123;out_path&#125;</span>, 解压大小: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> 字节&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> out_path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">keyed_hash</span>(<span class="params">data: <span class="built_in">bytes</span>, key: <span class="built_in">str</span>, mod: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用 SHA256 对 key+data 生成哈希索引</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">            key = key.encode()</span><br><span class="line">        digest = hashlib.sha256(key + data).digest()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(digest, <span class="string">&#x27;big&#x27;</span>) % mod</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 测试用例</span></span><br><span class="line">    key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    lzw = LZW(key=key)  <span class="comment"># 初始化压缩器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># # plaintext = b&quot;ABABABABABAABBABABAABBABABBAABB&quot;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # plaintext = b&#x27;Dantes,&quot; said the shipowner, turning towards the young man,&quot;come this way! &quot;In a moment, sir,&quot; answered Dantes, &quot;and Im with you.&quot;Then calling to the crew, he said -- &quot;Let go!&quot; The anchor was instantly dropped, and the chain ran rattlingthrough the port-hole. Dantes continued at his post in spiteof the presence of the pilot, until this manoeuvre wascompleted, and then he added, &quot;Half-mast the colors, andsquare the yards!&#x27;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # plaintext = b&#x27;They said the flag is flag&#123;65691f00-54744e1682562e2dc711e67d&#125;. Do you get the flag?&#x27;</span></span><br><span class="line">    <span class="comment"># plaintext = b&#x27;T&#x27;</span></span><br><span class="line">    <span class="comment"># # 压缩</span></span><br><span class="line">    <span class="comment"># start_time = time.time()</span></span><br><span class="line">    <span class="comment"># compressed = lzw.compress(plaintext)</span></span><br><span class="line">    <span class="comment"># end_time = time.time()</span></span><br><span class="line">    <span class="comment"># print(f&quot;压缩时间: &#123;end_time - start_time:.3f&#125; 秒&quot;)</span></span><br><span class="line">    <span class="comment"># print(f&quot;压缩编码: &#123;compressed&#125;&quot;)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(f&#x27;&#123;len(plaintext)&#125; -&gt; &#123;len(compressed)&#125;&#x27;)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # 解压缩</span></span><br><span class="line">    <span class="comment"># start_time = time.time()</span></span><br><span class="line">    <span class="comment"># decompressed = lzw.decompress(compressed)</span></span><br><span class="line">    <span class="comment"># end_time = time.time()</span></span><br><span class="line">    <span class="comment"># print(f&quot;解压缩时间: &#123;end_time - start_time:.3f&#125; 秒&quot;)</span></span><br><span class="line">    <span class="comment"># print(f&quot;解压结果: &#123;decompressed&#125;&quot;)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # 验证一致性</span></span><br><span class="line">    <span class="comment"># print(f&quot;加解密一致性: &#123;decompressed == plaintext&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">    file_path = <span class="string">r&quot;D:\TheCountof.txt&quot;</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    com_file_path = lzw.compress_file(file_path)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;压缩时间: <span class="subst">&#123;end_time - start_time:<span class="number">.3</span>f&#125;</span> 秒&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    dec_file_path = lzw.decompress_file(com_file_path)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解压缩时间: <span class="subst">&#123;end_time - start_time:<span class="number">.3</span>f&#125;</span> 秒&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        t1 = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(dec_file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        t2 = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> t1 == t2:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;校验通过&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3-攻击原理"><a href="#4-1-3-攻击原理" class="headerlink" title="4.1.3 攻击原理"></a>4.1.3 攻击原理</h3><p>2011 年，Li<sup>[10]</sup> 等人分析了该方案的算法安全性，指出其存在缺陷，并给出了可行的选择明文攻击和选择密文攻击方法。下面我们将对这一攻击过程进行复现与验证。</p>
<p>Zhou 等人的方法建立在两个安全前提之上：</p>
<ul>
<li>攻击者必须逐个穷举密钥调度程序生成的密钥流中的每个元素；</li>
<li>由于密钥流具有前向依赖性，猜测第 $ i $ 个密钥元素 $ K_i $ 之前，必须先成功猜出前面所有的密钥 $ K_1, K_2, …, K_{i-1} $。</li>
</ul>
<p>但当我们只关注字典中的 “单符号初始条目”（初始字典里预先存好的单个字符，如字母 a、b、c 等），Zhou 的两个假设就不成立了。原因在于单符号条目的特殊性：</p>
<ul>
<li>这些条目在整个加密压缩过程开始前就已经被插入字典，不需要等加密过程中遇到新字符串才添加；</li>
<li>它们在每一步编码结束后会被随机置换位置，但更新是全局同步的，无论明文是什么，所有单符号条目的更新规则只受密钥参数（如 $ c_1,\ c_2,\ r_1,\ r_2 $）控制，和具体的明文无关。</li>
</ul>
<p>因此我们可以发现：如果两个任意明文中第 $ i $ 个被编号的字符串（$ S_i,\ S_i^{\ \prime} $）在字典中是单符号，那么只有当这两个符号完全相同时，他们的密文索引 $ B_i $ 和 $ B_i^{\ \prime} $ 才会相同。</p>
<p>证明：由于初始条目的置换方式仅由密钥决定，且该密钥在整个加密压缩过程中保持不变，因此所有初始单符号的排列顺序在整个过程中都是固定的。设 $ S_i $ 和 $ S_i^{\ \prime} $ 是两个不同明文的第$ i $个被编码字符串，如果它们都是单个符号 $ a $，那么在经历 $ i $ 次编码后，两个对应的字典 $ D_i $ 和 $ D_i^{\ \prime} $ 中，符号 $ a $ 的索引位置是相同的，即 $ D_i(a) &#x3D; D_i^{\ \prime}(a) $。密文索引的计算方式为 $ D_i(a) \oplus K_i $。由于异或操作是可逆的，且密钥流 $ K_i $ 相同，那么只要 $ S_i&#x3D; S_i^{\ \prime} $，就有 $ B_i&#x3D; B_i^{\ \prime} $。反过来说，如果 $ B_i&#x3D; B_i^{\ \prime} $，也可以推出 $ S_i&#x3D; S_i^{\ \prime} $。</p>
<h3 id="4-1-4-攻击方案"><a href="#4-1-4-攻击方案" class="headerlink" title="4.1.4 攻击方案"></a><strong>4.1.4 攻击方案</strong></h3><p>利用上述定理，攻击者可以发起针对单符号条目的<strong>选择明文攻击</strong>，步骤如下：</p>
<ol>
<li><strong>构造明文</strong>：攻击者主动选择大量包含单符号的明文，比如设计 $ n $ 个明文，$ n $ 是字母表的大小，比如英语有 98 个可打印 ASCII 字符，每个明文的结构是单符号的不同排列组合，例如：<ul>
<li>明文 1：先出现字母 1（如 A），然后字母 2（B），依此类推，覆盖所有单符号的组合；</li>
<li>明文 2：类似结构，但起始字母不同（如从 B 开始）；</li>
<li>……</li>
<li>明文 n：覆盖最后一个字母的组合。</li>
</ul>
</li>
<li>**构建查找表（look-up table LUT）：**观察每个单符号对应的密文索引 $ B_i $。由于前面保证 “相同单符号对应相同 $ B_i $，不同单符号对应不同 $ B_i $，攻击者可以记录每个单符号 $ a $ 和其密文索引 $ B_i $ 的对应关系，形成一个查找表 $ LUT_i &#x3D; {(a,\ D_i (a) \oplus K_i)}_{1 \le i \le L} $，其中 $ i $ 是编码步骤，$ L $ 是需要处理的最大密文数量。</li>
<li><strong>破解密文</strong>：当攻击者截获到一个密文索引 $ B_i $ 时，只需检查 $ B_i $ 是否存在于 $ LUT_i $ 中。如果存在，就能直接对应到对应的单符号明文 $ S_i $。</li>
</ol>
<p><strong>选择密文攻击</strong>的思路和之前的“选择明文攻击”类似，但攻击者的操作方向相反，虽然步骤比“选择明文攻击”多（效率低一点），但依然能破解单符号密文。</p>
<p>攻击者的目标仍是识别哪些密文索引对应单符号条目。但因为字典里有些位置是空的（无效条目），攻击者没法直接知道哪些密文对应有效的单符号，所以得逐步试探：</p>
<ol>
<li>先遍历 $ 2^b $ 个第一位密文（覆盖所有可能的 b 位索引，比如 b&#x3D;3 时，有 8 种可能的密文：000、001…111），把这些密文发给解密器，观察哪些密文能解出有效的单符号，记录下来形成第 1 个查找表 LUT1（类似“001→a，010→b…”）。</li>
<li>结合上一个密文，再生成所有可能的 2 位密文，重复操作，形成第 2 个查找表 LUT2（记录第 2 步的密文和单符号对应关系）……</li>
<li>直到生成 L 个查找表（覆盖 L 个步骤），就能知道每个步骤中哪些密文对应哪个单符号。</li>
</ol>
<p><strong>攻击效果：</strong></p>
<p>虽然这种攻击只能直接破解单字符对应的密文（如字母、空格等），但由于单字符在明文中出现频率很高，尤其常见于文本开头，攻击者可以通过查找表“对号入座”，轻松还原这些字符，造成信息泄露。字典越小，单符号出现越频繁，泄露风险越大。尽管攻击对多字符字符串效果较弱，但只要能还原开头部分，就可能暴露关键信息，且结合语言模式还可能进一步推测后续内容。</p>
<p><strong>攻击局限性</strong>：</p>
<ol>
<li><p>攻击效果受限于字典大小和明文特性：理论上，如果字典已存满所有可能的两字符组合（如<code>aa</code>、<code>ab</code>等），LZW 会优先使用这些更长的词条进行编码，导致单字符的密文索引 $ B_i $ 不再出现，使查找表无法继续扩展。但在实际应用中，这种情况极少发生。一方面，自然语言中的两字符组合数量有限，很多组合根本不会出现；另一方面，字典容量通常不足以容纳所有两字符组合。因此，字典“完全覆盖两字符字符串”的情况要么不可能，要么极为罕见。</p>
</li>
<li><p>对图像无效：因为图像中的多符号字符串（比如连续像素组合）长度不固定，且泄露的单个像素无法还原图像结构（比如一个像素的颜色无法推断整幅图的内容），因此该算法可能仍适用于图像加密。</p>
</li>
</ol>
<p><strong>攻击脚本（Python）：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> Zhou_lzw <span class="keyword">import</span> LZW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZhouLZWCPA</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    LZW CPA 攻击解密器类：通过构建查找表实现密文解码</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    BITS_PER_CODE = <span class="number">10</span>  <span class="comment"># 每个 LZW 编码长度（bit）</span></span><br><span class="line">    PAD_CHAR_RANGE = <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>)  <span class="comment"># 填充字符使用的 ASCII 范围（可打印字符）</span></span><br><span class="line">    CHARACTER_TABLE = string.ascii_letters + string.digits + <span class="string">&quot; ,.&#123;&#125;\&quot;\&#x27;-!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, lut_path: Path, lzw_instance: <span class="type">Any</span>, regenerate_lut: <span class="built_in">bool</span> = <span class="literal">False</span>, pad_range: <span class="built_in">range</span> = <span class="built_in">range</span>(<span class="params"><span class="number">0</span>, <span class="number">200</span></span>)</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 ZhouLZWCPA 解密器</span></span><br><span class="line"><span class="string">        :param lut_path: 查找表路径（JSON）</span></span><br><span class="line"><span class="string">        :param lzw_instance: 支持 compress 方法的 LZW 实例</span></span><br><span class="line"><span class="string">        :param regenerate_lut: 是否强制重建查找表</span></span><br><span class="line"><span class="string">        :param pad_range: 查找表构建时使用的填充步长范围</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.lut_path = lut_path</span><br><span class="line">        <span class="variable language_">self</span>.lzw = lzw_instance</span><br><span class="line">        <span class="variable language_">self</span>.regenerate_lut = regenerate_lut</span><br><span class="line">        <span class="variable language_">self</span>.pad_range = pad_range</span><br><span class="line">        <span class="variable language_">self</span>.lut: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将字节流按位解码为整数索引列表（基于固定比特长度）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        result, bitbuf, bits = [], <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            bitbuf = (bitbuf &lt;&lt; <span class="number">8</span>) | byte</span><br><span class="line">            bits += <span class="number">8</span></span><br><span class="line">            <span class="keyword">while</span> bits &gt;= ZhouLZWCPA.BITS_PER_CODE:</span><br><span class="line">                bits -= ZhouLZWCPA.BITS_PER_CODE</span><br><span class="line">                result.append((bitbuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; ZhouLZWCPA.BITS_PER_CODE) - <span class="number">1</span>))</span><br><span class="line">                bitbuf &amp;= (<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_padded_input</span>(<span class="params">self, char: <span class="built_in">str</span>, pad_len: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成指定字符的填充明文字符串</span></span><br><span class="line"><span class="string">        :param char: 明文字符</span></span><br><span class="line"><span class="string">        :param pad_len: 填充长度</span></span><br><span class="line"><span class="string">        :return: 带填充的明文</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        padding, count = [], <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ZhouLZWCPA.PAD_CHAR_RANGE:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(i) <span class="keyword">in</span> char:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            use = <span class="built_in">min</span>(<span class="number">2</span>, pad_len - count)</span><br><span class="line">            padding.append(<span class="built_in">chr</span>(i) * use)</span><br><span class="line">            count += use</span><br><span class="line">            <span class="keyword">if</span> count &gt;= pad_len:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(padding) + char</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_plaintexts</span>(<span class="params">self, pad: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        构造当前 pad 值对应的所有测试明文列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>._generate_padded_input(ch, pad) <span class="keyword">for</span> ch <span class="keyword">in</span> ZhouLZWCPA.CHARACTER_TABLE]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_single_lut</span>(<span class="params">self, pad: <span class="built_in">int</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        构建特定填充步长 pad 下的查找表</span></span><br><span class="line"><span class="string">        :param pad: 当前步长</span></span><br><span class="line"><span class="string">        :return: 查找表 &#123;index: character&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        lut = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> plaintext <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>._generate_plaintexts(pad), desc=<span class="string">f&quot;构建查找表步长: <span class="subst">&#123;pad&#125;</span>&quot;</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                encoded = <span class="variable language_">self</span>.lzw.compress(plaintext.encode())</span><br><span class="line">                index_list = <span class="variable language_">self</span>._unpack_bits(encoded)</span><br><span class="line">                lut[index_list[pad]] = plaintext[pad]  <span class="comment"># 第 pad 个位置字符对应 index</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> lut</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_or_generate_lut</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        加载或生成所有步长的查找表</span></span><br><span class="line"><span class="string">        :return: 是否成功</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.regenerate_lut <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.lut_path.exists():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;开始构建查找表...&quot;</span>)</span><br><span class="line">                <span class="keyword">with</span> ProcessPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">                    results = <span class="built_in">list</span>(executor.<span class="built_in">map</span>(<span class="variable language_">self</span>._build_single_lut, <span class="variable language_">self</span>.pad_range))</span><br><span class="line">                <span class="variable language_">self</span>.lut = &#123;<span class="built_in">str</span>(p): &#123;<span class="built_in">str</span>(k): v <span class="keyword">for</span> k, v <span class="keyword">in</span> d.items()&#125; <span class="keyword">for</span> p, d <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="variable language_">self</span>.pad_range, results)&#125;</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    json.dump(<span class="variable language_">self</span>.lut, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表保存成功: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="variable language_">self</span>.lut = json.load(f)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;成功加载查找表: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表加载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, ciphertext: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用查找表对密文进行解码</span></span><br><span class="line"><span class="string">        :param ciphertext: 密文字节流（经过 LZW 压缩）</span></span><br><span class="line"><span class="string">        :return: 解密后的明文字符串或 None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._load_or_generate_lut():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n开始解密...&quot;</span>)</span><br><span class="line">            decrypted = []</span><br><span class="line">            indices = <span class="variable language_">self</span>._unpack_bits(ciphertext)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> step, idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(indices):</span><br><span class="line">                char = <span class="variable language_">self</span>.lut.get(<span class="built_in">str</span>(step), &#123;&#125;).get(<span class="built_in">str</span>(idx), <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">                decrypted.append(char)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;步骤 <span class="subst">&#123;step:02d&#125;</span>: 索引 <span class="subst">&#123;idx:04d&#125;</span> -&gt; 明文 &#x27;<span class="subst">&#123;char&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            result = <span class="string">&#x27;&#x27;</span>.join(decrypted)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n最终解密结果:&quot;</span>, result)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;解密失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    lut_path = Path(<span class="string">&quot;lut.json&quot;</span>)</span><br><span class="line">    lzw = LZW()  <span class="comment"># 实例化LZW压缩器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化解密器</span></span><br><span class="line">    decryptor = ZhouLZWCPA(</span><br><span class="line">        lut_path=lut_path,</span><br><span class="line">        lzw_instance=lzw,</span><br><span class="line">        regenerate_lut=<span class="literal">True</span>,  <span class="comment"># 首次运行需要生成查找表</span></span><br><span class="line">        pad_range=<span class="built_in">range</span>(<span class="number">0</span>, <span class="number">200</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 待解密的密文（示例）</span></span><br><span class="line">    ciphertext = <span class="string">b&#x27;\x15\x98\xdd\xd2KR\xac\xa9U\xac\xb5\xf15j\x17\xebU\xe9\x13\x89\xee\xa0\xfe \x00d:\xa3\x96\xea&amp;\xef\x1cR\x81\xb5\x95\x98\xa0]\xee\x10\x1b\xc23\xf0\xb4\xe3nB;N\x8f6\xe7w\xb2Q\xc5%\xe3)|\xad\x1b\xa2\x08\xe6\xc3\xf8\t&lt;\xefi\\\xcfb\x110r\xf3\x14\x02\x8e\x15&quot;\x13\xc0\xb0\xeb_r\x1c&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行解密</span></span><br><span class="line">    decrypted = decryptor.decrypt(ciphertext)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> Zhou_lzw <span class="keyword">import</span> LZW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZhouLZWCCA</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    LZW CCA 攻击解密器类：通过构建查找表实现密文解码</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    BITS_PER_CODE = <span class="number">10</span></span><br><span class="line">    PAD_CHAR_RANGE = <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>)</span><br><span class="line">    CHARACTER_TABLE = string.ascii_letters + string.digits + <span class="string">&quot; ,.&#123;&#125;\&quot;\&#x27;-!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, lut_path: Path, lzw_instance, regenerate_lut: <span class="built_in">bool</span> = <span class="literal">False</span>, pad_range: <span class="built_in">range</span> = <span class="built_in">range</span>(<span class="params"><span class="number">0</span>, <span class="number">10</span></span>)</span>):</span><br><span class="line">        <span class="variable language_">self</span>.lut_path = lut_path</span><br><span class="line">        <span class="variable language_">self</span>.lzw = lzw_instance</span><br><span class="line">        <span class="variable language_">self</span>.regenerate_lut = regenerate_lut</span><br><span class="line">        <span class="variable language_">self</span>.pad_range = pad_range</span><br><span class="line">        <span class="variable language_">self</span>.lut: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_pack_bits</span>(<span class="params">codes: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将整数编码列表压缩为字节流&quot;&quot;&quot;</span></span><br><span class="line">        bitbuf = bits = <span class="number">0</span></span><br><span class="line">        out = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> code <span class="keyword">in</span> codes:</span><br><span class="line">            bitbuf = (bitbuf &lt;&lt; ZhouLZWCCA.BITS_PER_CODE) | code</span><br><span class="line">            bits += ZhouLZWCCA.BITS_PER_CODE</span><br><span class="line">            <span class="keyword">while</span> bits &gt;= <span class="number">8</span>:</span><br><span class="line">                bits -= <span class="number">8</span></span><br><span class="line">                out.append((bitbuf &gt;&gt; bits) &amp; <span class="number">0xFF</span>)</span><br><span class="line">                bitbuf &amp;= (<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> bits &gt; <span class="number">0</span>:</span><br><span class="line">            out.append((bitbuf &lt;&lt; (<span class="number">8</span> - bits)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将字节流解码为整数编码列表&quot;&quot;&quot;</span></span><br><span class="line">        codes, bitbuf, bits = [], <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            bitbuf = (bitbuf &lt;&lt; <span class="number">8</span>) | byte</span><br><span class="line">            bits += <span class="number">8</span></span><br><span class="line">            <span class="keyword">while</span> bits &gt;= ZhouLZWCCA.BITS_PER_CODE:</span><br><span class="line">                bits -= ZhouLZWCCA.BITS_PER_CODE</span><br><span class="line">                codes.append((bitbuf &gt;&gt; bits) &amp; ((<span class="number">1</span> &lt;&lt; ZhouLZWCCA.BITS_PER_CODE) - <span class="number">1</span>))</span><br><span class="line">                bitbuf &amp;= (<span class="number">1</span> &lt;&lt; bits) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> codes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_ciphertext</span>(<span class="params">self, target_code: <span class="type">List</span>[<span class="built_in">int</span>], pad_step: <span class="built_in">int</span>, prev_lut: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成带预填充的模拟密文</span></span><br><span class="line"><span class="string">        :param target_code: 当前明文字节对应的编码</span></span><br><span class="line"><span class="string">        :param pad_step: 当前步骤/填充步数</span></span><br><span class="line"><span class="string">        :param prev_lut: 用于构建填充内容的查找表</span></span><br><span class="line"><span class="string">        :return: 模拟密文</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        prefix_codes = []</span><br><span class="line">        <span class="keyword">if</span> prev_lut <span class="keyword">and</span> pad_step:</span><br><span class="line">            prefix_codes = [<span class="built_in">int</span>(<span class="built_in">next</span>(<span class="built_in">iter</span>(entry))) <span class="keyword">for</span> entry <span class="keyword">in</span> prev_lut.values() <span class="keyword">if</span> entry]</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._pack_bits(prefix_codes + target_code)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_construct_test_ciphertexts</span>(<span class="params">self, pad_step: <span class="built_in">int</span>, prev_lut: <span class="type">Optional</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">bytes</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        为当前步骤构造所有候选密文（每个可能字符一次）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>._generate_ciphertext([i], pad_step, prev_lut) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4096</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_lookup_table</span>(<span class="params">self, step: <span class="built_in">int</span>, prev_lut: <span class="type">Optional</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        构造当前 step 的查找表：密文索引 → 明文字符</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        lookup = &#123;&#125;</span><br><span class="line">        test_streams = <span class="variable language_">self</span>._construct_test_ciphertexts(step, prev_lut)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ct <span class="keyword">in</span> test_streams:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                plaintext = <span class="variable language_">self</span>.lzw.decompress(ct).decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">                index_list = <span class="variable language_">self</span>._unpack_bits(ct)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(plaintext) == step + <span class="number">1</span>:</span><br><span class="line">                    ch = plaintext[step]</span><br><span class="line">                    <span class="keyword">if</span> ch <span class="keyword">in</span> <span class="variable language_">self</span>.CHARACTER_TABLE:</span><br><span class="line">                        lookup[index_list[step]] = ch</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lookup</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_or_generate_lut</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        载入现有查找表或按需构建新查找表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.regenerate_lut <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.lut_path.exists():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;正在构建查找表...&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> step <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>.pad_range, desc=<span class="string">f&quot;构建步骤查找表&quot;</span>):</span><br><span class="line">                    step_lut = <span class="variable language_">self</span>._build_lookup_table(step, <span class="variable language_">self</span>.lut)</span><br><span class="line">                    <span class="variable language_">self</span>.lut[<span class="built_in">str</span>(step)] = &#123;<span class="built_in">str</span>(k): v <span class="keyword">for</span> k, v <span class="keyword">in</span> step_lut.items()&#125;</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    json.dump(<span class="variable language_">self</span>.lut, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表保存成功: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="variable language_">self</span>.lut = json.load(f)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表加载成功: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表加载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, ciphertext: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用查找表解密密文</span></span><br><span class="line"><span class="string">        :param ciphertext: 压缩后的密文字节流</span></span><br><span class="line"><span class="string">        :return: 解密出的明文或 None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._load_or_generate_lut():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n开始解密...&quot;</span>)</span><br><span class="line">            result = []</span><br><span class="line">            index_list = <span class="variable language_">self</span>._unpack_bits(ciphertext)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> step, code <span class="keyword">in</span> <span class="built_in">enumerate</span>(index_list):</span><br><span class="line">                ch = <span class="variable language_">self</span>.lut.get(<span class="built_in">str</span>(step), &#123;&#125;).get(<span class="built_in">str</span>(code), <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">                result.append(ch)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;步骤 <span class="subst">&#123;step:02d&#125;</span>: 索引 <span class="subst">&#123;code:04d&#125;</span> → 字符 &#x27;<span class="subst">&#123;ch&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            final_text = <span class="string">&#x27;&#x27;</span>.join(result)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n最终解密结果:&quot;</span>, final_text)</span><br><span class="line">            <span class="keyword">return</span> final_text</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;解密失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 示例调用</span></span><br><span class="line">    lut_path = Path(<span class="string">&quot;lut.json&quot;</span>)</span><br><span class="line">    lzw = LZW()  <span class="comment"># 实例化LZW压缩器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化解密器</span></span><br><span class="line">    decryptor = ZhouLZWCCA(</span><br><span class="line">        lut_path=lut_path,</span><br><span class="line">        lzw_instance=lzw,  <span class="comment"># 需要提供实际的 LZW 实例</span></span><br><span class="line">        regenerate_lut=<span class="literal">True</span>,</span><br><span class="line">        pad_range=<span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行解密</span></span><br><span class="line">    ciphertext = <span class="string">b&#x27;\x15\x98\xdd\xd2KR\xac\xa9U\xac\xb5\xf15j\x17\xebU\xe9\x13\x89\xee\xa0\xfe \x00d:\xa3\x96\xea&amp;\xef\x1cR\x81\xb5\x95\x98\xa0]\xee\x10\x1b\xc23\xf0\xb4\xe3nB;N\x8f6\xe7w\xb2Q\xc5%\xe3)|\xad\x1b\xa2\x08\xe6\xc3\xf8\t&lt;\xefi\\\xcfb\x110r\xf3\x14\x02\x8e\x15&quot;\x13\xc0\xb0\xeb_r\x1c&#x27;</span></span><br><span class="line">    decrypted = decryptor.decrypt(ciphertext)</span><br></pre></td></tr></table></figure>

<h3 id="4-1-5-改进与代价"><a href="#4-1-5-改进与代价" class="headerlink" title="4.1.5 改进与代价"></a>4.1.5 改进与代价</h3><p>该方案核心漏洞是“单符号密文索引 $ B_i $ 不依赖明文”。改进的关键是让算法的行为与明文绑定，破坏这种独立性。有以下几种改进思路：</p>
<ol>
<li>给随机置换增加明文依赖：原来的字典置换参数（$ c_1,\ c_2,\ r_1,\ r_2 $）由流密码生成，与明文无关。改进方法是将这些参数与最后添加的字典条目的哈希值异或，这样置换参数会随之前编码的明文变化。</li>
<li>给随机插入增加明文依赖：原来的新条目插入位置由哈希函数随机选择，hash 函数输入是新字符串，与前向明文无关。改进方法将哈希函数的输入改为“新字符串 + 上一个字典条目的哈希值”，使新条目的插入位置依赖之前编码过的明文。</li>
<li>引入会话初始向量：明文前几个字符没有“之前编码的明文”，完全依赖初始字典，容易泄露。可以在编码前加入一个随机生成的会话初始向量 IV（如 16 字节），并在解密端共享。压缩编码从 IV 开始，使前几个操作依赖不可预测的随机数据，从而增强前缀安全性。</li>
</ol>
<p>那么代价是什么呢？这些改进会带来两个问题：</p>
<ul>
<li>计算量增加：需要额外计算哈希值、异或操作，增加了加密和解密的时间；</li>
<li>编码效率进一步降低：IV 的加入会增加额外的编码数据，虽然不影响内容，但会略微降低压缩比。</li>
</ul>
<h2 id="4-2-随机字典表"><a href="#4-2-随机字典表" class="headerlink" title="4.2 随机字典表"></a>4.2 随机字典表</h2><p>该方法建立多个有相同条目但条目顺序不同的字典，每次压缩时随机选择其中一个字典进行最长匹配，并输出索引。由于相同的字符串在不同字典中的位置不同，只有知道每一步使用的是哪个字典，才能正确解码。这种方法称为 RDT（Randomized Dictionary Table）算法。</p>
<h3 id="4-2-1-算法流程"><a href="#4-2-1-算法流程" class="headerlink" title="4.2.1 算法流程"></a>4.2.1 算法流程</h3><p>为了实现这一点，Xie<sup>[8]</sup> 等人于 2005 年在 LZ78 算法的基础上，提出基于一种具有不同入口序的多字典表编码方法，算法生成一个伪随机字典选择序列作为密钥，该序列由伪随机位生成器（PRBG）生成，仅需一个短小的种子即可驱动。整个过程类似流式加密，但密钥流不是用于异或操作，而是用于控制字典选择。字典的初始化和更新策略大致思路是对字典初始条目进行随机置乱，使用密钥控制置乱过程。新条目插入到随机位置，同时将原位置的条目移至当前字典的末尾，当字典满时，这就等同于用新条目替换字典中的一个随机条目。具体步骤如下：</p>
<ol>
<li>选择一个具有加密效果的安全 PRBG，产生一个 $ r $ 位的种子 $ s $ 作为 RDT 的密钥，并利用 $ s $ 产生密钥流 $ z $。以下所有随机数的生成都由 PRBG 完成。</li>
<li>建立$ E $个具有不同元素顺序的初始化字典，编号依次为 $ 0 $ 至 $ E – 1 $。字典中初始元素顺序是经过随机置乱后的结果，置乱过程根据 $ z $ 采用特定的算法来实现。</li>
<li>生成一个随机数 $ 0 \le d \lt E $，用于从多个字典中随机选取一个进行 LZ78 编码步骤。与 LZW 不同，LZ78 在编码时次输出的是一个二元组 <code>(prefix_index, character)</code>，其中 <code>prefix_index</code> 表示当前最长匹配前缀在字典中的编号（若无前缀则为 0），<code>character</code> 是跟在前缀后的新字符。</li>
<li>按如下步骤将新字符串添加到字典表中：<ol>
<li>将 $ E $ 个字典平均分成两组（每组包含一半字典）。具体做法为先计算所有可能的分法数量，由于分组不区分顺序，总的有效分法数为：$ \frac{1}{2} \cdot C(E, \frac{E}{2}) $，然后生成一个随机数 $ 0 \le c \lt \frac{1}{2}\ C(E, \frac{E}{2}) $，这个数字 c 对应一种具体的分组方式，用于将字典随机划分为两半。</li>
<li>在 $ 0 \sim N-1 $ 范围内生成两个随机数 $ r_1 $ 和 $ r_2 $（$ N $ 为当前字典大小）。</li>
<li>将新字符串插入到前半组所有字典的 $ r_1 $ 位置处，同时将其插入到后半组所有字典的 $ r_2 $ 位置处。并将目标位置的字符串的索引修改为当前字典大小（包含索引 0）的值。</li>
</ol>
</li>
<li>重复步骤 c-d，直到编码完成。</li>
</ol>
<h3 id="4-2-2-代码实现"><a href="#4-2-2-代码实现" class="headerlink" title="4.2.2 代码实现"></a>4.2.2 代码实现</h3><p>这里仅给出 python 的实现，仅作参考。伪随机数生成器使用 RC4 算法；初始字典置乱算法使用 RC4 + Fisher-Yates 算法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span>, <span class="type">List</span>, <span class="type">Tuple</span>, <span class="type">Optional</span>, Iterable</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RC4PRGA</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key: <span class="type">Union</span>[<span class="built_in">bytes</span>, <span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 RC4 伪随机生成器（PRGA），支持字符串或字节串作为密钥</span></span><br><span class="line"><span class="string">        :param key: RC4 密钥，长度不超过 256 字节</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>._original_key = key</span><br><span class="line">        <span class="variable language_">self</span>.seed(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">seed</span>(<span class="params">self, key: <span class="type">Union</span>[<span class="built_in">bytes</span>, <span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重置或设置新的密钥，并初始化状态向量 S、指针 i, j</span></span><br><span class="line"><span class="string">        :param key: 新的 RC4 密钥</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">            key = key.encode()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key) &gt; <span class="number">256</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;RC4 密钥不应超过 256 字节&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.S = <span class="variable language_">self</span>._ksa()</span><br><span class="line">        <span class="variable language_">self</span>.i = <span class="variable language_">self</span>.j = <span class="number">0</span>  <span class="comment"># 指针重置</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_ksa</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Key-Scheduling Algorithm (KSA)：使用密钥初始化 256 字节的状态向量 S</span></span><br><span class="line"><span class="string">        :return: 初始化好的 S 列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        key_len = <span class="built_in">len</span>(<span class="variable language_">self</span>.key)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            j = (j + S[i] + <span class="variable language_">self</span>.key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">        <span class="keyword">return</span> S</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_prga</span>(<span class="params">self, length: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Pseudo-Random Generation Algorithm (PRGA)：生成指定长度的密钥流段</span></span><br><span class="line"><span class="string">        :param length: 请求的字节数</span></span><br><span class="line"><span class="string">        :return: 密钥流字节序列</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        output = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">            <span class="variable language_">self</span>.i = (<span class="variable language_">self</span>.i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="variable language_">self</span>.j = (<span class="variable language_">self</span>.j + <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.i]) &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.i], <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.j] = <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.j], <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.i]</span><br><span class="line">            t = (<span class="variable language_">self</span>.S[<span class="variable language_">self</span>.i] + <span class="variable language_">self</span>.S[<span class="variable language_">self</span>.j]) &amp; <span class="number">0xFF</span></span><br><span class="line">            output.append(<span class="variable language_">self</span>.S[t])</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(output)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_key_stream</span>(<span class="params">self, length: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对外接口：生成指定长度的 RC4 密钥流</span></span><br><span class="line"><span class="string">        :param length: 密钥流长度，必须大于 0</span></span><br><span class="line"><span class="string">        :return: 密钥流（bytes）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> length &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;密钥流长度必须大于0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._prga(length)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_int</span>(<span class="params">self, min_val: <span class="built_in">int</span>, max_val: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成 [min_val, max_val] 范围内的伪随机整数</span></span><br><span class="line"><span class="string">        :param min_val: 最小值（包含）</span></span><br><span class="line"><span class="string">        :param max_val: 最大值（包含）</span></span><br><span class="line"><span class="string">        :return: 随机整数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> min_val &gt; max_val:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;min_val 不能大于 max_val&quot;</span>)</span><br><span class="line">        span = max_val - min_val + <span class="number">1</span></span><br><span class="line">        byte_len = (span.bit_length() + <span class="number">7</span>) // <span class="number">8</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            val = <span class="built_in">int</span>.from_bytes(<span class="variable language_">self</span>._prga(byte_len), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            <span class="comment"># 丢弃超界值以消除偏差</span></span><br><span class="line">            <span class="keyword">if</span> val &lt; span * (<span class="number">256</span> ** byte_len // span):</span><br><span class="line">                <span class="keyword">return</span> min_val + (val % span)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_bytes</span>(<span class="params">self, length: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成指定长度的伪随机字节串</span></span><br><span class="line"><span class="string">        :param length: 字节长度，必须大于 0</span></span><br><span class="line"><span class="string">        :return: 随机字节串</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> length &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;长度必须大于0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._prga(length)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random_hex</span>(<span class="params">self, length: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成指定长度的伪随机十六进制字符串</span></span><br><span class="line"><span class="string">        :param length: 字符长度（每 2 个字符对应 1 字节）</span></span><br><span class="line"><span class="string">        :return: 十六进制字符串</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> length &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;长度必须大于0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._prga((length + <span class="number">1</span>) // <span class="number">2</span>).<span class="built_in">hex</span>()[:length]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sample</span>(<span class="params">self, population: Iterable[<span class="built_in">int</span>], k: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从可迭代整数序列中随机抽取 k 个不重复样本</span></span><br><span class="line"><span class="string">        :param population: 整数序列</span></span><br><span class="line"><span class="string">        :param k: 抽样数量</span></span><br><span class="line"><span class="string">        :return: 长度为 k 的随机样本列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        seq = <span class="built_in">list</span>(population)</span><br><span class="line">        n = <span class="built_in">len</span>(seq)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= k &lt;= n):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;k 必须在 0 到 population 大小之间&quot;</span>)</span><br><span class="line">        <span class="comment"># 部分 Fisher-Yates 洗牌，只生成前 k 项样本</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, n - k - <span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            j = <span class="variable language_">self</span>.random_int(<span class="number">0</span>, i)</span><br><span class="line">            seq[i], seq[j] = seq[j], seq[i]</span><br><span class="line">        <span class="keyword">return</span> seq[n - k:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiDictLZ78</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key: <span class="built_in">str</span> = <span class="string">&#x27;65691f00-5474-4e16-8256-2e2dc711e67d&#x27;</span>,</span></span><br><span class="line"><span class="params">                 E: <span class="built_in">int</span> = <span class="number">4</span>, r: <span class="built_in">int</span> = <span class="number">128</span>, N: <span class="built_in">int</span> = <span class="number">10</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        多字典安全 LZ78 压缩器</span></span><br><span class="line"><span class="string">        :param key: 用于初始化 RC4PRGA 的密钥</span></span><br><span class="line"><span class="string">        :param E: 并行字典数量</span></span><br><span class="line"><span class="string">        :param r: 随机种子流比特长度</span></span><br><span class="line"><span class="string">        :param N: 字典地址位宽，最大字典项数 = 2^N</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.E = E</span><br><span class="line">        <span class="variable language_">self</span>.dict_size = <span class="number">1</span> &lt;&lt; N</span><br><span class="line">        <span class="comment"># RC4PRGA 伪随机发生器，生成初始种子</span></span><br><span class="line">        <span class="variable language_">self</span>.prng = RC4PRGA(key)</span><br><span class="line">        <span class="variable language_">self</span>.seed_key = <span class="variable language_">self</span>.prng.generate_key_stream(r // <span class="number">8</span>)</span><br><span class="line">        <span class="comment"># 预计算字典分组以加速插入逻辑</span></span><br><span class="line">        <span class="variable language_">self</span>._precompute_groupings()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_dictionaries</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        以同一种子重置所有 E 个字典，并将 0-255 字节随机分布到字典中</span></span><br><span class="line"><span class="string">        :return: 字典 ID 到字节列表的映射</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.prng.seed(<span class="variable language_">self</span>.seed_key)</span><br><span class="line">        dicts = &#123;&#125;</span><br><span class="line">        byte_vals = [<span class="built_in">bytes</span>([i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">        <span class="keyword">for</span> d_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.E):</span><br><span class="line">            arr = [<span class="literal">None</span>] * <span class="variable language_">self</span>.dict_size</span><br><span class="line">            indices = <span class="variable language_">self</span>.prng.sample(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">255</span>), <span class="number">254</span>)</span><br><span class="line">            <span class="keyword">for</span> idx, b <span class="keyword">in</span> <span class="built_in">zip</span>(indices, byte_vals):</span><br><span class="line">                arr[idx] = b</span><br><span class="line">            dicts[d_id] = arr</span><br><span class="line">        <span class="keyword">return</span> dicts</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_precompute_groupings</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成所有字典分组对（大小 E/2），保证 a&lt;b 排序并去重</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.groupings = []</span><br><span class="line">        seen = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> combo <span class="keyword">in</span> combinations(<span class="built_in">range</span>(<span class="variable language_">self</span>.E), <span class="variable language_">self</span>.E // <span class="number">2</span>):</span><br><span class="line">            a = <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(combo))</span><br><span class="line">            b = <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(<span class="built_in">set</span>(<span class="built_in">range</span>(<span class="variable language_">self</span>.E)) - <span class="built_in">set</span>(combo)))</span><br><span class="line">            <span class="keyword">if</span> a &lt; b <span class="keyword">and</span> (a, b) <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                <span class="variable language_">self</span>.groupings.append((a, b))</span><br><span class="line">                seen |= &#123;(a, b), (b, a)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_insert_sequence</span>(<span class="params">self, seq: <span class="built_in">bytes</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将新序列插入到所有字典：选择一组 a/b，生成随机位置 r1,r2，</span></span><br><span class="line"><span class="string">        在组 a 使用 r1，在组 b 使用 r2，并用当前末尾保留旧值</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        a, b = <span class="variable language_">self</span>.groupings[<span class="variable language_">self</span>.prng.random_int(<span class="number">0</span>, <span class="built_in">len</span>(<span class="variable language_">self</span>.groupings) - <span class="number">1</span>)]</span><br><span class="line">        cur_len = <span class="built_in">sum</span>(v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">for</span> v <span class="keyword">in</span> <span class="variable language_">self</span>.dicts[<span class="number">0</span>]) + <span class="number">1</span></span><br><span class="line">        r1 = <span class="variable language_">self</span>.prng.random_int(<span class="number">1</span>, cur_len - <span class="number">1</span>)</span><br><span class="line">        r2 = <span class="variable language_">self</span>.prng.random_int(<span class="number">1</span>, cur_len - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> gid <span class="keyword">in</span> a:</span><br><span class="line">            <span class="keyword">if</span> cur_len &lt; <span class="variable language_">self</span>.dict_size:</span><br><span class="line">                <span class="variable language_">self</span>.dicts[gid][cur_len] = <span class="variable language_">self</span>.dicts[gid][r1]</span><br><span class="line">            <span class="variable language_">self</span>.dicts[gid][r1] = seq</span><br><span class="line">        <span class="keyword">for</span> gid <span class="keyword">in</span> b:</span><br><span class="line">            <span class="keyword">if</span> cur_len &lt; <span class="variable language_">self</span>.dict_size:</span><br><span class="line">                <span class="variable language_">self</span>.dicts[gid][cur_len] = <span class="variable language_">self</span>.dicts[gid][r2]</span><br><span class="line">            <span class="variable language_">self</span>.dicts[gid][r2] = seq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        执行压缩并返回打包后的字节流</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.dicts = <span class="variable language_">self</span>._initialize_dictionaries()</span><br><span class="line">        prefix = <span class="string">b&quot;&quot;</span></span><br><span class="line">        output: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]] = []</span><br><span class="line">        d_id = <span class="variable language_">self</span>.prng.random_int(<span class="number">0</span>, <span class="variable language_">self</span>.E - <span class="number">1</span>)</span><br><span class="line">        dict_cur = <span class="variable language_">self</span>.dicts[d_id]</span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            token = prefix + <span class="built_in">bytes</span>([byte])</span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">in</span> dict_cur:</span><br><span class="line">                prefix = token</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                idx = dict_cur.index(prefix) <span class="keyword">if</span> prefix <span class="keyword">in</span> dict_cur <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                output.append((idx, <span class="built_in">bytes</span>([byte])))</span><br><span class="line">                <span class="variable language_">self</span>._insert_sequence(token)</span><br><span class="line">                d_id = <span class="variable language_">self</span>.prng.random_int(<span class="number">0</span>, <span class="variable language_">self</span>.E - <span class="number">1</span>)</span><br><span class="line">                dict_cur = <span class="variable language_">self</span>.dicts[d_id]</span><br><span class="line">                prefix = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> prefix:</span><br><span class="line">            output.append((dict_cur.index(prefix), <span class="string">b&quot;&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._pack_bits(output)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">self, bitstream: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将 compress 打包的字节流还原为原始数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        codes = <span class="variable language_">self</span>._unpack_bits(bitstream)</span><br><span class="line">        <span class="variable language_">self</span>.dicts = <span class="variable language_">self</span>._initialize_dictionaries()</span><br><span class="line">        result = <span class="built_in">bytearray</span>()</span><br><span class="line">        d_id = <span class="variable language_">self</span>.prng.random_int(<span class="number">0</span>, <span class="variable language_">self</span>.E - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> idx, suf <span class="keyword">in</span> codes:</span><br><span class="line">            pref = <span class="variable language_">self</span>.dicts[d_id][idx] <span class="keyword">or</span> <span class="string">b&quot;&quot;</span></span><br><span class="line">            seq = pref + suf</span><br><span class="line">            result += seq</span><br><span class="line">            <span class="variable language_">self</span>._insert_sequence(seq)</span><br><span class="line">            d_id = <span class="variable language_">self</span>.prng.random_int(<span class="number">0</span>, <span class="variable language_">self</span>.E - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        压缩指定文件，生成 .lzw 后缀的压缩文件</span></span><br><span class="line"><span class="string">        :param file_path: 原文件路径</span></span><br><span class="line"><span class="string">        :return: 压缩后文件路径 (.lzw)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">        packed = <span class="variable language_">self</span>.compress(data)</span><br><span class="line">        out_path = file_path + <span class="string">&#x27;.lzw&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(packed)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;压缩完成: <span class="subst">&#123;out_path&#125;</span>, 原始 <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span>B -&gt; 压缩 <span class="subst">&#123;<span class="built_in">len</span>(packed)&#125;</span>B&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> out_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        解压 .lzw 文件，生成 .dec 后缀的解压文件</span></span><br><span class="line"><span class="string">        :param file_path: 压缩文件路径 (.lzw)</span></span><br><span class="line"><span class="string">        :return: 解压后文件路径 (.dec)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            packed = f.read()</span><br><span class="line">        data = <span class="variable language_">self</span>.decompress(packed)</span><br><span class="line">        out_path = file_path + <span class="string">&#x27;.dec&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;解压完成: <span class="subst">&#123;out_path&#125;</span>, 大小 <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span>B&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> out_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_pack_bits</span>(<span class="params">self, pairs: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将 (索引, 后缀) 对打包成二进制流：</span></span><br><span class="line"><span class="string">          1B 长度 L + 4B 大端索引 + LB 后缀</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        buf = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="keyword">for</span> count, val <span class="keyword">in</span> pairs:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= <span class="built_in">len</span>(val) &lt; <span class="number">256</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;val 长度必须在 0-255 之间&quot;</span>)</span><br><span class="line">            buf += struct.pack(<span class="string">&#x27;&gt;B&#x27;</span>, <span class="built_in">len</span>(val))</span><br><span class="line">            buf += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, count)</span><br><span class="line">            buf += val</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(buf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">self, stream: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        按 _pack_bits 格式逐条解析打包数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        res: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]] = []</span><br><span class="line">        offset = <span class="number">0</span></span><br><span class="line">        total = <span class="built_in">len</span>(stream)</span><br><span class="line">        <span class="keyword">while</span> offset + <span class="number">5</span> &lt;= total:</span><br><span class="line">            L = stream[offset]</span><br><span class="line">            count = struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, stream[offset+<span class="number">1</span>:offset+<span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">            offset += <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> offset + L &gt; total:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;val 长度超出剩余字节&quot;</span>)</span><br><span class="line">            val = stream[offset:offset+L]</span><br><span class="line">            offset += L</span><br><span class="line">            res.append((count, val))</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># seed = str(uuid.uuid4())</span></span><br><span class="line">    seed = <span class="string">&#x27;65691f00-5474-4e16-8256-2e2dc711e67d&#x27;</span></span><br><span class="line">    lz78 = MultiDictLZ78(key=seed, E=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plaintext = b&#x27;Dantes,&quot; said the shipowner, turning towards the young man,&quot;come this way! &quot;In a moment, sir,&quot; answered Dantes, &quot;and Im with you.&quot;Then calling to the crew, he said -- &quot;Let go!&quot; The anchor was instantly dropped, and the chain ran rattlingthrough the port-hole. Dantes continued at his post in spiteof the presence of the pilot, until this manoeuvre wascompleted, and then he added, &quot;Half-mast the colors, andsquare the yards!&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># plaintext = b&quot;BABAABRRRA&quot;</span></span><br><span class="line">    plaintext = <span class="string">b&#x27;ABABABAABAAABAAAABABABABABBBABABBABABBABBABABABBBBABABABAAAABABABAABABAABABBABABABBAABBABABABABABABABBABABABABABABABABABABABABABABABABABABABABABABABABABBA&#x27;</span></span><br><span class="line">    <span class="comment"># 压缩并保存上下文</span></span><br><span class="line">    compressed = lz78.compress(plaintext)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;压缩编码: <span class="subst">&#123;compressed&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;原始长度: <span class="subst">&#123;<span class="built_in">len</span>(plaintext)&#125;</span> -&gt; 压缩长度: <span class="subst">&#123;<span class="built_in">len</span>(compressed)&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用上下文解压</span></span><br><span class="line">    decompressed = lz78.decompress(compressed)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解压结果: <span class="subst">&#123;decompressed&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证一致性</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;加解密一致性: <span class="subst">&#123;decompressed == plaintext&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># file_path = r&quot;D:\TheCountof.txt&quot;</span></span><br><span class="line">    <span class="comment"># start_time = time.time()</span></span><br><span class="line">    <span class="comment"># com_file_path = lz78.compress_file(file_path)</span></span><br><span class="line">    <span class="comment"># end_time = time.time()</span></span><br><span class="line">    <span class="comment"># print(f&quot;压缩时间: &#123;end_time - start_time:.3f&#125; 秒&quot;)</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># start_time = time.time()</span></span><br><span class="line">    <span class="comment"># dec_file_path = lz78.decompress_file(com_file_path)</span></span><br><span class="line">    <span class="comment"># end_time = time.time()</span></span><br><span class="line">    <span class="comment"># print(f&quot;解压缩时间: &#123;end_time - start_time:.3f&#125; 秒&quot;)</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># with open(file_path, &quot;rb&quot;) as f:</span></span><br><span class="line">    <span class="comment">#     t1 = f.read()</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># with open(dec_file_path, &quot;rb&quot;) as f:</span></span><br><span class="line">    <span class="comment">#     t2 = f.read()</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># if t1 == t2:</span></span><br><span class="line">    <span class="comment">#     print(&quot;校验通过&quot;)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-攻击方案"><a href="#4-2-3-攻击方案" class="headerlink" title="4.2.3 攻击方案"></a>4.2.3 攻击方案</h3><p>Xie 的方案同样存在可被单字符攻击利用的漏洞。由于每次编码输出前缀索引后，字典的随机选择仅由密钥决定，与明文无关，因此单字符在每次随机选择后的字典中的位置是相对固定的。攻击者可以遍历 n 步随机字典选择路径，构建单字符前缀的查找表，从而还原出部分明文信息，造成信息泄露。</p>
<p><strong>攻击脚本（Python）：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> Xie_LZW <span class="keyword">import</span> MultiDictLZ78</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XieLZ78CPA</span>:</span><br><span class="line">    BITS_PER_CODE = <span class="number">10</span>  <span class="comment"># 每个 LZW 编码长度（bit）</span></span><br><span class="line">    PAD_CHAR_RANGE = [<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>)]  <span class="comment"># 填充字符使用的 ASCII 范围（可打印字符）</span></span><br><span class="line">    CHARACTER_TABLE = string.ascii_letters + string.digits + <span class="string">&quot; ,.&#123;&#125;\&quot;\&#x27;-!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, lut_path: Path, lzw_instance: <span class="type">Any</span>, regenerate_lut: <span class="built_in">bool</span> = <span class="literal">False</span>, pad_range: <span class="built_in">range</span> = <span class="built_in">range</span>(<span class="params"><span class="number">0</span>, <span class="number">200</span></span>)</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 ZhouLZWCPA 解密器</span></span><br><span class="line"><span class="string">        :param lut_path: 查找表路径（JSON）</span></span><br><span class="line"><span class="string">        :param lzw_instance: 支持 compress 方法的 LZW 实例</span></span><br><span class="line"><span class="string">        :param regenerate_lut: 是否强制重建查找表</span></span><br><span class="line"><span class="string">        :param pad_range: 查找表构建时使用的填充步长范围</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.lut_path = lut_path</span><br><span class="line">        <span class="variable language_">self</span>.lzw = lzw_instance</span><br><span class="line">        <span class="variable language_">self</span>.regenerate_lut = regenerate_lut</span><br><span class="line">        <span class="variable language_">self</span>.combinations = [a + b <span class="keyword">for</span> a <span class="keyword">in</span> XieLZ78CPA.PAD_CHAR_RANGE <span class="keyword">for</span> b <span class="keyword">in</span> XieLZ78CPA.PAD_CHAR_RANGE]</span><br><span class="line">        <span class="variable language_">self</span>.pad_range = pad_range</span><br><span class="line">        <span class="variable language_">self</span>.lut: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unpack_bits</span>(<span class="params">stream: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        按 _pack_bits 格式逐条解析打包数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        res: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]] = []</span><br><span class="line">        offset = <span class="number">0</span></span><br><span class="line">        total = <span class="built_in">len</span>(stream)</span><br><span class="line">        <span class="keyword">while</span> offset + <span class="number">5</span> &lt;= total:</span><br><span class="line">            L = stream[offset]</span><br><span class="line">            count = struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, stream[offset + <span class="number">1</span>:offset + <span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">            offset += <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> offset + L &gt; total:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;val 长度超出剩余字节&quot;</span>)</span><br><span class="line">            val = stream[offset:offset + L]</span><br><span class="line">            offset += L</span><br><span class="line">            res.append((count, val))</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_padded_input</span>(<span class="params">self, char: <span class="built_in">str</span>, pad_count: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成指定字符的填充明文字节串</span></span><br><span class="line"><span class="string">        :param char: 明文字节</span></span><br><span class="line"><span class="string">        :param pad_count: 参与填充的字符组数</span></span><br><span class="line"><span class="string">        :return: 带填充的明文字节串</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="variable language_">self</span>.combinations[:pad_count]) + char</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_plaintexts</span>(<span class="params">self, pad: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        构造当前 pad 值对应的所有测试明文列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>._generate_padded_input(ch, pad) <span class="keyword">for</span> ch <span class="keyword">in</span> XieLZ78CPA.CHARACTER_TABLE]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_single_lut</span>(<span class="params">self, pad: <span class="built_in">int</span></span>) -&gt; <span class="type">Dict</span>[<span class="type">Tuple</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        构建特定填充步长 pad 下的查找表</span></span><br><span class="line"><span class="string">        :param pad: 当前步长</span></span><br><span class="line"><span class="string">        :return: 查找表 &#123;index: character&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        lut = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> plaintext <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>._generate_plaintexts(pad), desc=<span class="string">f&quot;构建查找表步长: <span class="subst">&#123;pad&#125;</span>&quot;</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                encoded = <span class="variable language_">self</span>.lzw.compress(plaintext.encode())</span><br><span class="line">                index_list = <span class="variable language_">self</span>._unpack_bits(encoded)</span><br><span class="line">                lut[index_list[pad]] = plaintext[-<span class="number">1</span>]  <span class="comment"># 第 pad 个位置字符对应 index</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> lut</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_or_generate_lut</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        加载或生成所有步长的查找表</span></span><br><span class="line"><span class="string">        :return: 是否成功</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.regenerate_lut <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.lut_path.exists():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;开始构建查找表...&quot;</span>)</span><br><span class="line">                <span class="keyword">with</span> ProcessPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">                    results = <span class="built_in">list</span>(executor.<span class="built_in">map</span>(<span class="variable language_">self</span>._build_single_lut, <span class="variable language_">self</span>.pad_range))</span><br><span class="line">                <span class="variable language_">self</span>.lut = &#123;<span class="built_in">str</span>(p): &#123;<span class="built_in">str</span>(k[<span class="number">0</span>]): v <span class="keyword">for</span> k, v <span class="keyword">in</span> d.items()&#125; <span class="keyword">for</span> p, d <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="variable language_">self</span>.pad_range, results)&#125;</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    json.dump(<span class="variable language_">self</span>.lut, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表保存成功: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.lut_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="variable language_">self</span>.lut = json.load(f)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;成功加载查找表: <span class="subst">&#123;self.lut_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;查找表加载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, ciphertext: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用查找表对密文进行解码</span></span><br><span class="line"><span class="string">        :param ciphertext: 密文字节流（经过 LZW 压缩）</span></span><br><span class="line"><span class="string">        :return: 解密后的明文字符串或 None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._load_or_generate_lut():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n开始解密...&quot;</span>)</span><br><span class="line">            decrypted = []</span><br><span class="line">            indices = <span class="variable language_">self</span>._unpack_bits(ciphertext)</span><br><span class="line">            <span class="built_in">print</span>(indices)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> step, idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(indices):</span><br><span class="line">                char = <span class="variable language_">self</span>.lut.get(<span class="built_in">str</span>(step), &#123;&#125;).get(<span class="built_in">str</span>(idx[<span class="number">0</span>]), <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">                decrypted.append(char + idx[<span class="number">1</span>].decode())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;步骤 <span class="subst">&#123;step:02d&#125;</span>: 索引 <span class="subst">&#123;idx[<span class="number">0</span>]:04d&#125;</span> -&gt; 明文 &#x27;<span class="subst">&#123;char&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            result = <span class="string">&#x27;&#x27;</span>.join(decrypted)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n最终解密结果:&quot;</span>, result)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;解密失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    lut_path = Path(<span class="string">&quot;lut.json&quot;</span>)</span><br><span class="line">    lzw = MultiDictLZ78()  <span class="comment"># 实例化LZW压缩器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化解密器</span></span><br><span class="line">    decryptor = XieLZ78CPA(</span><br><span class="line">        lut_path=lut_path,</span><br><span class="line">        lzw_instance=lzw,</span><br><span class="line">        regenerate_lut=<span class="literal">True</span>,  <span class="comment"># 首次运行需要生成查找表</span></span><br><span class="line">        pad_range=<span class="built_in">range</span>(<span class="number">0</span>, <span class="number">200</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 待解密的密文（示例）</span></span><br><span class="line">    ciphertext = <span class="string">b&#x27;\x01\x00\x00\x00\x08a\x01\x00\x00\x00\xc8t\x01\x00\x00\x00rs\x01\x00\x00\x00\xd3&quot;\x01\x00\x00\x00\xd8s\x01\x00\x00\x00\xeei\x01\x00\x00\x00f \x01\x00\x00\x00\xb0h\x01\x00\x00\x00\x81 \x01\x00\x00\x00Hh\x01\x00\x00\x00\x9dp\x01\x00\x00\x01\x06w\x01\x00\x00\x007e\x01\x00\x00\x008,\x01\x00\x00\x00\x0bt\x01\x00\x00\x00\xb9r\x01\x00\x00\x00\xc8i\x01\x00\x00\x00\xc8g\x01\x00\x00\x00\x1do\x01\x00\x00\x00\x12a\x01\x00\x00\x00Hd\x01\x00\x00\x00H \x01\x00\x00\x00ke\x01\x00\x00\x00\xcay\x01\x00\x00\x01\x06u\x01\x00\x00\x00\&#x27; \x01\x00\x00\x00\\a\x01\x00\x00\x007,\x01\x00\x00\x00\xd9c\x01\x00\x00\x00\x18m\x01\x00\x00\x00\x95t\x01\x00\x00\x00\ni\x01\x00\x00\x00\xc9w\x01\x00\x00\x00\xe0y\x01\x00\x00\x00\r \x01\x00\x00\x00_I\x01\x00\x00\x00\xc8 \x01\x00\x00\x00\xab \x01\x00\x00\x00\xd5o\x01\x00\x00\x00\xd5e\x01\x00\x00\x00\x9b,\x01\x00\x00\x00\xcbi\x01\x00\x00\x00\xae&quot;\x01\x00\x00\x00\xd8a\x01\x00\x00\x00\xfes\x01\x00\x00\x00\x89e\x01\x00\x00\x00/e\x01\x00\x00\x00VD\x01\x00\x00\x00\xeen\x01\x00\x00\x00\x91e\x01\x00\x00\x01+,\x01\x00\x00\x00\xca&quot;\x01\x00\x00\x00\xcdd\x01\x00\x00\x00\x8bI\x01\x00\x00\x00\xd5 \x01\x00\x00\x01\x00i\x01\x00\x00\x00\xaf \x01\x00\x00\x01&amp;o\x01\x00\x00\x01\x14.\x01\x00\x00\x00_T\x01\x00\x00\x00\xe7e\x01\x00\x00\x00\xd3c\x01\x00\x00\x00\xabl\x01\x00\x00\x00\xb6i\x01\x00\x00\x00\x8dt\x01\x00\x00\x00\x1a \x01\x00\x00\x00\xc3 \x01\x00\x00\x00Pr\x01\x00\x00\x01\x07w\x01\x00\x00\x01% \x01\x00\x00\x00\x0e \x01\x00\x00\x01\x11a\x01\x00\x00\x01\&#x27;d\x01\x00\x00\x00\xd8-\x01\x00\x00\x00\xf5 \x01\x00\x00\x00_L\x01\x00\x00\x01\x07t\x01\x00\x00\x01Cg\x01\x00\x00\x00\x18!\x01\x00\x00\x00r \x01\x00\x00\x00\xe0h\x01\x00\x00\x00\x95a\x01\x00\x00\x00\xfec\x01\x00\x00\x00\xd5o\x01\x00\x00\x01\x06 \x01\x00\x00\x01&gt;s\x01\x00\x00\x01Ci\x01\x00\x00\x01?t\x01\x00\x00\x00\xcdt\x01\x00\x00\x01My\x01\x00\x00\x00\xd8d\x01\x00\x00\x00/o\x01\x00\x00\x00\xd1p\x01\x00\x00\x00\x81d\x01\x00\x00\x00\x1ba\x01\x00\x00\x007d\x01\x00\x00\x01Lh\x01\x00\x00\x00\x95c\x01\x00\x00\x01Ua\x01\x00\x00\x01\x1bn\x01\x00\x00\x00\xd8r\x01\x00\x00\x00\x02 \x01\x00\x00\x01\x06a\x01\x00\x00\x00\x80t\x01\x00\x00\x00$n\x01\x00\x00\x00Pt\x01\x00\x00\x005r\x01\x00\x00\x00\xa5g\x01\x00\x00\x01U \x01\x00\x00\x01Op\x01\x00\x00\x00\x18r\x01\x00\x00\x00\xd2-\x01\x00\x00\x00\x8el\x01\x00\x00\x00r.\x01\x00\x00\x00\xcaD\x01\x00\x00\x01Xe\x01\x00\x00\x00\xc9c\x01\x00\x00\x01\x1cn\x01\x00\x00\x00\x80i\x01\x00\x00\x007u\x01\x00\x00\x00&quot; \x01\x00\x00\x00\xabt\x01\x00\x00\x00\xd8h\x01\x00\x00\x01\x1es\x01\x00\x00\x00\x0bp\x01\x00\x00\x00\x1as\x01\x00\x00\x00\x80 \x01\x00\x00\x015 \x01\x00\x00\x009p\x01\x00\x00\x01\&#x27;t\x01\x00\x00\x00ro\x01\x00\x00\x01@ \x01\x00\x00\x01Zr\x01\x00\x00\x005e\x01\x00\x00\x01%e\x01\x00\x00\x00\xd8o\x01\x00\x00\x00\xd2t\x01\x00\x00\x00op\x01\x00\x00\x01jl\x01\x00\x00\x00\x1at\x01\x00\x00\x00\xafu\x01\x00\x00\x00\x9bi\x01\x00\x00\x01M \x01\x00\x00\x010i\x01\x00\x00\x01Cm\x01\x00\x00\x00\xcdo\x01\x00\x00\x00ru\x01\x00\x00\x00wr\x01\x00\x00\x01Yw\x01\x00\x00\x00\xees\x01\x00\x00\x00\xbeo\x01\x00\x00\x00\xd5p\x01\x00\x00\x00\xd9e\x01\x00\x00\x01\x11d\x01\x00\x00\x00\xd0n\x01\x00\x00\x01vt\x01\x00\x00\x00mn\x01\x00\x00\x00\xdbe\x01\x00\x00\x00_d\x01\x00\x00\x00\xace\x01\x00\x00\x01\x89,\x01\x00\x00\x01\x08H\x01\x00\x00\x00\xe4f\x01\x00\x00\x00&gt;m\x01\x00\x00\x00it\x01\x00\x00\x00%e\x01\x00\x00\x00\xd8c\x01\x00\x00\x00\x18l\x01\x00\x00\x00Ks\x01\x00\x00\x01\x8bd\x01\x00\x00\x01\x98q\x01\x00\x00\x01`a\x01\x00\x00\x010 \x01\x00\x00\x01\x7fy\x01\x00\x00\x00\xabr\x01\x00\x00\x00\xacs\x00\x00\x00\x00\r&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行解密</span></span><br><span class="line">    decrypted = decryptor.decrypt(ciphertext)</span><br></pre></td></tr></table></figure>

<h2 id="4-3-其他方案"><a href="#4-3-其他方案" class="headerlink" title="4.3 其他方案"></a>4.3 其他方案</h2><p>除了前述方法，LZW 的联合压缩加密还有许多其他研究。例如，Hermassi<sup>[11]</sup> 等人利用混沌映射生成密钥流，动态更新 Huffman 树，使得同一符号可以对应多个等长但不同的编码，提高了安全性；Liu<sup>[12]</sup> 等人则提出了一种改进的 Huffman 树突变机制，通过仅修改内结点，避免了每次突变后对整棵树重新编码的开销。</p>
<p>由于篇幅有限，这里不再逐一展开。如果有小伙伴对方法感兴趣，后续我会专门写一篇文章进行深入讲解。</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h1><p>目前 LZW 算法的研究主要集中在两个方向：</p>
<p>一是压缩性能的优化。现有很多改进方案要么压缩速度快但压缩率低，要么压缩率有所提升但处理速度下降，很难两者兼顾。</p>
<p>二是压缩与加密的结合。目前的联合加密方案也普遍存在效率与安全难以兼顾的问题，比如：</p>
<ul>
<li>使用软件生成的伪随机数种子并存储在非易失性存储器（NVM）中，容易被攻击者窃取；</li>
<li>多字典方案虽然增加了安全性，但占用大量内存；</li>
<li>使用复杂数学模型打乱条目顺序会显著增加计算负担。</li>
</ul>
<p>如何在保证安全的前提下，实现高效压缩，仍是 LZW 研究中的一个重要难题。</p>
<br>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><strong>参考资料：</strong></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Lempel%E2%80%93Ziv%E2%80%93Welch">Wiki: Lempel–Ziv–Welch</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000011425787">LZW压缩算法原理解析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ZXYloveFR/p/3947974.html">可能是最通俗的Lempel-Ziv-Welch (LZW)无损压缩算法详述</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d4db7e0e028a">庖丁解牛：GIF</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/fqe808mycqc0fb8u2dsx">你真的了解 gif 吗？分析 gif 文件和一些奇怪的 gif 特性</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/655933856">深入浅出 GIF</a></p>
<p><a target="_blank" rel="noopener" href="https://succlz123.wordpress.com/2017/12/20/gif-codec-lzw-compression-algorithm/">GIF Codec – LZW Compression Algorithm 12月 20 2017 LZW算法</a></p>
<br>

<p><strong>参考文献：</strong></p>
<p>[1] 徐秉铮,吴立忠,Victor,等. 中文文本压缩的LZW算法[J]. 华南理工大学学报（自然科学版）,1989,17(3): 1-9.</p>
<p>[2] 华强. 中西文文本压缩的LZWCH算法[J]. 计算机工程与应用,1999,(3): 22-23,35.</p>
<p>[3] 陈庆辉,陈小松,韩德良. 中文文本压缩的LZW算法[J]. 计算机工程与应用,2014,(3): 112-116.</p>
<p>[4] 武彦霞. 基于LZW字典压缩算法的改进研究[D]. 江苏科技大学,2024.</p>
<p>[5] 肖志文,陈伟,梁久祯,等. 基于LZW算法的中文文本压缩算法[C]&#x2F;&#x2F;2007北京地区高校研究生学术交流会通信与信息技术会议. 2008-01.</p>
<p>[6] 王安. 基于LZW压缩算法的数字图像加密研究[D]. 重庆大学,2013.</p>
<p>[7] 成小勇. LZW数据压缩的改进与加密研究[D]. 东南大学,2022.</p>
<p>[8] Dahua Xie, C.-C. Jay Kuo. Secure Lempel-Ziv Compression with Embedded Encryption[J]. Proc. SPIE, 2005, 5681:318-327.</p>
<p>[9] Jiantao Zhou, Oscar C. Au, Xiaopeng Fan and P. Hon-Wah Wong. Secure Lempel-Ziv-Welch (LZW) algorithm with random dictionary insertion and permutation[C] in Proceedings of 2008 IEEE International Conference on Multimedia and Expo (ICME&#96;2008), 2008, 245-248.</p>
<p>[10] Shujun Li, Chengqing Li, J. C.‑C. Kuo. On the security of a secure Lempel–Ziv–Welch (LZW) algorithm[C]&#x2F;&#x2F;Proc. 2011 IEEE Int. Conf. on Multimedia and Expo (ICME), Barcelona, Spain, 2011: 1–5.</p>
<p>[11] Hermassi H, Rhouma R, Belghith S. Joint compression and encryption using chaotically mutated Huffman trees[J]. Communications in Nonlinear Science &amp; Numerical Simulation, 2010, 15(10): 2987-2999.</p>
<p>[12] Liu Y, Li B, Zhang Y, et al. A Huffman-Based Joint Compression and Encryption Scheme for Secure Data Storage Using Physical Unclonable Functions[J]. Electronics, 2021, 10(11): 1267.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>[信息编码] LZW 压缩算法</p><p><a href="http://dstbp.com/2025/05/14/lzw/">http://dstbp.com/2025/05/14/lzw/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>DSTBP</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-05-14</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-06-24</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/alipay_qrcode.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wechat_qrcode.jpg" alt="微信"></span></a></div></div></div><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/06/24/hello-world/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">欢迎来到「微澜尘寰的雾岛」</span></a></div></nav></div><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content twikoo" id="twikoo"></div><script src="/js/imaegoo/twikoo/1.6.41/twikoo.min.js"></script><script>twikoo.init({
            envId: 'https://twikoo.dstbp.com',
            
            lang: "zh-CN",
            onCommentLoaded: function () {
              var commentContents = document.getElementsByClassName('tk-content');
              for (var i = 0; i < commentContents.length; i++) {
                var commentItem = commentContents[i];
                var imgEls = commentItem.getElementsByTagName('img');
                if (imgEls.length > 0) {
                  for (var j = 0; j < imgEls.length; j++) {
                    var imgEl = imgEls[j];
                    var aEl = document.createElement('a');
                    aEl.setAttribute('class', 'tk-lg-link');
                    aEl.setAttribute('href', imgEl.getAttribute('src'));
                    aEl.setAttribute('data-src', imgEl.getAttribute('src'));
                    aEl.appendChild(imgEl.cloneNode(false));
                    imgEl.parentNode.insertBefore(aEl, imgEl.nextSibling);
                    imgEl.remove();
                  }
                  if (typeof $.fn.lightGallery === 'function') {
                    $(commentItem).lightGallery({
                      selector: '.tk-lg-link'
                    });
                  }
                }
              }
            }
        });</script></div></div></div><style>.column.column-left,.column.column-right{display:none}</style><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/avatar.png" alt="DSTBP"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">DSTBP</p><p class="is-size-6 is-block">r0xanne</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Elliðaey island. Iceland.</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">1</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/dstbp" target="_blank" rel="me noopener" id="widget-follow">GitHub</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Home" href="https://dstbp.net"><i class="fas fa-home"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Stackexchange" href="https://crypto.stackexchange.com/users/112358/dstbp"><i class="fab fa-stack-exchange"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Mail" href="mailto:TaddeoWang123@gmail.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget"><div class="card-content"><div class="media" style="overflow: hidden; align-items: center"><div class="media-left"><figure class="image is-96x96"><img src="/images/weixin/qrcode.jpg" alt="微信二维码"></figure></div><div class="media-content"><div id="weixin-search-logo"></div><div class="control has-icons-left" id="weixin-search-text"><input class="input" readonly value="三两黑白" onfocus="this.select()"><span class="icon is-small is-left"><i class="fas fa-search"></i></span></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">2025 年 6 月</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/05/"><span class="level-start"><span class="level-item">2025 年 5 月</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-引言"><span class="level-left"><span class="level-item">1</span><span class="level-item">1. 引言</span></span></a></li><li><a class="level is-mobile" href="#2-原理"><span class="level-left"><span class="level-item">2</span><span class="level-item">2. 原理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-示例"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">2.1 示例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-1-编号的映射"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">2.1.1 编号的映射</span></span></a></li><li><a class="level is-mobile" href="#2-1-2-字典的自解释"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">2.1.2 字典的自解释</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-2-算法详解"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">2.2 算法详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-2-1-编码算法"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">2.2.1 编码算法</span></span></a></li><li><a class="level is-mobile" href="#2-2-2-解码算法"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">2.2.2 解码算法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-3-中文-LZW"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">2.3 中文 LZW</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-3-1-挑战与研究现状"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">2.3.1 挑战与研究现状</span></span></a></li><li><a class="level is-mobile" href="#2-3-2-详细算法"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">2.3.2 详细算法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-4-改进方案"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">2.4 改进方案</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-4-1-编码方式"><span class="level-left"><span class="level-item">2.4.1</span><span class="level-item">2.4.1 编码方式</span></span></a></li><li><a class="level is-mobile" href="#2-4-2-字典大小"><span class="level-left"><span class="level-item">2.4.2</span><span class="level-item">2.4.2 字典大小</span></span></a></li><li><a class="level is-mobile" href="#2-4-3-搜索方式"><span class="level-left"><span class="level-item">2.4.3</span><span class="level-item">2.4.3 搜索方式</span></span></a></li><li><a class="level is-mobile" href="#2-4-4-存储结构"><span class="level-left"><span class="level-item">2.4.4</span><span class="level-item">2.4.4 存储结构</span></span></a></li><li><a class="level is-mobile" href="#2-4-5-字典更新策略"><span class="level-left"><span class="level-item">2.4.5</span><span class="level-item">2.4.5 字典更新策略</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-5-代码实现"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">2.5 代码实现</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-5-1-代码源码"><span class="level-left"><span class="level-item">2.5.1</span><span class="level-item">2.5.1 代码源码</span></span></a></li><li><a class="level is-mobile" href="#2-5-2-性能测试"><span class="level-left"><span class="level-item">2.5.2</span><span class="level-item">2.5.2 性能测试</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#3-应用"><span class="level-left"><span class="level-item">3</span><span class="level-item">3. 应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-在-GIF-图像中的应用"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">3.1 在 GIF 图像中的应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-1-GIF-简介"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">3.1.1 GIF 简介</span></span></a></li><li><a class="level is-mobile" href="#3-1-2-GIF-文件格式"><span class="level-left"><span class="level-item">3.1.2</span><span class="level-item">3.1.2 GIF 文件格式</span></span></a></li><li><a class="level is-mobile" href="#3-1-3-LZW-压缩"><span class="level-left"><span class="level-item">3.1.3</span><span class="level-item">3.1.3 LZW 压缩</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#4-联合加密方案"><span class="level-left"><span class="level-item">4</span><span class="level-item">4. 联合加密方案</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-置乱字典"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">4.1 置乱字典</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-1-算法流程"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">4.1.1 算法流程</span></span></a></li><li><a class="level is-mobile" href="#4-1-2-代码实现"><span class="level-left"><span class="level-item">4.1.2</span><span class="level-item">4.1.2 代码实现</span></span></a></li><li><a class="level is-mobile" href="#4-1-3-攻击原理"><span class="level-left"><span class="level-item">4.1.3</span><span class="level-item">4.1.3 攻击原理</span></span></a></li><li><a class="level is-mobile" href="#4-1-4-攻击方案"><span class="level-left"><span class="level-item">4.1.4</span><span class="level-item">4.1.4 攻击方案</span></span></a></li><li><a class="level is-mobile" href="#4-1-5-改进与代价"><span class="level-left"><span class="level-item">4.1.5</span><span class="level-item">4.1.5 改进与代价</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-2-随机字典表"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">4.2 随机字典表</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-2-1-算法流程"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">4.2.1 算法流程</span></span></a></li><li><a class="level is-mobile" href="#4-2-2-代码实现"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">4.2.2 代码实现</span></span></a></li><li><a class="level is-mobile" href="#4-2-3-攻击方案"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">4.2.3 攻击方案</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-3-其他方案"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">4.3 其他方案</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-总结"><span class="level-left"><span class="level-item">5</span><span class="level-item">5. 总结</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">6</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-24T00:50:16.618Z">2025-06-24</time></p><p class="title"><a href="/2025/06/24/hello-world/">欢迎来到「微澜尘寰的雾岛」</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/14/lzw/"><img src="https://dstbp.com/data/imgs/posts/lzw/Thumbnail.png" alt="[信息编码] LZW 压缩算法"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-14T07:10:43.000Z">2025-05-14</time></p><p class="title"><a href="/2025/05/14/lzw/">[信息编码] LZW 压缩算法</a></p><p class="categories"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a> / <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/%E4%BF%A1%E6%81%AF%E7%BC%96%E7%A0%81/">信息编码</a></p></div></article></div></div><div class="card widget" id="twikoo-new"><div class="card-content"><div class="menu"><h3 class="menu-label">最新评论</h3><script>window.twikooEnvId = 'https://twikoo.dstbp.com';</script><div class="twikoo-new-container"></div></div></div></div></div><style>.column.column-left,.column.column-right{display:block}</style></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="/images/logo.jpg" alt="DSTBP Blog" height="28"><img class="logo-img-dark" src="/images/logo-dark.jpg" alt="DSTBP Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 DSTBP</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/imaegoo/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">总访问量&nbsp;<span id="busuanzi_value_site_pv">-</span>&nbsp;次&nbsp;&nbsp;总访客数&nbsp;<span id="busuanzi_value_site_uv">-</span>&nbsp;人</span></p><p class="is-size-7">版权说明：本网站所有内容版权归属 DSTBP，仅限网友与自己学习交流，如有侵权，请<a href="/message" target="_blank" rel="noreferrer noopener">留言</a>，管理员立即处理<br/><a href="https://beian.miit.gov.cn" target="_blank" rel="noreferrer noopener">萌 ICP 备 20211214 号-8</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/deed.zh"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="/js/imaegoo/instant.page/5.1.1/instantpage.min.js" type="module"></script><script src="/js/imaegoo/jquery/3.3.1/dist/jquery.min.js"></script><script src="/js/imaegoo/moment/2.22.2/min/moment-with-locales.min.js"></script><script src="/js/imaegoo/twikoo/1.6.41/twikoo.min.js"></script><script src="/js/imaegoo/clipboard/2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/imaegoo/lightgallery/1.10.0/dist/js/lightgallery.min.js" defer></script><script src="/js/imaegoo/justifiedGallery/3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="/js/imaegoo/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><script src="/js/imaegoo/cookieconsent/3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-right",
        content: {
          message: "此网站使用 Cookie，以启用评论系统和分析功能。",
          dismiss: "知道了",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "/cookies/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><div class="searchbox-pinyin"><label class="checkbox"><input id="search-by-pinyin" type="checkbox" checked="checked"><span> 拼音检索</span></label></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/imaegoo/pinyin.js" defer></script><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/js/imaegoo/imaegoo.js"></script><script type="text/javascript" src="/js/imaegoo/universe.js"></script></body></html>